<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>17.13. Kafka Streams Integration &mdash; GeoMesa 4.0.1 Manuals</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme_custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
    <link rel="canonical" href="https://www.geomesa.org/documentation/user/kafka/streams.html"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="../../_static/tabs.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="17.14. Zookeeper-less Usage" href="zookeeper.html" />
    <link rel="prev" title="17.12. Confluent Integration" href="confluent.html" />


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> GeoMesa
          </a>
              <div class="version">
                4.1.0-SNAPSHOT
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">User Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html">2. Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../download.html">3. Versions and Downloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install.html">4. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html">5. Architecture Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geotools.html">6. GeoTools Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../datastores/index.html">7. GeoMesa Data Stores</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/index.html">8. Command-Line Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../convert/index.html">9. GeoMesa Converters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geoserver.html">10. GeoServer Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spark/index.html">11. GeoMesa Spark</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nifi/index.html">12. GeoMesa NiFi Bundle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../process.html">13. GeoMesa Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hbase/index.html">14. HBase Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../accumulo/index.html">15. Accumulo Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cassandra/index.html">16. Cassandra Data Store</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">17. Kafka Data Store</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="install.html">17.1. Installing GeoMesa Kafka</a></li>
<li class="toctree-l3"><a class="reference internal" href="usage.html">17.2. Using the Kafka Data Store Programmatically</a></li>
<li class="toctree-l3"><a class="reference internal" href="producers.html">17.3. Data Producers</a></li>
<li class="toctree-l3"><a class="reference internal" href="consumers.html">17.4. Data Consumers</a></li>
<li class="toctree-l3"><a class="reference internal" href="geoserver.html">17.5. Using the Kafka Data Store in GeoServer</a></li>
<li class="toctree-l3"><a class="reference internal" href="commandline.html">17.6. Kafka Command-Line Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="index_config.html">17.7. Kafka Index Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="data.html">17.8. Data Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="transactional_writes.html">17.9. Transactional Writes</a></li>
<li class="toctree-l3"><a class="reference internal" href="feature_events.html">17.10. Listening for Feature Events</a></li>
<li class="toctree-l3"><a class="reference internal" href="layer_views.html">17.11. Layer Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="confluent.html">17.12. Confluent Integration</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">17.13. Kafka Streams Integration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#streams-data-model">17.13.1. Streams Data Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#read-example">17.13.2. Read Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#write-example">17.13.3. Write Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#joins-and-topic-partitioning">17.13.4. Joins and Topic Partitioning</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="zookeeper.html">17.14. Zookeeper-less Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../redis/index.html">18. Redis Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../filesystem/index.html">19. FileSystem Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../postgis/index.html">20. Partitioned PostGIS Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lambda/index.html">21. Lambda Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds_views.html">22. Combined Data Store Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="../upgrade.html">23. Upgrade Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#appendix">Appendix</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GeoMesa</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">User Manual</a></li>
          <li class="breadcrumb-item"><a href="index.html"><span class="section-number">17. </span>Kafka Data Store</a></li>
      <li class="breadcrumb-item active"><span class="section-number">17.13. </span>Kafka Streams Integration</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="kafka-streams-integration">
<span id="streams-kds"></span><h1><span class="section-number">17.13. </span>Kafka Streams Integration<a class="headerlink" href="#kafka-streams-integration" title="Permalink to this headline">¶</a></h1>
<p>The Kafka Data Store can integrate with Kafka Streams applications as both a source and a destination.</p>
<p>To read from or write to a GeoMesa Kafka topic, use the <code class="docutils literal notranslate"><span class="pre">org.locationtech.geomesa.kafka.streams.GeoMesaStreamsBuilder</span></code>
class. This class wraps a regular Kafka <code class="docutils literal notranslate"><span class="pre">StreamsBuilder</span></code> with convenience methods for mapping feature types to
topics and loading serializers.</p>
<section id="streams-data-model">
<h2><span class="section-number">17.13.1. </span>Streams Data Model<a class="headerlink" href="#streams-data-model" title="Permalink to this headline">¶</a></h2>
<p>Messages are based on SimpleFeatures and modelled as a simple case class:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">GeoMesaMessage</span><span class="p">(</span><span class="n">action</span><span class="p">:</span><span class="w"> </span><span class="nc">MessageAction</span><span class="p">,</span><span class="w"> </span><span class="n">attributes</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">AnyRef</span><span class="p">],</span><span class="w"> </span><span class="n">userData</span><span class="p">:</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="p">])</span>

<span class="k">object</span><span class="w"> </span><span class="nc">MessageAction</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Enumeration</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="nc">MessageAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Value</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">Upsert</span><span class="p">,</span><span class="w"> </span><span class="nc">Delete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Value</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="read-example">
<h2><span class="section-number">17.13.2. </span>Read Example<a class="headerlink" href="#read-example" title="Permalink to this headline">¶</a></h2>
<p>The following is adapted from the word-count <a class="reference external" href="https://kafka.apache.org/31/documentation/streams/developer-guide/dsl-api.html#scala-dsl-sample-usage">example</a> in Kafka Streams:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-U2NhbGE=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-0-U2NhbGE=" name="U2NhbGE=" role="tab" tabindex="0">Scala</button><button aria-controls="panel-0-SmF2YQ==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-0-SmF2YQ==" name="SmF2YQ==" role="tab" tabindex="-1">Java</button></div><div aria-labelledby="tab-0-U2NhbGE=" class="sphinx-tabs-panel code-tab group-tab" id="panel-0-U2NhbGE=" name="U2NhbGE=" role="tabpanel" tabindex="0"><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">kafka</span><span class="p">.</span><span class="nn">streams</span><span class="p">.</span><span class="nn">scala</span><span class="p">.</span><span class="nc">ImplicitConversions</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">kafka</span><span class="p">.</span><span class="nn">streams</span><span class="p">.</span><span class="nn">scala</span><span class="p">.</span><span class="nn">serialization</span><span class="p">.</span><span class="nc">Serdes</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">locationtech</span><span class="p">.</span><span class="nn">geomesa</span><span class="p">.</span><span class="nn">kafka</span><span class="p">.</span><span class="nn">streams</span><span class="p">.</span><span class="nc">GeoMesaStreamsBuilder</span>

<span class="c1">// these are the parameters normally passed to DataStoreFinder</span>
<span class="kd">val</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="p">](</span>
<span class="w">  </span><span class="s">&quot;kafka.brokers&quot;</span><span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;localhost:9092&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;kafka.zookeepers&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;localhost:2181&quot;</span>
<span class="p">)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">GeoMesaStreamsBuilder</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="c1">// read in the feature type and turn the attributes into a space-separated string</span>
<span class="kd">val</span><span class="w"> </span><span class="n">textLines</span><span class="p">:</span><span class="w"> </span><span class="nc">KStream</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="n">builder</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="s">&quot;my-feature-type&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="n">map</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">attributes</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">toString</span><span class="p">.</span><span class="n">replaceAll</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_&quot;</span><span class="p">)).</span><span class="n">mkString</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)))</span>

<span class="kd">val</span><span class="w"> </span><span class="n">wordCounts</span><span class="p">:</span><span class="w"> </span><span class="nc">KTable</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="nc">Long</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="n">textLines</span>
<span class="w">      </span><span class="p">.</span><span class="n">flatMapValues</span><span class="p">(</span><span class="n">textLine</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">textLine</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; +&quot;</span><span class="p">))</span>
<span class="w">      </span><span class="p">.</span><span class="n">groupBy</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">word</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">word</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="n">count</span><span class="p">()(</span><span class="nc">Materialized</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;counts-store&quot;</span><span class="p">))</span>

<span class="n">wordCounts</span><span class="p">.</span><span class="n">toStream</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="s">&quot;word-count&quot;</span><span class="p">)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">topology</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">build</span><span class="p">()</span>
<span class="c1">// construct the streams app as normal</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-SmF2YQ==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-0-SmF2YQ==" name="SmF2YQ==" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.locationtech.geomesa.kafka.jstreams.GeoMesaStreamsBuilder</span><span class="p">;</span>

<span class="c1">// these are the parameters normally passed to DataStoreFinder</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">params</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;kafka.brokers&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost:9092&quot;</span><span class="p">);</span>
<span class="n">params</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;kafka.zookeepers&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost:2181&quot;</span><span class="p">);</span>

<span class="n">GeoMesaStreamsBuilder</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GeoMesaStreamsBuilder</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="c1">// read in the feature type and turn the attributes into a space-separated string</span>
<span class="n">KStream</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">textLines</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">builder</span><span class="p">.</span><span class="na">stream</span><span class="p">(</span><span class="s">&quot;my-feature-type&quot;</span><span class="p">)</span>
<span class="w">             </span><span class="p">.</span><span class="na">mapValues</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="na">asJava</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">Object</span><span class="p">::</span><span class="n">toString</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">joining</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)));</span>

<span class="n">KTable</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">wordCounts</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">textLines</span>
<span class="w">            </span><span class="p">.</span><span class="na">flatMapValues</span><span class="p">(</span><span class="n">textLine</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">textLine</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&quot; +&quot;</span><span class="p">)))</span>
<span class="w">            </span><span class="p">.</span><span class="na">groupBy</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">word</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">word</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">count</span><span class="p">(</span><span class="n">Materialized</span><span class="p">.</span><span class="na">as</span><span class="p">(</span><span class="s">&quot;counts-store&quot;</span><span class="p">));</span>

<span class="n">wordCounts</span><span class="p">.</span><span class="na">toStream</span><span class="p">().</span><span class="na">to</span><span class="p">(</span><span class="s">&quot;word-count&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Produced</span><span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="n">Serdes</span><span class="p">.</span><span class="na">String</span><span class="p">(),</span><span class="w"> </span><span class="n">Serdes</span><span class="p">.</span><span class="na">Long</span><span class="p">()));</span>

<span class="n">Topology</span><span class="w"> </span><span class="n">topology</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="c1">// construct the streams app as normal</span>
</pre></div>
</div>
</div></div>
</section>
<section id="write-example">
<h2><span class="section-number">17.13.3. </span>Write Example<a class="headerlink" href="#write-example" title="Permalink to this headline">¶</a></h2>
<p>The following shows how to persist data back to a GeoMesa topic:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-U2NhbGE=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-1-U2NhbGE=" name="U2NhbGE=" role="tab" tabindex="0">Scala</button><button aria-controls="panel-1-SmF2YQ==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-1-SmF2YQ==" name="SmF2YQ==" role="tab" tabindex="-1">Java</button></div><div aria-labelledby="tab-1-U2NhbGE=" class="sphinx-tabs-panel code-tab group-tab" id="panel-1-U2NhbGE=" name="U2NhbGE=" role="tabpanel" tabindex="0"><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">kafka</span><span class="p">.</span><span class="nn">streams</span><span class="p">.</span><span class="nn">scala</span><span class="p">.</span><span class="nc">ImplicitConversions</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">kafka</span><span class="p">.</span><span class="nn">streams</span><span class="p">.</span><span class="nn">scala</span><span class="p">.</span><span class="nn">serialization</span><span class="p">.</span><span class="nc">Serdes</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">locationtech</span><span class="p">.</span><span class="nn">geomesa</span><span class="p">.</span><span class="nn">kafka</span><span class="p">.</span><span class="nn">streams</span><span class="p">.</span><span class="nc">GeoMesaMessage</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">locationtech</span><span class="p">.</span><span class="nn">geomesa</span><span class="p">.</span><span class="nn">kafka</span><span class="p">.</span><span class="nn">streams</span><span class="p">.</span><span class="nc">GeoMesaStreamsBuilder</span>

<span class="c1">// these are the parameters normally passed to DataStoreFinder</span>
<span class="kd">val</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="p">](</span>
<span class="w">  </span><span class="s">&quot;kafka.brokers&quot;</span><span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;localhost:9092&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;kafka.zookeepers&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;localhost:2181&quot;</span>
<span class="p">)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">GeoMesaStreamsBuilder</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="c1">// use the wrapped native streams builder to create an input based on csv records</span>
<span class="kd">val</span><span class="w"> </span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="nc">KStream</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="n">builder</span><span class="p">.</span><span class="n">wrapped</span><span class="p">.</span><span class="n">stream</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="p">](</span><span class="s">&quot;input-csv-topic&quot;</span><span class="p">)</span>

<span class="c1">// the columns in the csv need to map to the attributes in the feature type</span>
<span class="kd">val</span><span class="w"> </span><span class="n">output</span><span class="p">:</span><span class="w"> </span><span class="nc">KStream</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="nc">GeoMesaMessage</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="n">input</span><span class="p">.</span><span class="n">mapValues</span><span class="p">(</span><span class="n">lines</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">GeoMesaMessage</span><span class="p">.</span><span class="n">upsert</span><span class="p">(</span><span class="n">lines</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)))</span>

<span class="c1">// write the output to GeoMesa - the feature type must already exist</span>
<span class="n">builder</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="s">&quot;my-feature-type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">topology</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">build</span><span class="p">()</span>
<span class="c1">// construct the streams app as normal</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-SmF2YQ==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-1-SmF2YQ==" name="SmF2YQ==" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.locationtech.geomesa.kafka.jstreams.GeoMesaStreamsBuilder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.locationtech.geomesa.kafka.streams.GeoMesaMessage</span><span class="p">;</span>

<span class="c1">// these are the parameters normally passed to DataStoreFinder</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">params</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;kafka.brokers&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost:9092&quot;</span><span class="p">);</span>
<span class="n">params</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;kafka.zookeepers&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost:2181&quot;</span><span class="p">);</span>

<span class="n">GeoMesaStreamsBuilder</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GeoMesaStreamsBuilder</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="c1">// use the wrapped native streams builder to create an input based on csv records</span>
<span class="n">KStream</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="na">wrapped</span><span class="p">().</span><span class="na">stream</span><span class="p">(</span><span class="s">&quot;input-topic&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">Consumed</span><span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="n">Serdes</span><span class="p">.</span><span class="na">String</span><span class="p">(),</span><span class="w"> </span><span class="n">Serdes</span><span class="p">.</span><span class="na">String</span><span class="p">()).</span><span class="na">withTimestampExtractor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WallclockTimestampExtractor</span><span class="p">()));</span>
<span class="c1">// the columns in the csv need to map to the attributes in the feature type</span>
<span class="n">KStream</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">GeoMesaMessage</span><span class="o">&gt;</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">input</span><span class="p">.</span><span class="na">mapValues</span><span class="p">(</span><span class="n">lines</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">GeoMesaMessage</span><span class="p">.</span><span class="na">upsert</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">lines</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">))));</span>

<span class="c1">// write the output to GeoMesa - the feature type must already exist</span>
<span class="n">builder</span><span class="p">.</span><span class="na">to</span><span class="p">(</span><span class="n">sft</span><span class="p">.</span><span class="na">getTypeName</span><span class="p">(),</span><span class="w"> </span><span class="n">output</span><span class="p">);</span>

<span class="n">Topology</span><span class="w"> </span><span class="n">topology</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="c1">// construct the streams app as normal</span>
</pre></div>
</div>
</div></div>
</section>
<section id="joins-and-topic-partitioning">
<h2><span class="section-number">17.13.4. </span>Joins and Topic Partitioning<a class="headerlink" href="#joins-and-topic-partitioning" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Kafka streams operations that require co-partitioning will usually require a re-partition step when used
with data from GeoMesa 3.4.x or earlier.</p>
</div>
<p>For feature types created prior to version 3.5.0, GeoMesa will use a custom partitioner for data
written to Kafka. When using Kafka Streams operations that require co-partitioning, such as joins, the
GeoMesa topic will need to be re-partitioned.</p>
<p>Existing feature types can be updated to use the default Kafka partitioner, which will allow for joins without
re-partitioning. However, note that updates for a given feature may go to the wrong partition, which may result
in older data being returned when GeoMesa is queried. This will generally resolve itself over time as Kafka log
retention policies delete the older data (unless Kafka log compaction is enabled for the topic).</p>
<p>To update an existing feature type, add the user data entry <code class="docutils literal notranslate"><span class="pre">geomesa.kafka.partitioning=default</span></code>. Through the
GeoMesa command-line tools, the following command will disable custom partitioning:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>geomesa-kafka<span class="w"> </span>update-schema<span class="w"> </span>--add-user-data<span class="w"> </span><span class="s2">&quot;geomesa.kafka.partitioning:default&quot;</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="confluent.html" class="btn btn-neutral float-left" title="17.12. Confluent Integration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="zookeeper.html" class="btn btn-neutral float-right" title="17.14. Zookeeper-less Usage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  

<div role="contentinfo">
  <p>
    &copy; Copyright 2013-2023 <a href="https://www.ccri.com/">Commonwealth Computer Research, Inc.</a>
    <br/>
    Licensed under the <a href="https://www.opensource.org/licenses/apache2.0.php">Apache License, Version 2.0</a>
  </p>
</div>

<div role="contentinfo">
  <p>
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
    using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>
    - contribute to this page on
    <a href="https://github.com/locationtech/geomesa/edit/main/docs/user/kafka/streams.rst">GitHub <img src="../../_static/launch.svg"/></a>
  </p>

</div>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>