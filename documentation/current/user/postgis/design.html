

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>22.1. Design Overview &mdash; GeoMesa 3.4.0 Manuals</title>
  

  
  
  
  
    <link rel="canonical" href="https://www.geomesa.org/documentation/user/postgis/design.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme_custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="22.2. Installing Partitioned PostGIS" href="install.html" />
    <link rel="prev" title="22. Partitioned PostGIS Data Store" href="index.html" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53087457-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53087457-1');
</script>



  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> GeoMesa
          

          
          </a>

          
            
            
              <div class="version">
                3.5.0-SNAPSHOT
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">User Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../download.html">2. Versions and Downloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install.html">3. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html">4. Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geotools.html">5. GeoTools Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html">6. Architecture Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../datastores/index.html">7. GeoMesa Data Stores</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/index.html">8. Command-Line Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../convert/index.html">9. GeoMesa Convert</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geoserver.html">10. GeoServer Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spark/index.html">11. GeoMesa Spark</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nifi/index.html">12. GeoMesa NiFi Bundle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../process.html">13. GeoMesa Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hbase/index.html">14. HBase Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../accumulo/index.html">15. Accumulo Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cassandra/index.html">16. Cassandra Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bigtable/index.html">17. Bigtable Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kafka/index.html">18. Kafka Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../redis/index.html">19. Redis Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../filesystem/index.html">20. FileSystem Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kudu/index.html">21. Kudu Data Store</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">22. Partitioned PostGIS Data Store</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">22.1. Design Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#motivation">22.1.1. Motivation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#overview">22.1.2. Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#table-design">22.1.3. Table Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="#helper-tables">22.1.4. Helper Tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#maintenance-scripts">22.1.5. Maintenance Scripts</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="install.html">22.2. Installing Partitioned PostGIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="usage.html">22.3. Using the Partitioned PostGIS Data Store Programmatically</a></li>
<li class="toctree-l3"><a class="reference internal" href="geoserver.html">22.4. Using the Partitioned PostGIS Data Store in GeoServer</a></li>
<li class="toctree-l3"><a class="reference internal" href="commandline.html">22.5. Partitioned PostGIS Command-Line Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="index_config.html">22.6. Partitioned PostGIS Index Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../lambda/index.html">23. Lambda Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds_views.html">24. Combined Data Store Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geojson.html">25. GeoMesa GeoJSON</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stream.html">26. GeoMesa Stream Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../upgrade.html">27. Upgrade Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#appendix">Appendix</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GeoMesa</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">User Manual</a> &raquo;</li>
        
          <li><a href="index.html">22. Partitioned PostGIS Data Store</a> &raquo;</li>
        
      <li>22.1. Design Overview</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="design-overview">
<h1>22.1. Design Overview<a class="headerlink" href="#design-overview" title="Permalink to this headline">¶</a></h1>
<div class="section" id="motivation">
<h2>22.1.1. Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h2>
<p>PostGIS is a widely used spatial database that is easily deployed, however it is limited in the total number of
records it can handle in a single table. This module makes it possible to store much larger data sets using
PostgreSQL’s native partitioning, by automatically sorting data into time-based partitions.</p>
</div>
<div class="section" id="overview">
<h2>22.1.2. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The PostGIS partitioning module is an extension of the GeoTools
<a class="reference external" href="https://docs.geotools.org/stable/userguide/library/jdbc/datastore.html">JDBC data store</a>, implemented
as a custom dialect. It is designed for sensor data, where each record has a timestamp and records are
mostly ingested soon after they are generated.</p>
<p>As data is written, it gets sorted into partitions based on record timestamps. Recent data gets sorted
into smaller partitions, then into larger partitions once it has reached a certain age. The partitions are
sorted spatio-temporally, to reduce page reads during typical queries. Since the data is sorted, it can be
effectively indexed using a spatial <code class="docutils literal notranslate"><span class="pre">BRIN</span></code> index, which is much smaller than a standard <code class="docutils literal notranslate"><span class="pre">GIST</span></code> index. During
queries, PostgreSQL will automatically skip over partitions that don’t match the query, using standard partition
pruning. This allows massive data sets to be efficiently queried with temporal predicates, although non-temporal
queries may not perform well.</p>
</div>
<div class="section" id="table-design">
<span id="pg-partition-table-design"></span><h2>22.1.3. Table Design<a class="headerlink" href="#table-design" title="Permalink to this headline">¶</a></h2>
<p>The data is split into one primary view and three tables, names of which are prefixed by the feature type:</p>
<blockquote>
<div><ul class="simple">
<li>main view (named after the feature type) - a <code class="docutils literal notranslate"><span class="pre">UNION</span> <span class="pre">ALL</span></code> of the other tables, this is the view
that should generally be used for all external reads and writes.</li>
<li><code class="docutils literal notranslate"><span class="pre">_wa</span></code> - the write-ahead table. All writes to the main view are delegated to this table using a trigger.
The table is partitioned using table inheritance (as there may be overlap between the partitions), and
is rolled over every 10 minutes. Only the most recent partition is ever written to.</li>
<li><code class="docutils literal notranslate"><span class="pre">_wa_partition</span></code> - recent data, partitioned into 10 minute increments using declarative partitioning.
The most recent data is stored in this table in spatially-sorted order, copied out of the
write ahead table when it is rolled over (after which the write ahead table partition is dropped). This table
is designed to handle time-latent data, and to store enough data to fill an entire main partition,
while still providing partition pruning for queries.</li>
<li><code class="docutils literal notranslate"><span class="pre">_partition</span></code> - the main data, partitioned using declarative time partitioning. Data is copied into this table
from the <code class="docutils literal notranslate"><span class="pre">_wa_partition</span></code> table in spatially-sorted order, once enough time has elapsed (after which the
<code class="docutils literal notranslate"><span class="pre">_wa_partition</span></code> partitions are dropped). It uses a BRIN index, which is small but performs well on sorted data.
Keeping the data sorted also reduces the number of page hits required for most spatial queries.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="helper-tables">
<h2>22.1.4. Helper Tables<a class="headerlink" href="#helper-tables" title="Permalink to this headline">¶</a></h2>
<p>In addition to the ones above, the following additional tables are used:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">_analyze_queue</span></code> - tracks partitions which have been modified. Modified partitions will have <code class="docutils literal notranslate"><span class="pre">ANALYZE</span></code>
invoked on them in a separate process.</li>
<li><code class="docutils literal notranslate"><span class="pre">_sort_queue</span></code> - tracks out-of-order inserts into the main partition table. This can be used to diagnose
slow queries, as unsorted data can negatively impact the effectiveness of the <code class="docutils literal notranslate"><span class="pre">BRIN</span></code> index.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="maintenance-scripts">
<h2>22.1.5. Maintenance Scripts<a class="headerlink" href="#maintenance-scripts" title="Permalink to this headline">¶</a></h2>
<p>Several PLPG/SQL procedures are used to move data around according to the design described above. The <code class="docutils literal notranslate"><span class="pre">pg_cron</span></code>
extension is used to schedule these tasks. The script names are prefixed by the feature type, and created based
on the feature type configuration (i.e. field names, partition size, etc). The procedures consist of:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">_roll_wa</span></code> - creates a new write-ahead table every 10 minutes</li>
<li><code class="docutils literal notranslate"><span class="pre">_partition_maintenance</span></code> umbrella function for invoking all the partition scripts at once</li>
<li><code class="docutils literal notranslate"><span class="pre">_partition_wa</span></code> - moves data from old write ahead tables into the <code class="docutils literal notranslate"><span class="pre">_wa_partition</span></code> table</li>
<li><code class="docutils literal notranslate"><span class="pre">_merge_wa_partitions</span></code> - moves data from the <code class="docutils literal notranslate"><span class="pre">_wa_partition</span></code> table into the main <code class="docutils literal notranslate"><span class="pre">_partition</span></code> table</li>
<li><code class="docutils literal notranslate"><span class="pre">_age_off</span></code> (if configured) - drops any partitions that have exceeded the maximum amount of data to keep</li>
<li><code class="docutils literal notranslate"><span class="pre">_analyze_partitions</span></code> - runs <code class="docutils literal notranslate"><span class="pre">ANALYZE</span></code> on any partitions that have been updated</li>
<li><code class="docutils literal notranslate"><span class="pre">_partition_sort</span></code> - manually called to re-sort a partition</li>
</ul>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="install.html" class="btn btn-neutral float-right" title="22.2. Installing Partitioned PostGIS" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="22. Partitioned PostGIS Data Store" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>

<div role="contentinfo">
  <p>
    &copy; Copyright 2013-2021 <a href="https://www.ccri.com/">Commonwealth Computer Research, Inc.</a>
    <br/>
    Licensed under the <a href="http://www.opensource.org/licenses/apache2.0.php">Apache License, Version 2.0</a>
  </p>
</div>

<div role="contentinfo">
  <p>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a>
    using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>
    
    - view <a href="../../_sources/user/postgis/design.rst.txt" rel="nofollow">page source</a>
    
  </p>
</div>



</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../../_static/copybutton.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>