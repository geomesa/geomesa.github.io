

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>17.5. GeoMesa Spark SQL on Google Cloud Dataproc &mdash; GeoMesa 3.2.0 Manuals</title>
  

  
  
  
  
    <link rel="canonical" href="https://www.geomesa.org/documentation/user/bigtable/dataproc.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme_custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="18. Kafka Data Store" href="../kafka/index.html" />
    <link rel="prev" title="17.4. Bigtable Command-Line Tools" href="commandline.html" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53087457-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53087457-1');
</script>



  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> GeoMesa
          

          
          </a>

          
            
            
              <div class="version">
                3.3.0-SNAPSHOT
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">User Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../download.html">2. Versions and Downloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install.html">3. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html">4. Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geotools.html">5. GeoTools Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html">6. Architecture Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../datastores/index.html">7. GeoMesa Data Stores</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/index.html">8. Command-Line Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../convert/index.html">9. GeoMesa Convert</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geoserver.html">10. GeoServer Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spark/index.html">11. GeoMesa Spark</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nifi/index.html">12. GeoMesa NiFi Bundle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../process.html">13. GeoMesa Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hbase/index.html">14. HBase Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../accumulo/index.html">15. Accumulo Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cassandra/index.html">16. Cassandra Data Store</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">17. Bigtable Data Store</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="install.html">17.1. Installing GeoMesa Bigtable</a></li>
<li class="toctree-l3"><a class="reference internal" href="usage.html">17.2. Using the Bigtable Data Store Programmatically</a></li>
<li class="toctree-l3"><a class="reference internal" href="geoserver.html">17.3. Using the Bigtable Data Store in GeoServer</a></li>
<li class="toctree-l3"><a class="reference internal" href="commandline.html">17.4. Bigtable Command-Line Tools</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">17.5. GeoMesa Spark SQL on Google Cloud Dataproc</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../kafka/index.html">18. Kafka Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../redis/index.html">19. Redis Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../filesystem/index.html">20. FileSystem Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kudu/index.html">21. Kudu Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lambda/index.html">22. Lambda Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds_views.html">23. Combined Data Store Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geojson.html">24. GeoMesa GeoJSON</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stream.html">25. GeoMesa Stream Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../upgrade.html">26. Upgrade Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#appendix">Appendix</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GeoMesa</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">User Manual</a> &raquo;</li>
        
          <li><a href="index.html">17. Bigtable Data Store</a> &raquo;</li>
        
      <li>17.5. GeoMesa Spark SQL on Google Cloud Dataproc</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="geomesa-spark-sql-on-google-cloud-dataproc">
<h1>17.5. GeoMesa Spark SQL on Google Cloud Dataproc<a class="headerlink" href="#geomesa-spark-sql-on-google-cloud-dataproc" title="Permalink to this headline">Â¶</a></h1>
<p>GeoMesa can run Spark SQL with Bigtable as the underlying datastore.  In order to set up Spark SQL,
you will need to launch a Google Cloud Dataproc cluster.  First, you will need to install the Google
Cloud SDK command line tools.  Instructions for doing so can be found <a class="reference external" href="https://cloud.google.com/sdk/downloads">here</a>.
Ensure that you have installed all the appropriate components for working with GCP Bigtable and GCP
Dataproc.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the following examples, replace <code class="docutils literal notranslate"><span class="pre">${TAG}</span></code> with the corresponding GeoMesa version (e.g. <code class="docutils literal notranslate"><span class="pre">3.2.0</span></code>), and
<code class="docutils literal notranslate"><span class="pre">${VERSION}</span></code> with the appropriate Scala plus GeoMesa versions (e.g. <code class="docutils literal notranslate"><span class="pre">2.12-3.2.0</span></code>).</p>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gcloud components install cbt
$ gcloud components install alpha
$ gcloud components install beta
</pre></div>
</div>
<p>Then, provision a new Bigtable instance.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gcloud beta bigtable instances create geomesa --cluster geomesa --cluster-zone us-east1-b --cluster-num-nodes <span class="m">3</span> --description GeoMesa
</pre></div>
</div>
<p>And provision a GCP Dataproc cluster.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gcloud dataproc clusters create geomesa
</pre></div>
</div>
<p>Once you have a GCP Dataproc cluster up and running, you can scp the GeoMesa Bigtable distribution to the master node.  You can
determine the name of the master node by using the following command line.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gcloud compute instances list
</pre></div>
</div>
<p>Find the master node instance and log into it using gcloud ssh as follows:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gcloud compute --project <span class="nv">$PROJECTID</span> ssh --zone <span class="nv">$ZONEID</span> <span class="nv">$MASTER</span>
</pre></div>
</div>
<p>Now, configure the installation by downloading and unpacking the GeoMesa distribution, editing the hbase-site.xml
appropriately, and including the hbase-site.xml in the spark runtime jar:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ wget <span class="s2">&quot;https://github.com/locationtech/geomesa/releases/download/geomesa-</span><span class="si">${</span><span class="nv">TAG</span><span class="si">}</span><span class="s2">/geomesa-bigtable_</span><span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span><span class="s2">-bin.tar.gz&quot;</span>
$ tar zxvf geomesa-bigtable_<span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span>-bin.tar.gz
$ ln -s geomesa-bigtable_<span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span> geomesa
$ <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:~/geomesa/bin
$ <span class="nb">export</span> <span class="nv">HADOOP_HOME</span><span class="o">=</span>/usr/lib/hadoop
$ <span class="nb">export</span> <span class="nv">HBASE_HOME</span><span class="o">=</span>/usr/lib/hbase
$ vi geomesa/conf/hbase-site.xml
$ cp geomesa/conf/hbase-site.xml geomesa/dist/spark/
$ <span class="nb">cd</span> geomesa/dist/spark/
$ jar uvf geomesa-bigtable-spark-runtime_<span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span> hbase-site.xml
</pre></div>
</div>
<p>Download sample GDELT data and ingest it as follows.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ geomesa-bigtable ingest -t <span class="m">8</span> -c geomesa.gdelt -s gdelt -C gdelt <span class="se">\*</span>.csv
</pre></div>
</div>
<p>Now, you can run a spark shell and execute Spark SQL over your GeoMesa on Bigtable instance.  Set the version to your installed version of GeoMesa.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ spark-shell --num-executors <span class="m">4</span> --master yarn --jars file://<span class="nv">$HOME</span>/geomesa/dist/spark/geomesa-bigtable-spark-runtime_<span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span>.jar,file://<span class="nv">$HOME</span>/geomesa/lib/bigtable-hbase-1.2-0.9.4.jar,file://<span class="nv">$HOME</span>/geomesa/lib/netty-tcnative-boringssl-static-1.1.33.Fork19.jar
</pre></div>
</div>
<p>From the Spark shell prompt.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>scala&gt; val <span class="nv">df</span> <span class="o">=</span> spark.read.format<span class="o">(</span><span class="s2">&quot;geomesa&quot;</span><span class="o">)</span>.option<span class="o">(</span><span class="s2">&quot;bigtable.catalog&quot;</span>, <span class="s2">&quot;geomesa.gdelt&quot;</span><span class="o">)</span>.option<span class="o">(</span><span class="s2">&quot;geomesa.feature&quot;</span>, <span class="s2">&quot;gdelt&quot;</span><span class="o">)</span>.load<span class="o">()</span>
scala&gt; df.createOrReplaceTempView<span class="o">(</span><span class="s2">&quot;gdelt&quot;</span><span class="o">)</span>
scala&gt; spark.sql<span class="o">(</span><span class="s2">&quot;SELECT actor1Name,actor2Name,geom,dtg FROM gdelt WHERE st_contains(st_geomFromWKT(&#39;POLYGON((-80 35,-70 35,-70 40,-80 40,-80 35))&#39;),geom)&quot;</span><span class="o">)</span>.show<span class="o">()</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../kafka/index.html" class="btn btn-neutral float-right" title="18. Kafka Data Store" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="commandline.html" class="btn btn-neutral" title="17.4. Bigtable Command-Line Tools" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>

<div role="contentinfo">
  <p>
    &copy; Copyright 2013-2021 <a href="https://www.ccri.com/">Commonwealth Computer Research, Inc.</a>
    <br/>
    Licensed under the <a href="http://www.opensource.org/licenses/apache2.0.php">Apache License, Version 2.0</a>
  </p>
</div>

<div role="contentinfo">
  <p>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a>
    using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>
    
    - view <a href="../../_sources/user/bigtable/dataproc.rst.txt" rel="nofollow">page source</a>
    
  </p>
</div>



</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>