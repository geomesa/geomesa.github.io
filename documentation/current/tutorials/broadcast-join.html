<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeoMesa Spark: Broadcast Join and Aggregation &mdash; GeoMesa 3.5.0 Manuals</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme_custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
    <link rel="canonical" href="https://www.geomesa.org/documentation/tutorials/broadcast-join.html"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="GeoMesa Spark: Spatial Join and Aggregation" href="dwithin-join.html" />
    <link rel="prev" title="GeoMesa Spark: Basic Analysis" href="spark.html" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53087457-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53087457-1');
</script>


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> GeoMesa
          </a>
              <div class="version">
                4.0.0-SNAPSHOT
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">User Manual</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#quick-starts">Quick Starts</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#data-in-out">Data In/Out</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#data-analysis">Data Analysis</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="spark.html">GeoMesa Spark: Basic Analysis</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">GeoMesa Spark: Broadcast Join and Aggregation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#background">Background</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initializing-spark">Initializing Spark</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-dataframes">Creating DataFrames</a></li>
<li class="toctree-l4"><a class="reference internal" href="#filtering-dataframes-optional">Filtering DataFrames (Optional)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#broadcast-join">Broadcast Join</a></li>
<li class="toctree-l4"><a class="reference internal" href="#aggregating">Aggregating</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visualization">Visualization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="dwithin-join.html">GeoMesa Spark: Spatial Join and Aggregation</a></li>
<li class="toctree-l3"><a class="reference internal" href="geomesa-tubeselect.html">Web Processing Services (WPS) Tube Select</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#security">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#indexing-and-queries">Indexing and Queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#about-tutorial-versions">About Tutorial Versions</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GeoMesa</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">GeoMesa Spark: Broadcast Join and Aggregation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="geomesa-spark-broadcast-join-and-aggregation">
<h1>GeoMesa Spark: Broadcast Join and Aggregation<a class="headerlink" href="#geomesa-spark-broadcast-join-and-aggregation" title="Permalink to this headline">¶</a></h1>
<p>This tutorial will show you how to:</p>
<ol class="arabic simple">
<li><p>Use GeoMesa with <a class="reference external" href="http://spark.apache.org/">Apache Spark</a> in Scala.</p></li>
<li><p>Create and use DataFrames with our geospatial User Defined Functions.</p></li>
<li><p>Calculate aggregate statistics using a covering set of polygons.</p></li>
<li><p>Create a new simple feature type to represent this aggregation.</p></li>
<li><p>Visualize the result as a choropleth map.</p></li>
</ol>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://gdeltproject.org/">GDELT</a> provides a comprehensive time- and location-indexed archive of events reported
in broadcast, print, and web news media worldwide from 1979 to today.</p>
<p><a class="reference external" href="https://www.census.gov/geo/maps-data/data/cbf/cbf_counties.html">FIPS Codes</a> are
Federal Information Processing Standard Publication codes that uniquely identify counties in the United States.</p>
<p>If we make the assumption that a county with more GDELT events is somehow more politically relevant, we may be interested
in seeing which counties are more dense with GDELT events.</p>
<p>Since GDELT is a data set with point geometries, we do not immediately know which county it belongs to. To resolve this,
we will use a second data set, a FIPS Codes shapefile that denotes the boundary and FIPS code of a county, and join GDELT
points with the county that contains them.</p>
<p>In this case, the number of counties is particularly small, approximately 3000 records, we can make our query much
more efficient by “broadcasting” the counties. “Broadcast” here meaning a
<a class="reference external" href="https://spark.apache.org/docs/2.2.0/api/java/org/apache/spark/sql/functions.html#broadcast-org.apache.spark.sql.Dataset-">Spark Broadcast</a>.
In a traditional Spark SQL join, data will be shuffled around the executors based on the partitioners of the RDDs,
and since in our case the join key is a geometric field, there is no built-in Spark partitioner that can map data effectively.
The resulting movement of data across nodes is expensive, so we can attain a performance boost by sending (broadcasting)
our entire small data set to each of the nodes once. This ensures that the executors have all the data needed to compute
the join, and no additional shuffling is needed.</p>
<p>Spark provides a means of executing this “broadcast join”, though it should only be used when the data being broadcast
is small enough to fit in the memory of the executors.</p>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>For this tutorial, we will assume that your have already ingested the two data sets into the data store of your choosing.
Following this tutorial without having created the necessary tables will lead to errors.</p>
<p>The converter for the GDELT data set, <a class="reference internal" href="../user/convert/premade/gdelt.html"><span class="doc">Global Database of Events, Language, and Tone (GDELT)</span></a>, is provided with GeoMesa, and the FIPS data can
be ingested without a converter as a shapefile. For further guidance, you can follow one of the ingest tutorials
<a class="reference internal" href="geomesa-examples-gdelt.html"><span class="doc">Map-Reduce Ingest of GDELT</span></a>.
Once you have the data ingested in GeoMesa, you may proceed with the rest of the tutorial.</p>
</section>
<section id="initializing-spark">
<h2>Initializing Spark<a class="headerlink" href="#initializing-spark" title="Permalink to this headline">¶</a></h2>
<p>To start working with Spark, we will need a Spark Session initialized, and to apply GeoMesa’s geospatial User Defined
Types (UDTs) and User Defined Functions (UDFs) to our data in Spark, we will need to initialize our SparkSQL extensions.
This functionality requires having the appropriate GeoMesa Spark runtime jar on the classpath when running your Spark job.
GeoMesa provides Spark runtime jars for Accumulo, HBase, and FileSystem data stores. For example, the following would start an
interactive Spark REPL with all dependencies needed for running Spark with GeoMesa on an Accumulo data store. Replace
<code class="docutils literal notranslate"><span class="pre">${VERSION}</span></code> with the appropriate Scala plus GeoMesa versions (e.g. <code class="docutils literal notranslate"><span class="pre">2.12-3.5.0</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>bin/spark-shell<span class="w"> </span>--jars<span class="w"> </span>geomesa-accumulo-spark-runtime-accumulo2_<span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span>.jar
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See <a class="reference internal" href="../user/spark/providers.html#spatial-rdd-providers"><span class="std std-ref">Spatial RDD Providers</span></a> for details on choosing the correct GeoMesa Spark runtime JAR.</p>
</div>
<p>To configure the Spark Session such that we can serialize Simple Features and work with geometric UDTs and UDFs, we must
alter the Spark Session as follows.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">sql</span><span class="p">.</span><span class="nc">SparkSession</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">locationtech</span><span class="p">.</span><span class="nn">geomesa</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nc">GeoMesaSparkKryoRegistrator</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">locationtech</span><span class="p">.</span><span class="nn">geomesa</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">jts</span><span class="p">.</span><span class="n">_</span>

<span class="kd">val</span><span class="w"> </span><span class="n">spark</span><span class="p">:</span><span class="w"> </span><span class="nc">SparkSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">appName</span><span class="p">(</span><span class="s">&quot;testSpark&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="s">&quot;spark.serializer&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;org.apache.spark.serializer.KryoSerializer&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="s">&quot;spark.kryo.registrator&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">classOf</span><span class="p">[</span><span class="nc">GeoMesaSparkKryoRegistrator</span><span class="p">].</span><span class="n">getName</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">master</span><span class="p">(</span><span class="s">&quot;local[*]&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">withJTS</span>
</pre></div>
</div>
<p>Note the <code class="docutils literal notranslate"><span class="pre">withJTS</span></code>, which registers GeoMesa’s UDTs and UDFs, and the two <code class="docutils literal notranslate"><span class="pre">config</span></code> options which tell Spark to
use GeoMesa’s custom Kryo serializer and registrator to handle serialization of Simple Features. These configuration options can
also be set in the <code class="docutils literal notranslate"><span class="pre">conf/spark-defaults.conf</span></code> configuration file.</p>
</section>
<section id="creating-dataframes">
<h2>Creating DataFrames<a class="headerlink" href="#creating-dataframes" title="Permalink to this headline">¶</a></h2>
<p>With our Spark Session created and configured, we can move on to loading our data from the data store into a Spark DataFrame.</p>
<p>First we’ll set up the parameters for connecting to the data store. For example, if our data is in two Accumulo
catalogs, we would set up the following parameter maps:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">fipsParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;accumulo.instance.id&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;instance&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;accumulo.zookeepers&quot;</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;zoo1:2181,zoo2:2181,zoo3:2181&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;accumulo.user&quot;</span><span class="w">        </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;accumulo.password&quot;</span><span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;password&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;accumulo.catalog&quot;</span><span class="w">     </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;fips&quot;</span><span class="p">)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">gdeltParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;accumulo.instance.id&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;instance&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;accumulo.zookeepers&quot;</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;zoo1:2181,zoo2:2181,zoo3:2181&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;accumulo.user&quot;</span><span class="w">        </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;accumulo.password&quot;</span><span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;password&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;accumulo.catalog&quot;</span><span class="w">     </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;gdelt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The above parameters assume Accumulo as the backing data store, but the rest of the tutorial is independent of which
data store is used. Other supported data stores may be used by simply adapting the above parameters appropriately.</p>
</div>
<p>Then we make use of Spark’s <code class="docutils literal notranslate"><span class="pre">DataFrameReader</span></code> and our <code class="docutils literal notranslate"><span class="pre">SpatialRDDProvider</span></code> to create a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> with geospatial
types.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">fipsDF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;geomesa&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">options</span><span class="p">(</span><span class="n">fipsParams</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">&quot;geomesa.feature&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fips&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">load</span><span class="p">()</span>

<span class="kd">val</span><span class="w"> </span><span class="n">gdeltDF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;geomesa&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">options</span><span class="p">(</span><span class="n">gdeltParams</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">&quot;geomesa.feature&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;gdelt&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="filtering-dataframes-optional">
<h2>Filtering DataFrames (Optional)<a class="headerlink" href="#filtering-dataframes-optional" title="Permalink to this headline">¶</a></h2>
<p>Depending on the scale of the data in our data store, and how specific our questions are, we may want to narrow the result
before joining. For example, if we only wanted GDELT events within a one-week span, we could filter the DataFrame as
follows:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spark</span><span class="p">.</span><span class="nn">implicits</span><span class="p">.</span><span class="n">_</span>
<span class="kd">val</span><span class="w"> </span><span class="n">filteredGdelt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gdeltDF</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="s">&quot;dtg between &#39;2018-01-01 12:00:00&#39; and &#39;2018-01-08 12:00:00&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="broadcast-join">
<h2>Broadcast Join<a class="headerlink" href="#broadcast-join" title="Permalink to this headline">¶</a></h2>
<p>Now we’re ready to join the two data sets. This is where we will make use of our geospatial UDFs. <code class="docutils literal notranslate"><span class="pre">st_contains</span></code> takes
two geometries as input, and it outputs whether the second geometry lies within the first one. For more documentation
and a full list of the UDFs provided by GeoMesa see <a class="reference internal" href="../user/spark/sparksql_functions.html"><span class="doc">SparkSQL Functions</span></a>.</p>
<p>Using these two UDFs, we can build the following join query.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">sql</span><span class="p">.</span><span class="nn">functions</span><span class="p">.</span><span class="n">broadcast</span>
<span class="kd">val</span><span class="w"> </span><span class="n">joinedDF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gdeltDF</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">broadcast</span><span class="p">(</span><span class="n">fipsDF</span><span class="p">),</span><span class="w"> </span><span class="n">st_contains</span><span class="p">(</span><span class="n">$</span><span class="s">&quot;the_geom&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">$</span><span class="s">&quot;geom&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>The above query executes the broadcast as described previously, sending the FIPS data to each of the executors, then
joining the two data sets based on whether the GDELT event occurred in the county.</p>
</section>
<section id="aggregating">
<h2>Aggregating<a class="headerlink" href="#aggregating" title="Permalink to this headline">¶</a></h2>
<p>Now we have a DataFrame where each GDELT event is paired with the US county where it occurred.
To turn this into meaningful statistics about the distribution of GDELT events in the US, we
can do a <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> operation and use some of SparkSQL’s aggregate functions.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">sql</span><span class="p">.</span><span class="nn">functions</span><span class="p">.</span><span class="n">concat</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">sql</span><span class="p">.</span><span class="nn">functions</span><span class="p">.</span><span class="n">count</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">sql</span><span class="p">.</span><span class="nn">functions</span><span class="p">.</span><span class="n">first</span>
<span class="kd">val</span><span class="w"> </span><span class="n">aggregateDF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joinedDF</span><span class="p">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="n">$</span><span class="s">&quot;STATEFP&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">$</span><span class="s">&quot;COUNTYFP&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">.</span><span class="n">agg</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="s">&quot;NAME&quot;</span><span class="p">).</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">),</span>
<span class="w">       </span><span class="n">count</span><span class="p">(</span><span class="n">$</span><span class="s">&quot;globalEventId&quot;</span><span class="p">).</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;eventCount&quot;</span><span class="p">),</span>
<span class="w">       </span><span class="n">first</span><span class="p">(</span><span class="s">&quot;the_geom&quot;</span><span class="p">).</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;geom&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>The above query groups the data based on FIPS code, (which is split into a state and county code),
and counts the number of distinct GDELT events in each one. The result can be used to generate a visualization
of the event density in each county, which we will see in the next section.</p>
</section>
<section id="visualization">
<h2>Visualization<a class="headerlink" href="#visualization" title="Permalink to this headline">¶</a></h2>
<p>To visualize this result, we first need to map our data into the <a class="reference external" href="http://geojson.org/">GeoJSON</a> format. To do this,
we make use of GeoMesa’s DataFrame to GeoJSON converter.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">locationtech</span><span class="p">.</span><span class="nn">geomesa</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">sql</span><span class="p">.</span><span class="nc">GeoJSONExtensions</span><span class="p">.</span><span class="n">_</span>
<span class="kd">val</span><span class="w"> </span><span class="n">geojsonDF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aggregateDF</span><span class="p">.</span><span class="n">toGeoJSON</span>
</pre></div>
</div>
<p>If the result can fit in memory, it can then be collected on the driver and written to a file. If not, each executor can
write to a distributed file system like HDFS.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">geoJsonString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">geojsonDF</span><span class="p">.</span><span class="n">collect</span><span class="p">.</span><span class="n">mkString</span><span class="p">(</span><span class="s">&quot;[&quot;</span><span class="p">,</span><span class="s">&quot;,&quot;</span><span class="p">,</span><span class="s">&quot;]&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Once we have our data exported as GeoJSON, we can create a <a class="reference external" href="http://leafletjs.com/">Leaflet</a> map, which is an interactive
map in JavaScript that can be embedded into a web page.</p>
<p>Loading and parsing the JSON is simple. In this case we are wrapping the file load in an <code class="docutils literal notranslate"><span class="pre">XMLHttpRequest</span></code> callback function
for compatibility with a notebook like Jupyter or Zeppelin. If the GeoJSON was exported to a file named <code class="docutils literal notranslate"><span class="pre">aggregate.geojson</span></code>,
then the following JavaScript will load that a file into a Leaflet map.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">L</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="s1">&#39;map&#39;</span><span class="p">).</span><span class="nx">setView</span><span class="p">([</span><span class="mf">35.4746</span><span class="p">,</span><span class="o">-</span><span class="mf">44.7022</span><span class="p">],</span><span class="mf">3</span><span class="p">);</span>
<span class="w">    </span><span class="nx">L</span><span class="p">.</span><span class="nx">tileLayer</span><span class="p">(</span><span class="s2">&quot;http://{s}.tile.osm.org/{z}/{x}/{y}.png&quot;</span><span class="p">).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">aggFeature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;eventCount&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;#1a9850&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;#66bd63&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;#a6d96a&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;#d9ef8b&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;#ffffbf&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;#fee08b&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;#fdae61&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;#f46d43&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;#d73027&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">numBins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="c1">// Load the GeoJSON</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">rawFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="w">    </span><span class="nx">rawFile</span><span class="p">.</span><span class="nx">onreadystatechange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">rawFile</span><span class="p">.</span><span class="nx">readyState</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">rawFile</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">200</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">rawFile</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="nx">allText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rawFile</span><span class="p">.</span><span class="nx">response</span><span class="p">;</span>
<span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="nx">aggJson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">allText</span><span class="p">)</span>
<span class="w">                </span><span class="nx">L</span><span class="p">.</span><span class="nx">geoJson</span><span class="p">(</span><span class="nx">aggJson</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">style</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">feature</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">fillColor</span><span class="o">:</span><span class="w"> </span><span class="nx">getColor</span><span class="p">(</span><span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="nx">aggFeature</span><span class="p">]),</span>
<span class="w">                        </span><span class="nx">weight</span><span class="o">:</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">                    </span><span class="p">}},</span>
<span class="w">                    </span><span class="nx">onEachFeature</span><span class="o">:</span><span class="w"> </span><span class="nx">decorate</span>
<span class="w">                </span><span class="p">}).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Css override</span>
<span class="w">                </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;svg&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;max-width&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">rawFile</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;aggregate.geojson&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="nx">rawFile</span><span class="p">.</span><span class="nx">send</span><span class="p">()</span>
<span class="p">});</span>
</pre></div>
</div>
<p>This does make use of a few helper functions for setting the color and popup content of each item on the map:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create the bins of the histogram, allows for coloring features by value</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">createBins</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">.</span><span class="nx">MAX_SAFE_INTEGER</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="nx">json</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">feature</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">aggValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="nx">aggFeature</span><span class="p">])</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">aggValue</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">min</span><span class="p">)</span>
<span class="w">            </span><span class="nx">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">aggValue</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">aggValue</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">max</span><span class="p">)</span>
<span class="w">            </span><span class="nx">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">aggValue</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">max</span><span class="o">-</span><span class="nx">min</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">numBins</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numBins</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">bins</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="nx">interval</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Get the fill color based on which bin a value is in</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">getColor</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">colorRange</span><span class="p">[</span><span class="nx">numBins</span><span class="p">];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numBins</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="o">&lt;</span><span class="w"> </span><span class="nx">bins</span><span class="p">[</span><span class="nx">x</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">           </span><span class="nx">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">colorRange</span><span class="p">[</span><span class="nx">x</span><span class="p">];</span>
<span class="w">           </span><span class="k">break</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fillColor</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Decorate a feature with a popup of its properties</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">decorate</span><span class="p">(</span><span class="nx">feature</span><span class="p">,</span><span class="w"> </span><span class="nx">layer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">popupContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&lt;br/&gt;&quot;</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
<span class="w">   </span><span class="nx">layer</span><span class="p">.</span><span class="nx">bindPopup</span><span class="p">(</span><span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">popupContent</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Afterwards, this simple HTML will load a Leaflet map with the data.</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css&quot;</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;theAboveJavascriptFile.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;map&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;height: 100%&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>The end result will look something like this:</p>
<figure class="align-default">
<img alt="../_images/aggregate-GDELT.png" src="../_images/aggregate-GDELT.png" />
</figure>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="spark.html" class="btn btn-neutral float-left" title="GeoMesa Spark: Basic Analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="dwithin-join.html" class="btn btn-neutral float-right" title="GeoMesa Spark: Spatial Join and Aggregation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  

<div role="contentinfo">
  <p>
    &copy; Copyright 2013-2021 <a href="https://www.ccri.com/">Commonwealth Computer Research, Inc.</a>
    <br/>
    Licensed under the <a href="http://www.opensource.org/licenses/apache2.0.php">Apache License, Version 2.0</a>
  </p>
</div>

<div role="contentinfo">
  <p>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a>
    using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>
    
    - view <a href="../_sources/tutorials/broadcast-join.rst.txt" rel="nofollow">page source</a>
    
  </p>
</div>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53087457-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-53087457-1', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>