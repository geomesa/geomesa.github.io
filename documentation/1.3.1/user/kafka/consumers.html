

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8.6. Data Consumers &mdash; GeoMesa 1.3.1 Manuals</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme_custom.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="GeoMesa 1.3.1 Manuals" href="../../index.html"/>
        <link rel="up" title="8. Kafka Data Store" href="index.html"/>
        <link rel="next" title="8.7. Listening for Feature Events" href="feature_events.html"/>
        <link rel="prev" title="8.5. Data Producers" href="producers.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> GeoMesa
          

          
          </a>

          
            
            
              <div class="version">
                1.3.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">User Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html">2. Architecture Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html">3. Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../download.html">4. Versions and Downloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install.html">5. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../datastores/index.html">6. GeoMesa Data Stores</a></li>
<li class="toctree-l2"><a class="reference internal" href="../accumulo/index.html">7. Accumulo Data Store</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">8. Kafka Data Store</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="install.html">8.1. Installing GeoMesa Kafka</a></li>
<li class="toctree-l3"><a class="reference internal" href="usage.html">8.2. Using the Kafka Data Store Programmatically</a></li>
<li class="toctree-l3"><a class="reference internal" href="geoserver.html">8.3. Using the Kafka Data Store in GeoServer</a></li>
<li class="toctree-l3"><a class="reference internal" href="commandline.html">8.4. Kafka Command Line Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="producers.html">8.5. Data Producers</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">8.6. Data Consumers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#live-mode">8.6.1. Live Mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#replay-mode">8.6.2. Replay Mode</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="feature_events.html">8.7. Listening for Feature Events</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../hbase/index.html">9. HBase Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bigtable/index.html">10. Bigtable Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cassandra/index.html">11. Cassandra Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geoserver.html">12. GeoServer Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blobstore.html">13. GeoMesa Blob Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../convert/index.html">14. GeoMesa Convert</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geojson.html">15. GeoMesa GeoJSON</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html">16. GeoMesa Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../native_api.html">17. GeoMesa Native API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../process.html">18. GeoMesa Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spark/index.html">19. GeoMesa Spark</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stream.html">20. GeoMesa Stream Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../web_data.html">21. GeoMesa Web Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#appendix">Appendix</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GeoMesa</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">User Manual</a> &raquo;</li>
        
          <li><a href="index.html">8. Kafka Data Store</a> &raquo;</li>
        
      <li>8.6. Data Consumers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/user/kafka/consumers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="data-consumers">
<h1>8.6. Data Consumers<a class="headerlink" href="#data-consumers" title="Permalink to this headline">¶</a></h1>
<p>A GeoMesa Kafka data store in <em>consumer</em> mode reads feature data written
to Kafka (by a separate GeoMesa Kafka producer). The store supports two types of
<code class="docutils literal"><span class="pre">SimpleFeatureSource</span></code>&#8216;s: <em>live</em> and <em>replay</em>. A Kafka Consumer Feature
Source operating in <em>live</em> mode continually pulls data from the end of
the message queue (e.g. latest time) and always represents the latest
state of the simple features. A Kafka Consumer Feature Source operating
in <em>replay</em> mode will pull data from a specified time interval in the
past and can provide features as they existed at any point in time
within that interval.</p>
<p>First, create the data store. For example:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">brokers</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">String</span> <span class="n">zookeepers</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">String</span> <span class="n">zkPath</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">// build parameters map</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;brokers&quot;</span><span class="o">,</span> <span class="n">brokers</span><span class="o">);</span>
<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;zookeepers&quot;</span><span class="o">,</span> <span class="n">zookeepers</span><span class="o">);</span>

<span class="c1">// optional - the default is false</span>
<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;isProducer&quot;</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">);</span>

<span class="c1">// optional</span>
<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;zkPath&quot;</span><span class="o">,</span> <span class="n">zkPath</span><span class="o">);</span>

<span class="c1">// create the data store</span>
<span class="n">KafkaDataStoreFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KafkaDataStoreFactory</span><span class="o">();</span>
<span class="n">DataStore</span> <span class="n">consumerDs</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createDataStore</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">brokers</span></code>, <code class="docutils literal"><span class="pre">zookeepers</span></code>, and <code class="docutils literal"><span class="pre">zkPath</span></code> parameters must be
consistent with the values used to create the Kafka Data Store Producer.</p>
<p>Because <code class="docutils literal"><span class="pre">createSchema</span></code> was called on the Kafka Data Store Producer, it
does not need to be called on the Consumer. Calling <code class="docutils literal"><span class="pre">createSchema</span></code>
with a <code class="docutils literal"><span class="pre">SimpleFeatureType</span></code> that has already been created will result
in an exception being thrown. Note that all <code class="docutils literal"><span class="pre">SimpleFeature</span></code>s
returned by the Kafka Data Store consumer will have a
<code class="docutils literal"><span class="pre">SimpleFeatureType</span></code> equal to the <code class="docutils literal"><span class="pre">streamingSFT</span></code> created when setting
up the producer, i.e. the <code class="docutils literal"><span class="pre">SimpleFeatureType</span></code> will include the hint
added by <code class="docutils literal"><span class="pre">KafkaDataStoreHelper.createStreamingSFT</span></code>.</p>
<p>Now that the Kafka Data Store Consumer has been created it can be
queried in either <em>live</em> or <em>replay</em> mode.</p>
<div class="section" id="live-mode">
<h2>8.6.1. Live Mode<a class="headerlink" href="#live-mode" title="Permalink to this headline">¶</a></h2>
<p>Live mode is the default and requires no extra setup. In this mode the
<code class="docutils literal"><span class="pre">SimpleFeatureSource</span></code> contains the current state of the
<code class="docutils literal"><span class="pre">KafkaDataStore</span></code>. As <code class="docutils literal"><span class="pre">SimpleFeatures</span></code> are created, modified,
deleted, or cleared by the Kafka Data Store Producer, the current state
is updated. All queries to the <code class="docutils literal"><span class="pre">SimpleFeatureSource</span></code> are queries
against the current state. For example:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">SimpleFeatureSource</span> <span class="n">liveFeatureSource</span> <span class="o">=</span> <span class="n">consumerDs</span><span class="o">.</span><span class="na">getFeatureSource</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span>

<span class="n">Filter</span> <span class="n">filter</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">liveFeatureSource</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
</pre></div>
</div>
<p>It is also possible to provide a CQL filter to the getFeatureSource method call which will ensure
the resulting <code class="docutils literal"><span class="pre">FeatureSource</span></code> only contains certain records. Providing a filter to reduce the number of
returned records will provide a performance boost when using the featureSource.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">SimpleFeatureSource</span> <span class="n">liveFeatureSource</span> <span class="o">=</span> <span class="n">consumerDs</span><span class="o">.</span><span class="na">getFeatureSource</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">filter</span><span class="o">);</span>
</pre></div>
</div>
</div>
<div class="section" id="replay-mode">
<h2>8.6.2. Replay Mode<a class="headerlink" href="#replay-mode" title="Permalink to this headline">¶</a></h2>
<p>Replay mode allows the a user to query the <code class="docutils literal"><span class="pre">KafkaDataStore</span></code> as it
existed at any point in the past. Queries against a Kafka Replay Simple
Feature source specify a historical time to query and only the set and
version of <code class="docutils literal"><span class="pre">SimpleFeature</span></code>s that existed at that point in time will
be used to answer the query.</p>
<p>In order to use Replay mode some additional hints are required: the
start and end times of the replay window and a read behind duration:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Instant</span> <span class="n">replayStart</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">Instant</span> <span class="n">replayEnd</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">Duration</span> <span class="n">readBehind</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">ReplayConfig</span> <span class="n">replayConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReplayConfig</span><span class="o">(</span><span class="n">replayStart</span><span class="o">,</span> <span class="n">replayEnd</span><span class="o">,</span> <span class="n">readBehind</span><span class="o">);</span>
</pre></div>
</div>
<p>The replay window is simply an optimization that allows the Kafka Replay
Feature Source to load, at initialization time, all state changes that
occur within the window. Any query for a time outside of the window will
return no results even if features existed at that time.</p>
<p>The read behind is the amount of time used to rebuild state. For
example, if <code class="docutils literal"><span class="pre">readBehind</span> <span class="pre">=</span> <span class="pre">5s</span></code> then for a query requesting state at
<code class="docutils literal"><span class="pre">time</span> <span class="pre">=</span> <span class="pre">t</span></code> all state changes that occurred between <code class="docutils literal"><span class="pre">t</span> <span class="pre">-</span> <span class="pre">5s</span></code> and
<code class="docutils literal"><span class="pre">t</span></code> will be used to build the state at time <code class="docutils literal"><span class="pre">t</span></code> which will then be
used to answer the query. Selecting an appropriate read behind requires
an understanding of the producer. The expected use case is a producer
that updates every simple feature, even if it hasn&#8217;t changed, at a
regular interval. For example, if the producer is updating every <code class="docutils literal"><span class="pre">x</span></code>
seconds then a read behind of <code class="docutils literal"><span class="pre">x</span> <span class="pre">+</span> <span class="pre">1s</span></code> might be appropriate.</p>
<p>During initialization of the Kafka Replay Feature Source all state
changes from <code class="docutils literal"><span class="pre">replayStart</span> <span class="pre">-</span> <span class="pre">readBehind</span></code> to <code class="docutils literal"><span class="pre">replayEnd</span></code> will be read
and cached. As the size of the replay window and read behind increases
so does the amount of data that must be read and cashed. So, both the
size of the window and the read behind should be kept as small as
possible.</p>
<p>After creating the <code class="docutils literal"><span class="pre">ReplayConfig</span></code>, pass it, along with the
<code class="docutils literal"><span class="pre">streamingSFT</span></code>, to the <code class="docutils literal"><span class="pre">KafkaDataStoreHelper</span></code>:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">SimpleFeatureType</span> <span class="n">streamingSFT</span> <span class="o">=</span> <span class="n">consumerDs</span><span class="o">.</span><span class="na">getSchema</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span>
<span class="n">SimpleFeatureType</span> <span class="n">replaySFT</span> <span class="o">=</span> <span class="n">KafkaDataStoreHelper</span><span class="o">.</span><span class="na">createReplaySFT</span><span class="o">(</span><span class="n">streamingSFT</span><span class="o">,</span> <span class="n">replayConfig</span><span class="o">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">streamingSFT</span></code> passed to <code class="docutils literal"><span class="pre">createReplaySFT</span></code> must contain the
hints added by <code class="docutils literal"><span class="pre">KafkaDataStoreHelper.createStreamingSFT</span></code>. The easiest
way to ensure this is to call <code class="docutils literal"><span class="pre">consumerDs.getSchema(typeName)</span></code>. The
<code class="docutils literal"><span class="pre">SimpleFeatureType</span></code> returned by <code class="docutils literal"><span class="pre">createReplaySFT</span></code> will contain the
hint added by <code class="docutils literal"><span class="pre">createStreamingSFT</span></code> as well as a a hint containing the
<code class="docutils literal"><span class="pre">ReplayConfig</span></code>. Additionally the <code class="docutils literal"><span class="pre">replaySFT</span></code> will have a different
name than <code class="docutils literal"><span class="pre">streamingSFT</span></code>. This is to differentiate <em>live</em> and
<em>replay</em> <code class="docutils literal"><span class="pre">SimpleFeatureType</span></code>s. The <code class="docutils literal"><span class="pre">replaySFT</span></code> will also contain
an additional attribute, <code class="docutils literal"><span class="pre">KafkaLogTime</span></code>, of type <code class="docutils literal"><span class="pre">java.util.Date</span></code>
which represents the historical query time.</p>
<p>After creating the <code class="docutils literal"><span class="pre">replaySFT</span></code> the Kafka Replay Feature Source may be
created:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">consumerDs</span><span class="o">.</span><span class="na">createSchema</span><span class="o">(</span><span class="n">replaySFT</span><span class="o">);</span>

<span class="n">String</span> <span class="n">replayTimeName</span> <span class="o">=</span> <span class="n">replaySFT</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">();</span>
<span class="n">SimpleFeatureSource</span> <span class="n">replayFeatureSource</span> <span class="o">=</span> <span class="n">consumerDs</span><span class="o">.</span><span class="na">getFeatureSource</span><span class="o">(</span><span class="n">replayTimeName</span><span class="o">);</span>
</pre></div>
</div>
<p>The call to <code class="docutils literal"><span class="pre">createSchema</span></code> is required because the <code class="docutils literal"><span class="pre">replaySFT</span></code> is a
new <code class="docutils literal"><span class="pre">SimpleFeatureType</span></code>.</p>
<p>Finally the Kafka Replay Consumer Feature Source can be queried:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Instant</span> <span class="n">historicalTime</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">Filter</span> <span class="n">timeFilter</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">filter</span><span class="o">,</span> <span class="n">ReplayTimeHelper</span><span class="o">.</span><span class="na">toFilter</span><span class="o">(</span><span class="n">historicalTime</span><span class="o">));</span>

<span class="n">replayFeatureSource</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">(</span><span class="n">timeFilter</span><span class="o">);</span>
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="feature_events.html" class="btn btn-neutral float-right" title="8.7. Listening for Feature Events" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="producers.html" class="btn btn-neutral" title="8.5. Data Producers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2016 Commonwealth Computer Research, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.3.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>