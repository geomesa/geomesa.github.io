<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractCompositeConverter.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Convert Common</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.convert2</a> &gt; <span class="el_source">AbstractCompositeConverter.scala</span></div><h1>AbstractCompositeConverter.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.convert2

import com.typesafe.scalalogging.LazyLogging
import io.micrometer.core.instrument.{Metrics, Timer}
import org.geotools.api.feature.simple.{SimpleFeature, SimpleFeatureType}
import org.locationtech.geomesa.convert.EvaluationContext.{ContextListener, EvaluationError, FieldAccessor, StatListener, Stats}
import org.locationtech.geomesa.convert.Modes.ErrorMode
import org.locationtech.geomesa.convert.{EnrichmentCache, EvaluationContext}
import org.locationtech.geomesa.convert2.AbstractCompositeConverter.{CompositeEvaluationContext, PredicateContext}
import org.locationtech.geomesa.convert2.metrics.ConverterMetrics
import org.locationtech.geomesa.convert2.transforms.Predicate
import org.locationtech.geomesa.metrics.micrometer.utils.TagUtils
import org.locationtech.geomesa.utils.collection.CloseableIterator
import org.locationtech.geomesa.utils.io.CloseWithLogging

import java.io.InputStream
import java.time.Duration
import java.util.concurrent.TimeUnit
import scala.util.control.NonFatal

<span class="nc bnc" id="L29" title="All 4 branches missed.">abstract class AbstractCompositeConverter[T &lt;: AnyRef](</span>
<span class="nc" id="L30">    sft: SimpleFeatureType,</span>
<span class="nc" id="L31">    errorMode: ErrorMode,</span>
<span class="nc" id="L32">    delegates: Seq[(Predicate, ParsingConverter[T])]</span>
<span class="nc" id="L33">  ) extends SimpleFeatureConverter with LazyLogging {</span>

<span class="nc" id="L35">  private val tags = TagUtils.typeNameTag(sft.getTypeName)</span>

<span class="nc" id="L37">  private val routingTimer =</span>
<span class="nc" id="L38">    Timer.builder(ConverterMetrics.name(&quot;predicate.eval&quot;))</span>
<span class="nc" id="L39">      .tags(tags)</span>
      .publishPercentileHistogram()
<span class="nc" id="L41">      .minimumExpectedValue(Duration.ofNanos(1))</span>
<span class="nc" id="L42">      .maximumExpectedValue(Duration.ofMillis(2))</span>
<span class="nc" id="L43">      .register(Metrics.globalRegistry)</span>

<span class="nc" id="L45">  private val parseTimer =</span>
<span class="nc" id="L46">    Timer.builder(ConverterMetrics.name(&quot;parse&quot;))</span>
<span class="nc" id="L47">      .tags(tags)</span>
      .publishPercentileHistogram()
<span class="nc" id="L49">      .minimumExpectedValue(Duration.ofNanos(1))</span>
<span class="nc" id="L50">      .maximumExpectedValue(Duration.ofMillis(10))</span>
<span class="nc" id="L51">      .register(Metrics.globalRegistry)</span>

  protected def parse(is: InputStream, ec: EvaluationContext): CloseableIterator[T]

<span class="nc" id="L55">  override def targetSft: SimpleFeatureType = sft</span>

  override def createEvaluationContext(globalParams: Map[String, Any]): EvaluationContext =
<span class="nc" id="L58">    createEvaluationContext(delegates.map(_._2.createEvaluationContext(globalParams)), Stats(tags))</span>

<span class="nc" id="L60">  private def createEvaluationContext(contexts: Seq[EvaluationContext], theseStats: Stats): EvaluationContext = {</span>
<span class="nc" id="L61">    val stats = new Stats() {</span>
<span class="nc" id="L62">      override def success(i: Int): Long = theseStats.success(i) + contexts.map(_.stats.success(0)).sum</span>
<span class="nc" id="L63">      override def failure(i: Int): Long = theseStats.failure(i) + contexts.map(_.stats.failure(0)).sum</span>
    }
<span class="nc" id="L65">    CompositeEvaluationContext(contexts, stats)</span>
  }

<span class="nc" id="L68">  override def process(is: InputStream, ec: EvaluationContext): CloseableIterator[SimpleFeature] = {</span>
<span class="nc" id="L69">    val contexts = ec match {</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">      case cec: CompositeEvaluationContext =&gt; cec.contexts.iterator</span>
<span class="nc" id="L71">      case _ =&gt; Iterator.continually(ec)</span>
    }
<span class="nc bnc" id="L73" title="All 2 branches missed.">    val predicates = delegates.map { case (predicate, converter) =&gt;</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">      if (!contexts.hasNext) {</span>
<span class="nc" id="L75">        throw new IllegalArgumentException(s&quot;Invalid evaluation context doesn't match this converter: $ec&quot;)</span>
      }
<span class="nc" id="L77">      val context = contexts.next()</span>
<span class="nc" id="L78">      PredicateContext(predicate.withContext(context), converter, context)</span>
    }

<span class="nc" id="L81">    val args = Array.ofDim[AnyRef](1)</span>

    def matches(p: Predicate): Boolean = {
<span class="nc" id="L84">      try { p.apply(args) } catch {</span>
<span class="nc bnc" id="L85" title="All 4 branches missed.">        case NonFatal(e) =&gt; logger.warn(s&quot;Error evaluating predicate $p: &quot;, e); false</span>
      }
    }

<span class="nc" id="L89">    def eval(element: T): CloseableIterator[SimpleFeature] = {</span>
<span class="nc" id="L90">      val start = System.nanoTime()</span>
<span class="nc" id="L91">      args(0) = element</span>
<span class="nc bnc" id="L92" title="All 6 branches missed.">      val converted = predicates.collectFirst { case p if matches(p.predicate) =&gt;</span>
<span class="nc" id="L93">        routingTimer.record(System.nanoTime() - start, TimeUnit.NANOSECONDS) // note: invoke before executing the conversion</span>
<span class="nc" id="L94">        p.context.line = ec.line // update the line in the sub context</span>
<span class="nc" id="L95">        p.converter.convert(CloseableIterator.single(element), p.context)</span>
      }
<span class="nc" id="L97">      converted.getOrElse {</span>
<span class="nc" id="L98">        routingTimer.record(System.nanoTime() - start, TimeUnit.NANOSECONDS)</span>
<span class="nc" id="L99">        ec.stats.failure()</span>
<span class="nc" id="L100">        CloseableIterator.empty</span>
      }
    }

<span class="nc" id="L104">    new ErrorHandlingIterator(parse(is, ec), errorMode, ec, parseTimer).flatMap(eval)</span>
  }

<span class="nc" id="L107">  override def close(): Unit = CloseWithLogging(delegates.map(_._2))</span>
}

<span class="nc" id="L110">object AbstractCompositeConverter {</span>

<span class="nc bnc" id="L112" title="All 25 branches missed.">  case class CompositeEvaluationContext(contexts: Seq[EvaluationContext], stats: Stats) extends EvaluationContext {</span>
<span class="nc" id="L113">    private val errs = new java.util.ArrayDeque[EvaluationError]()</span>
    override def errors: java.util.Queue[EvaluationError] = {
<span class="nc" id="L115">      contexts.foreach { c =&gt;</span>
<span class="nc" id="L116">        val iter = c.errors.iterator()</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        while (iter.hasNext) {</span>
<span class="nc" id="L118">          errs.add(iter.next())</span>
<span class="nc" id="L119">          iter.remove()</span>
        }
      }
<span class="nc" id="L122">      errs</span>
    }
    override def withListener(listener: ContextListener): EvaluationContext =
<span class="nc" id="L125">      CompositeEvaluationContext(contexts.map(_.withListener(listener)), StatListener(stats, listener))</span>

<span class="nc bnc" id="L127" title="All 2 branches missed.">    override val success: com.codahale.metrics.Counter = new com.codahale.metrics.Counter() {</span>
<span class="nc" id="L128">      override def inc(n: Long): Unit = stats.success(n.toInt)</span>
<span class="nc" id="L129">      override def getCount: Long = stats.success(0)</span>
    }
<span class="nc bnc" id="L131" title="All 2 branches missed.">    override val failure: com.codahale.metrics.Counter = new com.codahale.metrics.Counter() {</span>
<span class="nc" id="L132">      override def inc(n: Long): Unit = stats.failure(n.toInt)</span>
<span class="nc" id="L133">      override def getCount: Long = stats.failure(0)</span>
    }
<span class="nc" id="L135">    override def cache: Map[String, EnrichmentCache] = throw new UnsupportedOperationException()</span>
<span class="nc" id="L136">    override def accessor(name: String): FieldAccessor = throw new UnsupportedOperationException()</span>
    override def evaluate(args: Array[AnyRef]): Either[EvaluationError, Array[AnyRef]] =
<span class="nc" id="L138">      throw new UnsupportedOperationException()</span>
  }

<span class="nc bnc" id="L141" title="All 32 branches missed.">  case class PredicateContext[T &lt;: SimpleFeatureConverter](</span>
<span class="nc" id="L142">      predicate: Predicate,</span>
<span class="nc" id="L143">      converter: T,</span>
<span class="nc" id="L144">      context: EvaluationContext</span>
    )
<span class="nc" id="L146">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>