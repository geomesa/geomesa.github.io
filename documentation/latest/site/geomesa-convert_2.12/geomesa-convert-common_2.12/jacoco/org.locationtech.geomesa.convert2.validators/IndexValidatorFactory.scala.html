<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IndexValidatorFactory.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Convert Common</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.convert2.validators</a> &gt; <span class="el_source">IndexValidatorFactory.scala</span></div><h1>IndexValidatorFactory.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.convert2.validators

import com.typesafe.scalalogging.LazyLogging
import io.micrometer.core.instrument.Tags
import org.geotools.api.feature.simple.{SimpleFeature, SimpleFeatureType}
import org.locationtech.geomesa.curve.BinnedTime
import org.locationtech.geomesa.utils.geotools.GeoToolsDateFormat
import org.locationtech.geomesa.utils.text.WKTUtils
import org.locationtech.jts.geom.Geometry

import java.time.Instant
import java.util.{Date, Locale}

/**
  * Validator based on the indices used by the feature type. Currently only the x/z2 and x/z3 indices have
  * input requirements. In addition, features that validate against the x/z3 index will also validate against
  * the x/z2 index
  */
<span class="nc" id="L27">class IndexValidatorFactory extends SimpleFeatureValidatorFactory {</span>

  import IndexValidatorFactory._
  import org.locationtech.geomesa.utils.geotools.RichSimpleFeatureType.RichSimpleFeatureType

<span class="nc" id="L32">  override val name: String = IndexValidatorFactory.Name</span>

  override def apply(sft: SimpleFeatureType, config: Option[String], tags: Tags): SimpleFeatureValidator = {
<span class="nc" id="L35">    val geom = sft.getGeomIndex</span>
<span class="nc" id="L36">    val dtg = sft.getDtgIndex.getOrElse(-1)</span>
<span class="nc bnc" id="L37" title="All 4 branches missed.">    val enabled = sft.getIndices.collect { case id if id.mode.write =&gt; id.name.toLowerCase(Locale.US) }</span>
<span class="nc bnc" id="L38" title="All 10 branches missed.">    if (enabled.contains(&quot;z3&quot;) || enabled.contains(&quot;xz3&quot;) || (enabled.isEmpty &amp;&amp; geom != -1 &amp;&amp; dtg != -1)) {</span>
<span class="nc" id="L39">      val minDate = Date.from(BinnedTime.ZMinDate.toInstant)</span>
<span class="nc" id="L40">      val maxDate = Date.from(BinnedTime.maxDate(sft.getZ3Interval).toInstant)</span>
<span class="nc" id="L41">      new Z3Validator(Attribute(sft, geom), Attribute(sft, dtg), minDate, maxDate, tags)</span>
<span class="nc bnc" id="L42" title="All 8 branches missed.">    } else if (enabled.contains(&quot;z2&quot;) || enabled.contains(&quot;xz2&quot;) || (enabled.isEmpty &amp;&amp; geom != -1)) {</span>
<span class="nc" id="L43">      new Z2Validator(Attribute(sft, geom), tags)</span>
    } else {
<span class="nc" id="L45">      NoValidator</span>
    }
  }
}

<span class="nc bnc" id="L50" title="All 4 branches missed.">object IndexValidatorFactory extends LazyLogging {</span>

<span class="nc" id="L52">  val Name = &quot;index&quot;</span>

  // load a mutable envelope once - we don't modify it
<span class="nc" id="L55">  private val WholeWorldEnvelope = org.locationtech.geomesa.utils.geotools.wholeWorldEnvelope</span>

  private def geomBoundsError(geom: Geometry): String =
<span class="nc" id="L58">    s&quot;geometry exceeds world bounds ([-180,180][-90,90]): ${WKTUtils.write(geom)}&quot;</span>

  /**
   * Z2 validator
   *
   * @param geom geom
   * @param tags metrics tags
   */
<span class="nc" id="L66">  private class Z2Validator(geom: Attribute, tags: Tags) extends SimpleFeatureValidator {</span>

<span class="nc" id="L68">    private val success = successCounter(&quot;z2&quot;, geom.name, tags)</span>
<span class="nc" id="L69">    private val nullFailure = failureCounter(&quot;z2&quot;, geom.name, &quot;null&quot;, tags)</span>
<span class="nc" id="L70">    private val boundsFailure = failureCounter(&quot;z2&quot;, geom.name, &quot;invalid.bounds&quot;, tags)</span>

    override def validate(sf: SimpleFeature): String = {
<span class="nc" id="L73">      val g = sf.getAttribute(geom.i).asInstanceOf[Geometry]</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">      if (g == null) {</span>
<span class="nc" id="L75">        nullFailure.increment()</span>
<span class="nc" id="L76">        &quot;geometry is null&quot;</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">      } else if (!WholeWorldEnvelope.contains(g.getEnvelopeInternal)) {</span>
<span class="nc" id="L78">        boundsFailure.increment()</span>
<span class="nc" id="L79">        geomBoundsError(g)</span>
      } else {
<span class="nc" id="L81">        success.increment()</span>
<span class="nc" id="L82">        null</span>
      }
    }

<span class="nc" id="L86">    override def close(): Unit = {}</span>
  }

  /**
   * Z3 validator
   *
   * @param geom geom
   * @param dtg dtg
   * @param minDate min z3 date
   * @param maxDate max z3 date
   * @param tags metrics tags
   */
<span class="nc" id="L98">  private class Z3Validator(geom: Attribute, dtg: Attribute, minDate: Date, maxDate: Date, tags: Tags)</span>
<span class="nc" id="L99">      extends SimpleFeatureValidator {</span>

<span class="nc" id="L101">    private val success = successCounter(&quot;z3&quot;, s&quot;${geom.name},${dtg.name}&quot;, tags)</span>
<span class="nc" id="L102">    private val geomNullFailure = failureCounter(&quot;z3&quot;, geom.name, &quot;null&quot;, tags)</span>
<span class="nc" id="L103">    private val geomBoundsFailure = failureCounter(&quot;z3&quot;, geom.name, &quot;invalid.bounds&quot;, tags)</span>
<span class="nc" id="L104">    private val dtgNullFailure = failureCounter(&quot;z3&quot;, dtg.name, &quot;null&quot;, tags)</span>
<span class="nc" id="L105">    private val dtgBoundsFailure = failureCounter(&quot;z3&quot;, dtg.name, &quot;invalid.bounds&quot;, tags)</span>

<span class="nc" id="L107">    private val dateBefore = s&quot;date is before minimum indexable date (${GeoToolsDateFormat.format(Instant.ofEpochMilli(minDate.getTime))}):&quot;</span>
<span class="nc" id="L108">    private val dateAfter = s&quot;date is after maximum indexable date (${GeoToolsDateFormat.format(Instant.ofEpochMilli(maxDate.getTime))}):&quot;</span>

    override def validate(sf: SimpleFeature): String = {
<span class="nc" id="L111">      val d = sf.getAttribute(dtg.i).asInstanceOf[Date]</span>
<span class="nc" id="L112">      val g = sf.getAttribute(geom.i).asInstanceOf[Geometry]</span>
<span class="nc" id="L113">      var error: String = null</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">      if (g == null) {</span>
<span class="nc" id="L115">        geomNullFailure.increment()</span>
<span class="nc" id="L116">        error =  s&quot;$error, geometry is null&quot;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">      } else if (!WholeWorldEnvelope.contains(g.getEnvelopeInternal)) {</span>
<span class="nc" id="L118">        geomBoundsFailure.increment()</span>
<span class="nc" id="L119">        error =  s&quot;$error, ${geomBoundsError(g)}&quot;</span>
      }
<span class="nc bnc" id="L121" title="All 2 branches missed.">      if (d == null) {</span>
<span class="nc" id="L122">        dtgNullFailure.increment()</span>
<span class="nc" id="L123">        error = s&quot;$error, date is null&quot;</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">      } else if (d.before(minDate)) {</span>
<span class="nc" id="L125">        dtgBoundsFailure.increment()</span>
<span class="nc" id="L126">        error = s&quot;$error, $dateBefore ${GeoToolsDateFormat.format(Instant.ofEpochMilli(d.getTime))}&quot;</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">      } else if (d.after(maxDate)) {</span>
<span class="nc" id="L128">        dtgBoundsFailure.increment()</span>
<span class="nc" id="L129">        error = s&quot;$error, $dateAfter ${GeoToolsDateFormat.format(Instant.ofEpochMilli(d.getTime))}&quot;</span>
      }
<span class="nc bnc" id="L131" title="All 2 branches missed.">      if (error == null) {</span>
<span class="nc" id="L132">        success.increment()</span>
<span class="nc" id="L133">        null</span>
      } else {
<span class="nc" id="L135">        error.substring(6) // trim off leading 'null, '</span>
      }
    }

<span class="nc" id="L139">    override def close(): Unit = {}</span>
  }

<span class="nc" id="L142">  class ZIndexValidatorFactory extends IndexValidatorFactory {</span>
<span class="nc" id="L143">    override val name = &quot;z-index&quot;</span>
    override def apply(sft: SimpleFeatureType, config: Option[String], tags: Tags): SimpleFeatureValidator = {
<span class="nc bnc" id="L145" title="All 2 branches missed.">      logger.warn(&quot;'z-index' validator is deprecated, using 'index' instead&quot;)</span>
<span class="nc" id="L146">      super.apply(sft, config, tags)</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>