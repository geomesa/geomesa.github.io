<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EnrichmentCache.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Convert Common</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.convert</a> &gt; <span class="el_source">EnrichmentCache.scala</span></div><h1>EnrichmentCache.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.convert

import com.typesafe.config.Config
import org.apache.commons.csv.{CSVFormat, CSVParser}
import org.locationtech.geomesa.utils.classpath.ServiceLoader
import org.locationtech.geomesa.utils.io.WithClose

import java.io.{Closeable, InputStreamReader}
import java.nio.charset.StandardCharsets

trait EnrichmentCache extends Closeable {
  def get(args: Array[String]): Any
  def put(args: Array[String], value: Any): Unit
  def clear(): Unit
}

trait EnrichmentCacheFactory {
  def canProcess(conf: Config): Boolean
  def build(conf: Config): EnrichmentCache
}

<span class="nc" id="L30">object EnrichmentCache {</span>

<span class="nc bnc" id="L32" title="All 4 branches missed.">  lazy private val factories = ServiceLoader.load[EnrichmentCacheFactory]()</span>

  def apply(conf: Config): EnrichmentCache = {
<span class="nc" id="L35">    factories.find(_.canProcess(conf))</span>
<span class="nc" id="L36">        .getOrElse(throw new RuntimeException(s&quot;Could not find applicable EnrichmentCache for config: $conf&quot;))</span>
<span class="nc" id="L37">        .build(conf)</span>
  }
}

// For testing purposes
<span class="nc" id="L42">class SimpleEnrichmentCache(val cache: java.util.Map[String, java.util.HashMap[String, AnyRef]] = new java.util.HashMap[String, java.util.HashMap[String, AnyRef]]())</span>
<span class="nc" id="L43">    extends EnrichmentCache {</span>

  import scala.collection.JavaConverters._

<span class="nc" id="L47">  override def get(args: Array[String]): Any = Option(cache.get(args(0))).map(_.get(args(1))).orNull</span>

  override def put(args: Array[String], value: Any): Unit =
<span class="nc" id="L50">    cache.asScala.getOrElseUpdate(args(0), new java.util.HashMap[String, AnyRef]()).put(args(1), value.asInstanceOf[AnyRef])</span>

<span class="nc" id="L52">  override def clear(): Unit = cache.clear()</span>

<span class="nc" id="L54">  override def close(): Unit = {}</span>
}

<span class="nc" id="L57">class SimpleEnrichmentCacheFactory extends EnrichmentCacheFactory {</span>
<span class="nc bnc" id="L58" title="All 4 branches missed.">  override def canProcess(conf: Config): Boolean = conf.hasPath(&quot;type&quot;) &amp;&amp; conf.getString(&quot;type&quot;).equals(&quot;simple&quot;)</span>

<span class="nc" id="L60">  override def build(conf: Config): EnrichmentCache = new SimpleEnrichmentCache(conf.getConfig(&quot;data&quot;).root().unwrapped().asInstanceOf[java.util.Map[String, java.util.HashMap[String, AnyRef]]])</span>
}

<span class="nc" id="L63">class ResourceLoadingCache(path: String, idField: String, headers: Seq[String]) extends EnrichmentCache {</span>
  import scala.collection.JavaConverters._

<span class="nc" id="L66">  private val data = {</span>
<span class="nc" id="L67">    val loader = Option(Thread.currentThread().getContextClassLoader).getOrElse(getClass.getClassLoader)</span>
<span class="nc" id="L68">    val stream = loader.getResourceAsStream(path)</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">    if (stream == null) {</span>
<span class="nc" id="L70">      throw new IllegalArgumentException(s&quot;Could not load the resources at '$path'&quot;)</span>
    }
<span class="nc" id="L72">    val reader = new InputStreamReader(stream, StandardCharsets.UTF_8)</span>
<span class="nc" id="L73">    val format = CSVFormat.DEFAULT.withHeader(headers: _*)</span>
<span class="nc" id="L74">    WithClose(new CSVParser(reader, format)) { reader =&gt;</span>
<span class="nc" id="L75">      reader.getRecords.asScala.map(rec =&gt; rec.get(idField) -&gt; rec.toMap).toMap</span>
    }
  }

<span class="nc" id="L79">  override def get(args: Array[String]): Any = data.get(args(0)).map(_.get(args(1))).orNull</span>
<span class="nc" id="L80">  override def put(args: Array[String], value: Any): Unit = throw new UnsupportedOperationException()</span>
<span class="nc" id="L81">  override def clear(): Unit = throw new UnsupportedOperationException()</span>
<span class="nc" id="L82">  override def close(): Unit = {}</span>
}

<span class="nc" id="L85">class ResourceLoadingCacheFactory extends EnrichmentCacheFactory {</span>
<span class="nc bnc" id="L86" title="All 4 branches missed.">  override def canProcess(conf: Config): Boolean = conf.hasPath(&quot;type&quot;) &amp;&amp; conf.getString(&quot;type&quot;).equals(&quot;resource&quot;)</span>

  override def build(conf: Config): EnrichmentCache = {
    import scala.collection.JavaConverters._

<span class="nc" id="L91">    val path = conf.getString(&quot;path&quot;)</span>
<span class="nc" id="L92">    val idField = conf.getString(&quot;id-field&quot;)</span>
<span class="nc" id="L93">    val headers = conf.getStringList(&quot;columns&quot;)</span>
<span class="nc" id="L94">    new ResourceLoadingCache(path, idField, headers.asScala.toList)</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>