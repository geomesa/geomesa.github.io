<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BinConversionProcess.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Vector Processes</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.process.transform</a> &gt; <span class="el_source">BinConversionProcess.scala</span></div><h1>BinConversionProcess.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.process.transform

import com.typesafe.scalalogging.LazyLogging
import org.geotools.data.simple.SimpleFeatureCollection
import org.geotools.process.factory.{DescribeParameter, DescribeProcess, DescribeResult}
import org.locationtech.geomesa.index.geotools.GeoMesaFeatureCollection
import org.locationtech.geomesa.index.process.BinVisitor
import org.locationtech.geomesa.process.GeoMesaProcess
import org.locationtech.geomesa.utils.bin.AxisOrder
import org.locationtech.geomesa.utils.bin.BinaryOutputEncoder.EncodingOptions
import org.locationtech.geomesa.utils.geotools.SimpleFeatureTypes

import java.util.Locale

@DescribeProcess(
  title = &quot;Binary Conversion&quot;,
  description = &quot;Converts a feature collection to binary format&quot;
)
<span class="nc bnc" id="L27" title="All 4 branches missed.">class BinConversionProcess extends GeoMesaProcess with LazyLogging {</span>

  /**
    * Converts an input feature collection to BIN format
    *
    * @param features input features
    * @param geom geometry attribute to encode in the bin format, optional
    *             will use default geometry if not provided
    * @param dtg date attribute to encode in the bin format, optional
    *            will use default date if not provided
    * @param track track id attribute to encode in the bin format, optional
    *              will use feature id if not provided
    * @param label label attribute to encode in the bin format, optional
    * @param axisOrder axis order to encode points, optional
    * @return
    */
  @DescribeResult(description = &quot;Encoded feature collection&quot;)
  def execute(
              @DescribeParameter(name = &quot;features&quot;, description = &quot;Input feature collection to query &quot;)
              features: SimpleFeatureCollection,
              @DescribeParameter(name = &quot;track&quot;, description = &quot;Track field to use for BIN records&quot;, min = 0)
              track: String,
              @DescribeParameter(name = &quot;geom&quot;, description = &quot;Geometry field to use for BIN records&quot;, min = 0)
              geom: String,
              @DescribeParameter(name = &quot;dtg&quot;, description = &quot;Date field to use for BIN records&quot;, min = 0)
              dtg: String,
              @DescribeParameter(name = &quot;label&quot;, description = &quot;Label field to use for BIN records&quot;, min = 0)
              label: String,
              @DescribeParameter(name = &quot;axisOrder&quot;, description = &quot;Axis order - either latlon or lonlat&quot;, min = 0)
              axisOrder: String
             ): java.util.Iterator[Array[Byte]] = {

    import org.locationtech.geomesa.utils.geotools.RichSimpleFeatureType.RichSimpleFeatureType

<span class="nc bnc" id="L61" title="All 2 branches missed.">    logger.debug(s&quot;Running BIN encoding for ${features.getClass.getName}&quot;)</span>

<span class="nc" id="L63">    val sft = features.getSchema</span>

    def indexOf(attribute: String): Int = {
<span class="nc" id="L66">      val i = sft.indexOf(attribute)</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">      if (i == -1) {</span>
<span class="nc" id="L68">        throw new IllegalArgumentException(s&quot;Attribute $attribute doesn't exist in ${sft.getTypeName} &quot; +</span>
<span class="nc" id="L69">            SimpleFeatureTypes.encodeType(sft))</span>
      }
<span class="nc" id="L71">      i</span>
    }

<span class="nc" id="L74">    val geomField  = Option(geom).map(indexOf)</span>
<span class="nc" id="L75">    val dtgField   = Option(dtg).map(indexOf).orElse(sft.getDtgIndex)</span>
<span class="nc bnc" id="L76" title="All 6 branches missed.">    val trackField = Option(track).filter(_ != &quot;id&quot;).map(indexOf)</span>
<span class="nc" id="L77">    val labelField = Option(label).map(indexOf)</span>

<span class="nc" id="L79">    val axis = Option(axisOrder).map {</span>
<span class="nc bnc" id="L80" title="All 6 branches missed.">      case o if o.toLowerCase(Locale.US) == &quot;latlon&quot; =&gt; AxisOrder.LatLon</span>
<span class="nc bnc" id="L81" title="All 6 branches missed.">      case o if o.toLowerCase(Locale.US) == &quot;lonlat&quot; =&gt; AxisOrder.LonLat</span>
<span class="nc" id="L82">      case o =&gt; throw new IllegalArgumentException(s&quot;Invalid axis order '$o'. Valid values are 'latlon' and 'lonlat'&quot;)</span>
    }

<span class="nc" id="L85">    val visitor = new BinVisitor(sft, EncodingOptions(geomField, dtgField, trackField, labelField, axis))</span>
<span class="nc" id="L86">    GeoMesaFeatureCollection.visit(features, visitor)</span>
<span class="nc" id="L87">    visitor.getResult.results</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>