<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArrowConversionProcess.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Vector Processes</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.process.transform</a> &gt; <span class="el_source">ArrowConversionProcess.scala</span></div><h1>ArrowConversionProcess.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.process.transform

import com.typesafe.scalalogging.LazyLogging
import org.geotools.data.simple.SimpleFeatureCollection
import org.geotools.process.factory.{DescribeParameter, DescribeProcess, DescribeResult}
import org.locationtech.geomesa.arrow.ArrowProperties
import org.locationtech.geomesa.arrow.io.FormatVersion
import org.locationtech.geomesa.arrow.vector.SimpleFeatureVector.SimpleFeatureEncoding
import org.locationtech.geomesa.index.geotools.GeoMesaFeatureCollection
import org.locationtech.geomesa.index.process.ArrowVisitor
import org.locationtech.geomesa.process.GeoMesaProcess

@DescribeProcess(
  title = &quot;Arrow Conversion&quot;,
  description = &quot;Converts a feature collection to arrow format&quot;
)
<span class="nc bnc" id="L25" title="All 4 branches missed.">class ArrowConversionProcess extends GeoMesaProcess with LazyLogging {</span>

  /**
    * Converts an input feature collection to arrow format
    *
    * @param features input features
    * @param dictionaryFields attributes to dictionary encode, optional
    * @return
    */
  @DescribeResult(description = &quot;Encoded feature collection&quot;)
  def execute(
              @DescribeParameter(name = &quot;features&quot;, description = &quot;Input feature collection to encode&quot;)
              features: SimpleFeatureCollection,
              @DescribeParameter(name = &quot;includeFids&quot;, description = &quot;Include feature IDs in arrow file&quot;, min = 0)
              includeFids: java.lang.Boolean,
              @DescribeParameter(name = &quot;proxyFids&quot;, description = &quot;Proxy feature IDs to ints instead of strings&quot;, min = 0)
              proxyFids: java.lang.Boolean,
              @DescribeParameter(name = &quot;formatVersion&quot;, description = &quot;Arrow IPC format version&quot;, min = 0)
              formatVersion: String,
              @DescribeParameter(name = &quot;dictionaryFields&quot;, description = &quot;Attributes to dictionary encode&quot;, min = 0, max = 128, collectionType = classOf[String])
              dictionaryFields: java.util.List[String],
              @DescribeParameter(name = &quot;sortField&quot;, description = &quot;Attribute to sort by&quot;, min = 0)
              sortField: String,
              @DescribeParameter(name = &quot;sortReverse&quot;, description = &quot;Reverse the default sort order&quot;, min = 0)
              sortReverse: java.lang.Boolean,
              @DescribeParameter(name = &quot;batchSize&quot;, description = &quot;Number of features to include in each record batch&quot;, min = 0)
              batchSize: java.lang.Integer,
              @DescribeParameter(name = &quot;flattenStruct&quot;, description = &quot;Removes the outer SFT struct yielding top level feature access&quot;, min = 0)
              flattenStruct: java.lang.Boolean,
              @DescribeParameter(name = &quot;flipAxisOrder&quot;, description = &quot;Flip the axis order of returned coordinates from latitude/longitude (default) to longitude/latitude&quot;, min = 0, defaultValue = &quot;false&quot;)
<span class="nc" id="L55">              flipAxisOrder: java.lang.Boolean = false</span>
             ): java.util.Iterator[Array[Byte]] = {

    import scala.collection.JavaConverters._

<span class="nc bnc" id="L60" title="All 2 branches missed.">    logger.debug(s&quot;Running arrow encoding for ${features.getClass.getName}&quot;)</span>

<span class="nc" id="L62">    val sft = features.getSchema</span>

    // validate inputs
<span class="nc" id="L65">    val toEncode: Seq[String] = Option(dictionaryFields).map(_.asScala.toSeq).getOrElse(Seq.empty)</span>
<span class="nc" id="L66">    toEncode.foreach { attribute =&gt;</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">      if (sft.indexOf(attribute) == -1) {</span>
<span class="nc" id="L68">        throw new IllegalArgumentException(s&quot;Attribute $attribute doesn't exist in $sft&quot;)</span>
      }
    }

<span class="nc bnc" id="L72" title="All 8 branches missed.">    val encoding = SimpleFeatureEncoding.min(includeFids == null || includeFids, proxyFids != null &amp;&amp; proxyFids, Option(flipAxisOrder).exists(_.booleanValue))</span>
<span class="nc" id="L73">    val ipcVersion = Option(formatVersion).getOrElse(FormatVersion.ArrowFormatVersion.get)</span>
<span class="nc" id="L74">    val reverse = Option(sortReverse).map(_.booleanValue())</span>
<span class="nc" id="L75">    val batch = Option(batchSize).map(_.intValue).getOrElse(ArrowProperties.BatchSize.get.toInt)</span>

    val visitor =
<span class="nc" id="L78">      new ArrowVisitor(sft, encoding, ipcVersion, toEncode, Option(sortField), reverse, false, batch, flattenStruct)</span>
<span class="nc" id="L79">    GeoMesaFeatureCollection.visit(features, visitor)</span>
<span class="nc" id="L80">    visitor.getResult.results</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>