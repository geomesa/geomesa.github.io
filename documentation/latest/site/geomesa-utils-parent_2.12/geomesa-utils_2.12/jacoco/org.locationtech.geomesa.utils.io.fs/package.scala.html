<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>package.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Utils</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.utils.io.fs</a> &gt; <span class="el_source">package.scala</span></div><h1>package.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.utils.io

import org.apache.commons.compress.archivers.zip.{ZipArchiveEntry, ZipFile}
import org.apache.commons.compress.archivers.{ArchiveEntry, ArchiveInputStream}
import org.locationtech.geomesa.utils.collection.CloseableIterator

import java.io.InputStream
import scala.collection.mutable.ListBuffer

<span class="nc" id="L18">package object fs {</span>

<span class="nc" id="L20">  class ZipFileIterator(zipfile: ZipFile, path: String) extends CloseableIterator[(Option[String], InputStream)]() {</span>

<span class="nc" id="L22">    private val entries = zipfile.getEntries</span>
<span class="nc" id="L23">    private val open = ListBuffer.empty[InputStream]</span>
<span class="nc" id="L24">    private var entry: ZipArchiveEntry = _</span>

    override def hasNext: Boolean = {
<span class="nc bnc" id="L27" title="All 4 branches missed.">      if (entry == null &amp;&amp; entries.hasMoreElements) {</span>
<span class="nc" id="L28">        entry = entries.nextElement()</span>
<span class="nc bnc" id="L29" title="All 6 branches missed.">        while (entry != null &amp;&amp; (entry.isDirectory || !zipfile.canReadEntryData(entry))) {</span>
<span class="nc bnc" id="L30" title="All 2 branches missed.">          entry = if (entries.hasMoreElements) { entries.nextElement() } else { null }</span>
        }
      }
<span class="nc bnc" id="L33" title="All 2 branches missed.">      entry != null</span>
    }

    override def next(): (Option[String], InputStream) = {
<span class="nc bnc" id="L37" title="All 2 branches missed.">      if (!hasNext) { Iterator.empty.next() } else {</span>
        try {
<span class="nc" id="L39">          val is = zipfile.getInputStream(entry)</span>
<span class="nc" id="L40">          open += is</span>
<span class="nc" id="L41">          Some(s&quot;$path/${entry.getName}&quot;) -&gt; is</span>
        } finally {
<span class="nc" id="L43">          entry = null</span>
        }
      }
    }

    override def close(): Unit = {
<span class="nc" id="L49">      CloseWithLogging(open)</span>
<span class="nc" id="L50">      CloseWithLogging(zipfile)</span>
    }
  }

<span class="nc" id="L54">  class ArchiveFileIterator(archive: ArchiveInputStream[_ &lt;: ArchiveEntry], path: String)</span>
<span class="nc" id="L55">      extends CloseableIterator[(Option[String], InputStream)]() {</span>

    // the archive input stream will only read the current entry
    // but we need to wrap it to prevent it from being closed before reading all entries
<span class="nc" id="L59">    private val wrapper = new ArchiveInputStreamWrapper(archive)</span>
<span class="nc" id="L60">    private var entry: ArchiveEntry = _</span>

    override def hasNext: Boolean = {
<span class="nc bnc" id="L63" title="All 2 branches missed.">      if (entry == null) {</span>
<span class="nc" id="L64">        entry = archive.getNextEntry</span>
<span class="nc bnc" id="L65" title="All 6 branches missed.">        while (entry != null &amp;&amp; (entry.isDirectory || !archive.canReadEntryData(entry))) {</span>
<span class="nc" id="L66">          entry = archive.getNextEntry</span>
        }
      }
<span class="nc bnc" id="L69" title="All 2 branches missed.">      entry != null</span>
    }

    override def next(): (Option[String], InputStream) = {
<span class="nc bnc" id="L73" title="All 2 branches missed.">      if (!hasNext) { Iterator.empty.next() } else {</span>
<span class="nc" id="L74">        try { Some(s&quot;$path/${entry.getName}&quot;) -&gt; wrapper } finally {</span>
<span class="nc" id="L75">          entry = null</span>
        }
      }
    }

<span class="nc" id="L80">    override def close(): Unit = archive.close()</span>
  }

<span class="nc" id="L83">  class ArchiveInputStreamWrapper(is: InputStream) extends InputStream {</span>
<span class="nc" id="L84">    override def read(): Int = is.read()</span>
<span class="nc" id="L85">    override def read(b: Array[Byte]): Int = is.read(b)</span>
<span class="nc" id="L86">    override def read(b: Array[Byte], off: Int, len: Int): Int = is.read(b, off, len)</span>
<span class="nc" id="L87">    override def skip(n: Long): Long = is.skip(n)</span>
<span class="nc" id="L88">    override def available(): Int = is.available()</span>
<span class="nc" id="L89">    override def mark(readlimit: Int): Unit = is.mark(readlimit)</span>
<span class="nc" id="L90">    override def markSupported(): Boolean = is.markSupported()</span>
<span class="nc" id="L91">    override def reset(): Unit = is.reset()</span>

    // override close to prevent closing the underlying stream
<span class="nc" id="L94">    override def close(): Unit = {}</span>
  }
<span class="nc" id="L96">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>