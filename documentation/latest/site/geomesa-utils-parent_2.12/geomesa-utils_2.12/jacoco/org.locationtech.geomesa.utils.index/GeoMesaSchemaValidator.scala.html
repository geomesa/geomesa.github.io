<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GeoMesaSchemaValidator.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Utils</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.utils.index</a> &gt; <span class="el_source">GeoMesaSchemaValidator.scala</span></div><h1>GeoMesaSchemaValidator.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.utils.index

import com.typesafe.scalalogging.LazyLogging
import org.geotools.api.feature.simple.SimpleFeatureType
import org.locationtech.geomesa.utils.conf.GeoMesaSystemProperties.SystemProperty
import org.locationtech.geomesa.utils.geotools.RichSimpleFeatureType.RichSimpleFeatureType
import org.locationtech.geomesa.utils.geotools.SimpleFeatureTypes.Configs._
import org.locationtech.geomesa.utils.geotools.{FeatureUtils, SimpleFeatureTypes}
import org.locationtech.jts.geom.Geometry

import scala.collection.JavaConverters._

<span class="nc" id="L21">object GeoMesaSchemaValidator {</span>

  def validate(sft: SimpleFeatureType): Unit = {
<span class="nc" id="L24">    MixedGeometryCheck.validateGeometryType(sft)</span>
<span class="nc" id="L25">    TemporalIndexCheck.validateDtgField(sft)</span>
<span class="nc" id="L26">    ReservedWordCheck.validateAttributeNames(sft)</span>
<span class="nc" id="L27">    PropertyCheck.validateDuplicateProperty(sft)</span>
<span class="nc" id="L28">    IndexConfigurationCheck.validateIndices(sft)</span>
  }

  private [geomesa] def declared(sft: SimpleFeatureType, prop: String): Boolean =
<span class="nc" id="L32">    Option(sft.getUserData.get(prop)).orElse(SystemProperty(prop).option).exists(SimpleFeatureTypes.toBoolean)</span>
}

/**
  * Utility object that ensures that none of the (local portion of the) property
  * names is a reserved word in ECQL.  Using those reserved words in a simple
  * feature type will cause queries to fail.
  */
<span class="nc bnc" id="L40" title="All 4 branches missed.">object ReservedWordCheck extends LazyLogging {</span>

  // ensure that no attribute names are reserved words within GeoTools that will cause query problems
  def validateAttributeNames(sft: SimpleFeatureType): Unit = {
<span class="nc" id="L44">    val reservedWords = FeatureUtils.sftReservedWords(sft)</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">    if (reservedWords.nonEmpty) {</span>
<span class="nc" id="L46">      val msg = &quot;The simple feature type contains attribute name(s) that are reserved words: &quot; +</span>
<span class="nc" id="L47">          s&quot;${reservedWords.mkString(&quot;, &quot;)}. You may override this check by putting Boolean.TRUE into the &quot; +</span>
<span class="nc" id="L48">          s&quot;SimpleFeatureType user data under the key '$OverrideReservedWords' before calling createSchema, or by &quot; +</span>
<span class="nc" id="L49">          s&quot;setting the system property '$OverrideReservedWords' to 'true', however it may cause errors with some functionality.&quot;</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">      if (GeoMesaSchemaValidator.declared(sft, OverrideReservedWords)) {</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">        logger.warn(msg)</span>
      } else {
<span class="nc" id="L53">        throw new IllegalArgumentException(msg)</span>
      }
    }
  }
}

/**
 * Utility object for emitting a warning to the user if a SimpleFeatureType contains a temporal attribute, but
 * none is used in the index.
 *
 * Furthermore, this object presents a candidate to be used in this case.
 *
 * This is useful since the only symptom of this mistake is slower than normal queries on temporal ranges.
 */
<span class="nc bnc" id="L67" title="All 4 branches missed.">object TemporalIndexCheck extends LazyLogging {</span>

  def validateDtgField(sft: SimpleFeatureType): Unit = {
<span class="nc" id="L70">    val dtgCandidates = scanForTemporalAttributes(sft) // all attributes which may be used</span>
    // validate that we have an ok field, and replace it if not
<span class="nc bnc" id="L72" title="All 2 branches missed.">    if (!sft.getDtgField.exists(dtgCandidates.contains)) {</span>
<span class="nc" id="L73">      sft.getDtgField.foreach { dtg =&gt; // clear out any existing invalid field</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        logger.warn(s&quot;Invalid date field '$dtg' specified for schema $sft&quot;)</span>
<span class="nc" id="L75">        sft.clearDtgField()</span>
      }
      // if there are valid fields, warn and set to the first available
<span class="nc bnc" id="L78" title="All 2 branches missed.">      if (!GeoMesaSchemaValidator.declared(sft, IndexIgnoreDtg)) {</span>
<span class="nc" id="L79">        dtgCandidates.headOption.foreach { candidate =&gt;</span>
          lazy val theWarning = s&quot;$DefaultDtgField is not valid or defined for simple feature type $sft. &quot; +
              &quot;However, the following attribute(s) can be used in GeoMesa's temporal index: &quot; +
              s&quot;${dtgCandidates.mkString(&quot;, &quot;)}. To disable temporal indexing, put Boolean.TRUE into the &quot; +
              s&quot;SimpleFeatureType user data under the key '$IndexIgnoreDtg' before calling createSchema, or &quot; +
<span class="nc bnc" id="L84" title="All 2 branches missed.">              s&quot;set the system property '$IndexIgnoreDtg' to 'true'. GeoMesa will now point $DefaultDtgField &quot; +</span>
              s&quot;to the first temporal attribute found: $candidate&quot;
<span class="nc bnc" id="L86" title="All 2 branches missed.">          logger.warn(theWarning)</span>
<span class="nc" id="L87">          sft.setDtgField(candidate)</span>
        }
      }
    }
  }

  private def scanForTemporalAttributes(sft: SimpleFeatureType): Seq[String] =
<span class="nc" id="L94">    sft.getAttributeDescriptors.asScala.toList</span>
<span class="nc" id="L95">      .withFilter { classOf[java.util.Date] isAssignableFrom _.getType.getBinding } .map { _.getLocalName }</span>
}

<span class="nc bnc" id="L98" title="All 4 branches missed.">object MixedGeometryCheck extends LazyLogging {</span>

  def validateGeometryType(sft: SimpleFeatureType): Unit = {
<span class="nc" id="L101">    val gd = sft.getGeometryDescriptor</span>
<span class="nc bnc" id="L102" title="All 8 branches missed.">    if (gd != null &amp;&amp; gd.getType.getBinding == classOf[Geometry]) {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">      if (!GeoMesaSchemaValidator.declared(sft, MixedGeometries)) {</span>
<span class="nc" id="L104">        throw new IllegalArgumentException(&quot;Trying to create a schema with mixed geometry type &quot; +</span>
<span class="nc" id="L105">            s&quot;'${gd.getLocalName}:Geometry'. Queries may be slower when using mixed geometries. &quot; +</span>
<span class="nc" id="L106">            &quot;If this is intentional, you may override this check by putting Boolean.TRUE into the &quot; +</span>
<span class="nc" id="L107">            s&quot;SimpleFeatureType user data under the key '$MixedGeometries' before calling createSchema, or by &quot; +</span>
<span class="nc" id="L108">            s&quot;setting the system property '$MixedGeometries' to 'true'. Otherwise, please specify a single &quot; +</span>
<span class="nc" id="L109">            s&quot;geometry type (e.g. Point, LineString, Polygon, etc).&quot;)</span>
      }
    }
  }
}

<span class="nc" id="L115">object IndexConfigurationCheck {</span>

  def validateIndices(sft: SimpleFeatureType): Unit = {
    import org.locationtech.geomesa.utils.geotools.RichSimpleFeatureType.RichSimpleFeatureType
<span class="nc bnc" id="L119" title="All 4 branches missed.">    require(sft.getZ2Shards &gt; 0 &amp;&amp; sft.getZ2Shards &lt; 128, &quot;Z shards must be between 1 and 127&quot;)</span>
<span class="nc bnc" id="L120" title="All 4 branches missed.">    require(sft.getZ3Shards &gt; 0 &amp;&amp; sft.getZ3Shards &lt; 128, &quot;Z shards must be between 1 and 127&quot;)</span>
<span class="nc bnc" id="L121" title="All 4 branches missed.">    require(sft.getAttributeShards &gt; 0 &amp;&amp; sft.getAttributeShards &lt; 128, &quot;Attribute shards must be between 1 and 127&quot;)</span>
  }
}

<span class="nc" id="L125">object PropertyCheck {</span>
  def validateDuplicateProperty(sft: SimpleFeatureType):Unit = {
<span class="nc" id="L127">    val names = sft.getAttributeDescriptors.asScala.map(descriptor =&gt; descriptor.getLocalName)</span>
<span class="nc" id="L128">    val duplicateProperties = names.diff(names.distinct)</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">    if ( duplicateProperties.nonEmpty ){</span>
<span class="nc" id="L130">      throw new IllegalArgumentException(s&quot;Schema contains duplicate attribute names: '${duplicateProperties.mkString(&quot;, &quot;)}' &quot;)</span>
    }
  }
<span class="nc" id="L133">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>