<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FeatureExpiration.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Utils</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.utils.conf</a> &gt; <span class="el_source">FeatureExpiration.scala</span></div><h1>FeatureExpiration.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.utils.conf

import org.geotools.api.feature.simple.{SimpleFeature, SimpleFeatureType}

import java.util.Date
import scala.concurrent.duration.Duration
import scala.util.control.NonFatal

/**
  * Configurable feature expiration (time-to-live, age-off)
  */
sealed trait FeatureExpiration {

  /**
    * Returns the expiration time for the feature, in millis since the java epoch
    *
    * @param feature simple feature
    * @return
    */
  def expires(feature: SimpleFeature): Long
}

<span class="nc" id="L31">object FeatureExpiration {</span>

<span class="nc" id="L33">  private val AttributeRegex = &quot;&quot;&quot;([^()]+)\((.+)\)&quot;&quot;&quot;.r // name(ttl)</span>

  /**
    * Expiration based on ingest time
    *
    * @param ttl time-to-live after ingestion, before the feature expires
    */
<span class="nc bnc" id="L40" title="All 18 branches missed.">  case class IngestTimeExpiration(ttl: Duration) extends FeatureExpiration {</span>
<span class="nc" id="L41">    private val millis = ttl.toMillis</span>
<span class="nc" id="L42">    override def expires(feature: SimpleFeature): Long = System.currentTimeMillis() + millis</span>
  }

  /**
    * Expiration based on an attribute of the feature
    *
    * @param attribute name of a Date-type attribute
    * @param i index in the sft of the attribute
    * @param ttl time-to-live after the attribute date, before the feature expires
    */
<span class="nc bnc" id="L52" title="All 28 branches missed.">  case class FeatureTimeExpiration(attribute: String, i: Int, ttl: Duration)</span>
<span class="nc" id="L53">      extends FeatureExpiration {</span>
<span class="nc" id="L54">    private val millis = ttl.toMillis</span>
    override def expires(feature: SimpleFeature): Long = {
<span class="nc" id="L56">      val date = feature.getAttribute(i).asInstanceOf[Date]</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">      if (date == null) { 0L } else { date.getTime + millis }</span>
    }
  }

  /**
    * Parse an expiration string
    *
    * @param sft simple feature type
    * @param expiration expiration string
    * @return
    */
  def apply(sft: SimpleFeatureType, expiration: String): FeatureExpiration = {
<span class="nc" id="L69">    val matcher = AttributeRegex.pattern.matcher(expiration)</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">    if (matcher.matches()) {</span>
<span class="nc" id="L71">      val attribute = matcher.group(1)</span>
<span class="nc" id="L72">      val i = sft.indexOf(attribute)</span>
<span class="nc bnc" id="L73" title="All 4 branches missed.">      if (i == -1 || !classOf[Date].isAssignableFrom(sft.getDescriptor(i).getType.getBinding)) {</span>
<span class="nc" id="L74">        throw new IllegalArgumentException(s&quot;Invalid age-off attribute: $attribute&quot;)</span>
      }
<span class="nc" id="L76">      FeatureTimeExpiration(attribute, i, duration(matcher.group(2)))</span>
    } else {
<span class="nc" id="L78">      IngestTimeExpiration(duration(expiration))</span>
    }
  }

  /**
    * Convert an expiration to a serialized string
    *
    * @param expiration expiration
    * @return
    */
  def unapply(expiration: FeatureExpiration): Option[String] = {
<span class="nc" id="L89">    expiration match {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">      case IngestTimeExpiration(duration)                =&gt; Some(duration.toString)</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">      case FeatureTimeExpiration(attribute, _, duration) =&gt; Some(s&quot;$attribute($duration)&quot;)</span>
<span class="nc" id="L92">      case _                                             =&gt; None</span>
    }
  }

  private def duration(string: String): Duration = {
<span class="nc" id="L97">    try {</span>
<span class="nc" id="L98">      val duration = Duration(string)</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">      if (!duration.isFinite) {</span>
<span class="nc" id="L100">        throw new IllegalArgumentException(&quot;Duration is infinite&quot;)</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">      } else if (duration &lt;= Duration.Zero) {</span>
<span class="nc" id="L102">        throw new IllegalArgumentException(&quot;Duration is negative&quot;)</span>
      }
<span class="nc" id="L104">      duration</span>
    } catch {
<span class="nc bnc" id="L106" title="All 2 branches missed.">      case NonFatal(e) =&gt; throw new IllegalArgumentException(s&quot;Invalid age-off time-to-live: $string&quot;, e)</span>
    }
  }
<span class="nc" id="L109">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>