<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SafeClose.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Utils</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.utils.io</a> &gt; <span class="el_source">SafeClose.scala</span></div><h1>SafeClose.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.utils.io

import org.geotools.api.data.DataStore
import org.locationtech.geomesa.utils.io.IsCloseableImplicits._

import java.util.concurrent.ExecutorService
import scala.util.{Failure, Success, Try}

/**
  * Closes anything with a 'close' method without throwing an exception
  */
<span class="nc" id="L20">trait SafeClose {</span>

  def apply[C : IsCloseable](c: C): Option[Throwable]

  def apply[C1 : IsCloseable, C2 : IsCloseable](c1: C1, c2: C2): Option[Throwable] = {
<span class="nc" id="L25">    apply(c1) match {</span>
<span class="nc bnc" id="L26" title="All 2 branches missed.">      case None =&gt; apply(c2)</span>
<span class="nc bnc" id="L27" title="All 2 branches missed.">      case Some(e) =&gt; apply(c2).foreach(e.addSuppressed); Some(e)</span>
    }
  }

<span class="nc" id="L31">  def raise[C : IsCloseable](c: C): Unit = apply(c).foreach(e =&gt; throw e)</span>

<span class="nc" id="L33">  def raise[C1 : IsCloseable, C2 : IsCloseable](c1: C1, c2: C2): Unit = apply(c1, c2).foreach(e =&gt; throw e)</span>
}

trait IsCloseable[-C] {
  def close(obj: C): Try[Unit]
}

<span class="nc" id="L40">object IsCloseable extends IsCloseableImplicits[AutoCloseable] {</span>
<span class="nc" id="L41">  override protected def close(c: AutoCloseable): Try[Unit] = Try(c.close())</span>
}

<span class="nc" id="L44">trait IsCloseableImplicits[C] {</span>

  protected def close(c: C): Try[Unit]

<span class="nc bnc" id="L48" title="All 2 branches missed.">  implicit val closeableIsCloseable: IsCloseable[C] = new IsCloseable[C] {</span>
<span class="nc" id="L49">    override def close(obj: C): Try[Unit] = IsCloseableImplicits.this.close(obj)</span>
  }

<span class="nc" id="L52">  implicit val iterableIsCloseable: IterableIsCloseable[C] = new IterableIsCloseable()</span>
<span class="nc" id="L53">  implicit val optionIsCloseable: OptionIsCloseable[C] = new OptionIsCloseable()</span>
<span class="nc" id="L54">  implicit val arrayIsCloseable: ArrayIsCloseable[C] = new ArrayIsCloseable()</span>

<span class="nc" id="L56">  implicit val dataStoreIsCloseable: DataStoreIsCloseable = new DataStoreIsCloseable()</span>
<span class="nc" id="L57">  implicit val dataStoreIterableIsCloseable: IterableIsCloseable[DataStore] = new IterableIsCloseable()</span>
<span class="nc" id="L58">  implicit val dataStoreOptionIsCloseable: OptionIsCloseable[DataStore] = new OptionIsCloseable()</span>
<span class="nc" id="L59">  implicit val dataStoreArrayIsCloseable: ArrayIsCloseable[DataStore] = new ArrayIsCloseable()</span>

<span class="nc" id="L61">  implicit val executorServiceIsCloseable: ExecutorServiceIsCloseable = new ExecutorServiceIsCloseable()</span>
<span class="nc" id="L62">  implicit val executorServiceIterableIsCloseable: IterableIsCloseable[ExecutorService] = new IterableIsCloseable()</span>
<span class="nc" id="L63">  implicit val executorServiceOptionIsCloseable: OptionIsCloseable[ExecutorService] = new OptionIsCloseable()</span>
<span class="nc" id="L64">  implicit val executorServiceArrayIsCloseable: ArrayIsCloseable[ExecutorService] = new ArrayIsCloseable()</span>
}

<span class="nc" id="L67">object IsCloseableImplicits {</span>

<span class="nc" id="L69">  class IterableIsCloseable[C : IsCloseable] extends IsCloseable[Iterable[_ &lt;: C]] {</span>

<span class="nc" id="L71">    private val ev = implicitly[IsCloseable[C]]</span>

    override def close(obj: Iterable[_ &lt;: C]): Try[Unit] = {
<span class="nc" id="L74">      var error: Throwable = null</span>
<span class="nc" id="L75">      obj.foreach { f =&gt;</span>
<span class="nc" id="L76">        ev.close(f).failed.foreach { e =&gt;</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">          if (error == null) { error = e } else { error.addSuppressed(e) }</span>
        }
      }
<span class="nc bnc" id="L80" title="All 2 branches missed.">      if (error == null) { Success() } else { Failure(error) }</span>
    }
  }

<span class="nc" id="L84">  class OptionIsCloseable[C : IsCloseable] extends IsCloseable[Option[_ &lt;: C]] {</span>

<span class="nc" id="L86">    private val ev = implicitly[IsCloseable[C]]</span>

    override def close(obj: Option[_ &lt;: C]): Try[Unit] = {
<span class="nc" id="L89">      obj match {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        case None =&gt; Success()</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">        case Some(o) =&gt; ev.close(o)</span>
      }
    }
  }

<span class="nc" id="L96">  class ArrayIsCloseable[C : IsCloseable] extends IsCloseable[Array[_ &lt;: C]] {</span>

<span class="nc" id="L98">    private val ev = implicitly[IsCloseable[C]]</span>

    override def close(obj: Array[_ &lt;: C]): Try[Unit] = {
<span class="nc" id="L101">      var error: Throwable = null</span>
<span class="nc" id="L102">      obj.foreach { f =&gt;</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">        ev.close(f).failed.foreach(e =&gt; if (error == null) { error = e } else { error.addSuppressed(e) })</span>
      }
<span class="nc bnc" id="L105" title="All 2 branches missed.">      if (error == null) { Success() } else { Failure(error) }</span>
    }
  }

<span class="nc" id="L109">  class DataStoreIsCloseable extends IsCloseable[DataStore] {</span>
<span class="nc" id="L110">    override def close(obj: DataStore): Try[Unit] = Try(obj.dispose())</span>
  }

<span class="nc" id="L113">  class ExecutorServiceIsCloseable extends IsCloseable[ExecutorService] {</span>
<span class="nc" id="L114">    override def close(obj: ExecutorService): Try[Unit] = Try(obj.shutdown())</span>
  }
<span class="nc" id="L116">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>