<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Instrumentations.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Metrics Micrometer</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.metrics.micrometer</a> &gt; <span class="el_source">Instrumentations.scala</span></div><h1>Instrumentations.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.metrics.micrometer

import com.typesafe.config.{Config, ConfigFactory}
import com.typesafe.scalalogging.StrictLogging
import io.micrometer.core.instrument.binder.MeterBinder
import io.micrometer.core.instrument.binder.commonspool2.CommonsObjectPool2Metrics
import io.micrometer.core.instrument.binder.jvm.{ClassLoaderMetrics, JvmGcMetrics, JvmMemoryMetrics, JvmThreadMetrics}
import io.micrometer.core.instrument.binder.system.ProcessorMetrics
import io.micrometer.core.instrument.{Metrics, Tag}
import pureconfig.{ConfigReader, ConfigSource}

import java.util.Collections
import java.util.concurrent.ConcurrentHashMap

/**
 * Manages micrometer instrumentation loading
 */
<span class="nc" id="L26">object Instrumentations extends StrictLogging {</span>

  import pureconfig.generic.semiauto._

  import scala.collection.JavaConverters._

  // instrumentations that we've already bound, to prevent duplicates
<span class="nc" id="L33">  private val bindings = Collections.newSetFromMap(new ConcurrentHashMap[(String, Map[String, String]), java.lang.Boolean]())</span>

<span class="nc" id="L35">  private val defaults = ConfigFactory.load(&quot;instrumentations&quot;)</span>

  /**
   * Configure default instrumentations
   */
<span class="nc" id="L40">  def bind(conf: Config = ConfigFactory.empty()): Unit = {</span>
<span class="nc" id="L41">    val instrumentations = InstrumentationConfig(conf.withFallback(defaults))</span>
<span class="nc" id="L42">    addBinding(instrumentations.classloader, &quot;JVM classloader&quot;, tags =&gt; new ClassLoaderMetrics(tags))</span>
<span class="nc" id="L43">    addBinding(instrumentations.memory,      &quot;JVM memory&quot;,      tags =&gt; new JvmMemoryMetrics(tags))</span>
<span class="nc" id="L44">    addBinding(instrumentations.gc,          &quot;JVM gc&quot;,          tags =&gt; new JvmGcMetrics(tags))</span>
<span class="nc" id="L45">    addBinding(instrumentations.processor,   &quot;JVM processor&quot;,   tags =&gt; new ProcessorMetrics(tags))</span>
<span class="nc" id="L46">    addBinding(instrumentations.threads,     &quot;JVM thread&quot;,      tags =&gt; new JvmThreadMetrics(tags))</span>
<span class="nc" id="L47">    addBinding(instrumentations.commonsPool, &quot;commons pool&quot;,    tags =&gt; new CommonsObjectPool2Metrics(tags))</span>
  }

  /**
   * Add a meter binding
   *
   * @param config config
   * @param key unique key to identify this binding
   * @param binder binder constructor
   */
  private def addBinding(config: Instrumentation, key: String, binder: java.lang.Iterable[Tag] =&gt; MeterBinder): Unit = {
<span class="nc bnc" id="L58" title="All 4 branches missed.">    if (config.enabled &amp;&amp; bindings.add(key -&gt; config.tags)) {</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">      val tags = config.tags.map { case (k, v) =&gt; Tag.of(k, v) }</span>
<span class="nc bnc" id="L60" title="All 4 branches missed.">      logger.info(s&quot;Adding $key metrics${if (tags.isEmpty) &quot;&quot; else s&quot; with ${tags.toSeq.map(_.toString).sorted.mkString(&quot;, &quot;)}&quot;}&quot;)</span>
<span class="nc" id="L61">      binder(tags.asJava).bindTo(Metrics.globalRegistry)</span>
    }
  }

<span class="nc bnc" id="L65" title="All 23 branches missed.">  private case class Instrumentation(enabled: Boolean, tags: Map[String, String])</span>

<span class="nc bnc" id="L67" title="All 53 branches missed.">  private case class InstrumentationConfig(</span>
<span class="nc" id="L68">    classloader: Instrumentation,</span>
<span class="nc" id="L69">    memory: Instrumentation,</span>
<span class="nc" id="L70">    gc: Instrumentation,</span>
<span class="nc" id="L71">    processor: Instrumentation,</span>
<span class="nc" id="L72">    threads: Instrumentation,</span>
<span class="nc" id="L73">    commonsPool: Instrumentation,</span>
  )

<span class="nc" id="L76">  private object InstrumentationConfig {</span>
    // noinspection ScalaUnusedSymbol
    def apply(conf: Config): InstrumentationConfig = {
<span class="nc bnc" id="L79" title="All 40 branches missed.">      implicit val r0: ConfigReader[Instrumentation] = deriveReader[Instrumentation]</span>
<span class="nc bnc" id="L80" title="All 68 branches missed.">      implicit val r1: ConfigReader[InstrumentationConfig] = deriveReader[InstrumentationConfig]</span>
<span class="nc" id="L81">      ConfigSource.fromConfig(conf).loadOrThrow[InstrumentationConfig]</span>
    }
  }

<span class="nc" id="L85">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>