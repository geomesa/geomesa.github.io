<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GeometricProcessingFunctions.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Spark JTS</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.spark.jts.udf</a> &gt; <span class="el_source">GeometricProcessingFunctions.scala</span></div><h1>GeometricProcessingFunctions.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/


package org.locationtech.geomesa.spark.jts.udf

import org.apache.spark.sql.SQLContext
import org.locationtech.geomesa.spark.jts.util.SQLFunctionHelper._
import org.locationtech.jts.geom._
import org.locationtech.jts.util.GeometricShapeFactory
import org.locationtech.spatial4j.context.jts.JtsSpatialContext
import org.locationtech.spatial4j.distance.DistanceUtils
import org.locationtech.spatial4j.shape.Circle
import org.locationtech.spatial4j.shape.jts.JtsPoint

<span class="nc" id="L21">object GeometricProcessingFunctions {</span>

<span class="nc bnc" id="L23" title="All 4 branches missed.">  @transient private lazy val spatialContext = JtsSpatialContext.GEO</span>
<span class="nc bnc" id="L24" title="All 4 branches missed.">  @transient private lazy val shapeFactory   = spatialContext.getShapeFactory</span>
<span class="nc bnc" id="L25" title="All 4 branches missed.">  @transient private lazy val geometryFactory = new GeometryFactory()</span>
<span class="nc" id="L26">  @transient private val geometricShapeFactory =</span>
<span class="nc" id="L27">    new ThreadLocal[GeometricShapeFactory] {</span>
      override def initialValue(): GeometricShapeFactory = {
<span class="nc" id="L29">        new GeometricShapeFactory(geometryFactory)</span>
      }
    }

  private def fastCircleToGeom(circle: Circle): Geometry = {
<span class="nc" id="L34">    val gsf = geometricShapeFactory.get()</span>
<span class="nc" id="L35">    gsf.setSize(circle.getBoundingBox.getWidth)</span>
<span class="nc" id="L36">    gsf.setNumPoints(4*25) //multiple of 4 is best</span>
<span class="nc" id="L37">    gsf.setCentre(new Coordinate(circle.getCenter.getX, circle.getCenter.getY))</span>
<span class="nc" id="L38">    ST_antimeridianSafeGeom(gsf.createCircle())</span>
  }

<span class="nc" id="L41">  val ST_antimeridianSafeGeom: Geometry =&gt; Geometry = nullableUDF(geom =&gt; {</span>
<span class="nc" id="L42">    def degreesToTranslate(x: Double): Double = (((x + 180) / 360.0).floor * -360).toInt</span>

<span class="nc" id="L44">    val geomCopy = geometryFactory.createGeometry(geom)</span>
<span class="nc bnc" id="L45" title="All 4 branches missed.">    if (geomCopy.getEnvelopeInternal.getMinX &lt; -180 || geomCopy.getEnvelopeInternal.getMaxX &gt; 180) {</span>
<span class="nc" id="L46">      geomCopy.apply(new CoordinateSequenceFilter() {</span>
        override def filter(seq: CoordinateSequence, i: Int): Unit = {
<span class="nc" id="L48">          seq.setOrdinate(i, CoordinateSequence.X, seq.getX(i) + degreesToTranslate(seq.getX(i)))</span>
        }
<span class="nc" id="L50">        override def isDone: Boolean = false</span>
<span class="nc" id="L51">        override def isGeometryChanged: Boolean = true</span>
      })
    }

<span class="nc" id="L55">    val datelineSafeShape = shapeFactory.makeShapeFromGeometry(geomCopy)</span>
<span class="nc" id="L56">    shapeFactory.getGeometryFrom(datelineSafeShape)</span>
  })

<span class="nc" id="L59">  val ST_BufferPoint: (Point, Double) =&gt; Geometry = (p, d) =&gt; {</span>
<span class="nc" id="L60">    val degrees = DistanceUtils.dist2Degrees(d/1000.0, DistanceUtils.EARTH_MEAN_RADIUS_KM)</span>
<span class="nc" id="L61">    fastCircleToGeom(new JtsPoint(p, spatialContext).getBuffered(degrees, spatialContext))</span>
  }

<span class="nc" id="L64">  val ST_MakeValid: Geometry =&gt; Geometry = nullableUDF(geom =&gt; {</span>
<span class="nc" id="L65">    val fix = new util.GeometryFixer(geom)</span>
<span class="nc" id="L66">    fix.getResult</span>
  })

<span class="nc" id="L69">  private[geomesa] val processingNames = Map(</span>
<span class="nc" id="L70">    ST_antimeridianSafeGeom -&gt; &quot;st_antimeridianSafeGeom&quot;,</span>
<span class="nc" id="L71">    ST_BufferPoint -&gt; &quot;st_bufferPoint&quot;,</span>
<span class="nc" id="L72">    ST_MakeValid -&gt; &quot;st_makeValid&quot;</span>
  )


  private[jts] def registerFunctions(sqlContext: SQLContext): Unit = {
<span class="nc" id="L77">    sqlContext.udf.register(processingNames(ST_antimeridianSafeGeom), ST_antimeridianSafeGeom)</span>
<span class="nc" id="L78">    sqlContext.udf.register(&quot;st_idlSafeGeom&quot;, ST_antimeridianSafeGeom)</span>
<span class="nc" id="L79">    sqlContext.udf.register(processingNames(ST_BufferPoint), ST_BufferPoint)</span>
<span class="nc" id="L80">    sqlContext.udf.register(processingNames(ST_MakeValid), ST_MakeValid)</span>
  }

<span class="nc" id="L83">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>