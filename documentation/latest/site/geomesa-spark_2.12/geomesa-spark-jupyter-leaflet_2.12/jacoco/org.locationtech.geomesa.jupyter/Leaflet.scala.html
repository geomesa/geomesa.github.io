<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Leaflet.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Jupyter Leaflet Extensions</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.jupyter</a> &gt; <span class="el_source">Leaflet.scala</span></div><h1>Leaflet.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.jupyter

<span class="nc" id="L11">object L {</span>
  import org.apache.commons.text.CharacterPredicates.ASCII_ALPHA_NUMERALS
  import org.apache.commons.text.{RandomStringGenerator, StringEscapeUtils}
  import org.apache.spark.sql._
  import org.geotools.api.feature.`type`.AttributeDescriptor
  import org.geotools.api.feature.simple.SimpleFeature
  import org.locationtech.geomesa.spark.sql.SparkUtils
  import org.locationtech.jts.geom._

  trait GeoRenderable {
    def render: String
  }

  trait Shape extends GeoRenderable

  trait StyleOption {
    def render: String
  }

<span class="nc bnc" id="L30" title="All 28 branches missed.">  case class StyleOptions(color: String = &quot;#000000&quot;, fillColor: String = &quot;#327A66&quot;, fillOpacity: Double = 0.75)</span>
<span class="nc" id="L31">    extends StyleOption {</span>
    def render: String =
<span class="nc" id="L33">      s&quot;&quot;&quot;</span>
         |{
<span class="nc" id="L35">         |  color: '$color',</span>
<span class="nc" id="L36">         |  fillColor: '$fillColor',</span>
<span class="nc" id="L37">         |  fillOpacity: '$fillOpacity'</span>
         |}
       &quot;&quot;&quot;.stripMargin
  }

  /**
    * Takes a string containing a valid javascript styling function as its argument
    * @param javascriptFunction The javascript styling function
    */
<span class="nc bnc" id="L46" title="All 18 branches missed.">  case class StyleOptionFunction(javascriptFunction: String) extends StyleOption {</span>
<span class="nc" id="L47">    def render: String = javascriptFunction</span>
  }


<span class="nc" id="L51">  private object OnFeatureClick {</span>
    def render: String =
<span class="nc" id="L53">      &quot;&quot;&quot;</span>
       |function onClick(e) {
       |  e.target.openPopup();
       |}
       |
       |function onFeature(feature, layer) {
       |  var keys = Object.keys(layer.feature.properties);
       |  var str = &quot;&quot;;
       |  for (var i in keys) {
       |    var key = keys[i];
       |    var prop = layer.feature.properties[key];
       |    str = str + &quot;&lt;b&gt;&quot; + key + &quot;&lt;/b&gt;: &quot; + prop;
       |    if (i &lt; keys.length - 1 ) str = str + &quot;&lt;br&gt;&quot;;
       |  }
       |  layer.bindPopup(str);
       |  layer.on({click: onClick});
       |}
     &quot;&quot;&quot;.stripMargin
  }

<span class="nc bnc" id="L73" title="All 21 branches missed.">  private case class PointToLayer(style: StyleOption, radius: Double = 5.0) {</span>
<span class="nc" id="L74">    val styleOptions = style.render</span>
    def render: String =
<span class="nc" id="L76">      s&quot;&quot;&quot;</span>
        |pointToLayer: function(feature, latlng) {
        |  return L.circleMarker(latlng, {
<span class="nc" id="L79">        |                                   radius: $radius,</span>
<span class="nc" id="L80">        |                                   ${styleOptions.replace(&quot;}&quot;, &quot;&quot;).replace(&quot;{&quot;, &quot;&quot;)}</span>
        |                                  });
        |}
      &quot;&quot;&quot;.stripMargin
  }

<span class="nc bnc" id="L86" title="All 61 branches missed.">  case class WMSLayer(layerName: String,</span>
<span class="nc" id="L87">                      style: String = &quot;&quot;,</span>
<span class="nc" id="L88">                      filter: String = &quot;INCLUDE&quot;,</span>
<span class="nc" id="L89">                      color: String = &quot;#FF0000&quot;,</span>
<span class="nc" id="L90">                      geoserverURL: String = &quot;/geoserver/wms&quot;,</span>
<span class="nc" id="L91">                      env: Map[String,String] = Map.empty[String,String],</span>
<span class="nc" id="L92">                      opacity: Double = 0.6,</span>
<span class="nc" id="L93">                      transparent: Boolean = true) extends GeoRenderable {</span>
    override def render: String =
<span class="nc" id="L95">      s&quot;&quot;&quot;</span>
<span class="nc" id="L96">         | L.WMS.source('$geoserverURL?',</span>
         |   {
<span class="nc" id="L98">         |      layers: '$layerName',</span>
<span class="nc" id="L99">         |      cql_filter: &quot;$filter&quot;,</span>
<span class="nc" id="L100">         |      styles: '$style',</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">         |      env: '${env.map { case (k, v) =&gt; Array(k, v).mkString(sep = &quot;=&quot;) }.mkString(sep = &quot;:&quot;)}',</span>
<span class="nc" id="L102">         |      transparent: '$transparent',</span>
<span class="nc" id="L103">         |      opacity: $opacity,</span>
         |      format: 'image/png',
         |      version: '1.1.1'
<span class="nc" id="L106">         |   }).getLayer('$layerName').addTo(map);</span>
         |
       &quot;&quot;&quot;.stripMargin
  }

  trait DataFrameLayer {
    def df: DataFrame
    def idField: String
    def style: StyleOption
  }

<span class="nc" id="L117">  trait SimpleFeatureLayer {</span>
<span class="nc" id="L118">    private val writer = new org.locationtech.jts.io.geojson.GeoJsonWriter()</span>
<span class="nc" id="L119">    writer.setEncodeCRS(false)</span>

    def features: Seq[SimpleFeature]
    def style: StyleOption

    def simpleFeatureToGeoJSON(sf: SimpleFeature) = {
      import scala.collection.JavaConverters._
<span class="nc" id="L126">      s&quot;&quot;&quot;</span>
         |{
         |    &quot;type&quot;: &quot;Feature&quot;,
         |    &quot;properties&quot;: {
<span class="nc" id="L130">         |        ${sf.getType.getAttributeDescriptors.asScala.zip(sf.getAttributes.asScala)</span>
<span class="nc bnc" id="L131" title="All 6 branches missed.">                      .filter{case(a,b) =&gt; b != null &amp;&amp; !b.isInstanceOf[Geometry]}</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                      .map { case (d, a) =&gt; propToJson(d, a) }.mkString(sep =&quot;,\n&quot;)</span>
<span class="nc" id="L133">                   }</span>
         |    },
<span class="nc" id="L135">         |    &quot;geometry&quot;: ${writer.write(sf.getDefaultGeometry.asInstanceOf[Geometry])}</span>
         |}
       &quot;&quot;&quot;.stripMargin

    }

    def propToJson(ad: AttributeDescriptor, a: Object) =
<span class="nc bnc" id="L142" title="All 2 branches missed.">      if(a!= null) s&quot;&quot;&quot;&quot;${ad.getLocalName}&quot;: &quot;${StringEscapeUtils.escapeJson(a.toString)}&quot;&quot;&quot;&quot;</span>
<span class="nc" id="L143">      else s&quot;&quot;&quot;&quot;${ad.getLocalName}&quot;: ''&quot;&quot;&quot;</span>
  }

<span class="nc bnc" id="L146" title="All 32 branches missed.">  case class DataFrameLayerNonPoint(df: DataFrame, idField: String, style: StyleOption)</span>
<span class="nc" id="L147">    extends GeoRenderable with DataFrameLayer {</span>
<span class="nc" id="L148">    private val dfc = df.collect() // expensive operation</span>
<span class="nc" id="L149">    private val sft = SparkUtils.createFeatureType(&quot;sft&quot;, df.schema)</span>
    // expensive map operation
<span class="nc" id="L151">    private val mappings = SparkUtils.rowsToFeatures(sft, df.schema).copy(id = r =&gt; r.getAs[String](idField))</span>
<span class="nc" id="L152">    private val sftSeq = dfc.map(mappings.apply).toSeq</span>
<span class="nc" id="L153">    private val sftLayer = SimpleFeatureLayerNonPoint(sftSeq, style)</span>
<span class="nc" id="L154">    override def render: String = sftLayer.render</span>
  }

<span class="nc bnc" id="L157" title="All 35 branches missed.">  case class DataFrameLayerPoint(df: DataFrame, idField: String, style: StyleOption, radius: Double = 5.0)</span>
<span class="nc" id="L158">    extends GeoRenderable with DataFrameLayer {</span>
<span class="nc" id="L159">    private val dfc = df.collect() // expensive operation</span>
<span class="nc" id="L160">    private val sft = SparkUtils.createFeatureType(&quot;sft&quot;, df.schema)</span>
    // expensive map operation
<span class="nc" id="L162">    private val mappings = SparkUtils.rowsToFeatures(sft, df.schema).copy(id = r =&gt; r.getAs[String](idField))</span>
<span class="nc" id="L163">    private val sftSeq = dfc.map(mappings.apply).toSeq</span>
<span class="nc" id="L164">    private val sftLayer = SimpleFeatureLayerPoint(sftSeq, style, radius)</span>
<span class="nc" id="L165">    override def render: String = sftLayer.render</span>
  }

<span class="nc bnc" id="L168" title="All 25 branches missed.">  case class SimpleFeatureLayerNonPoint(features: Seq[SimpleFeature], style: StyleOption)</span>
<span class="nc" id="L169">    extends GeoRenderable with SimpleFeatureLayer {</span>
    override def render: String =
<span class="nc" id="L171">      s&quot;&quot;&quot;{</span>
<span class="nc" id="L172">         |L.geoJson(${features.map(simpleFeatureToGeoJSON).mkString(&quot;[&quot;,&quot;,&quot;,&quot;]&quot;)},</span>
         |    {
         |      onEachFeature: onFeature,
<span class="nc" id="L175">         |      style: ${style.render}</span>
         |    }
         |).addTo(map);
         |
<span class="nc" id="L179">         |${OnFeatureClick.render};}</span>
       &quot;&quot;&quot;.stripMargin
  }

<span class="nc bnc" id="L183" title="All 28 branches missed.">  case class SimpleFeatureLayerPoint(features: Seq[SimpleFeature], style: StyleOption, radius: Double = 5.0)</span>
<span class="nc" id="L184">    extends GeoRenderable with SimpleFeatureLayer {</span>
    override def render: String =
<span class="nc" id="L186">      s&quot;&quot;&quot;{</span>
<span class="nc" id="L187">          |L.geoJson(${features.map(simpleFeatureToGeoJSON).mkString(&quot;[&quot;,&quot;,&quot;,&quot;]&quot;)},</span>
          |    {
          |      onEachFeature: onFeature,
<span class="nc" id="L190">          |      ${ PointToLayer(style, radius).render }</span>
          |    }
          |).addTo(map);
          |
<span class="nc" id="L194">         |${OnFeatureClick.render};}</span>
       &quot;&quot;&quot;.stripMargin
  }

<span class="nc bnc" id="L198" title="All 27 branches missed.">  case class Circle(cx: Double, cy: Double, radiusMeters: Double, style: StyleOption) extends GeoRenderable {</span>
    override def render: String =
<span class="nc" id="L200">      s&quot;&quot;&quot;</span>
<span class="nc" id="L201">         |L.circle([$cy, $cx], $radiusMeters, ${style.render}).addTo(map);</span>
       &quot;&quot;&quot;.stripMargin
  }

<span class="nc" id="L205">  implicit class JTSPolyLayer(style: StyleOption)(implicit val poly: Polygon) extends GeoRenderable {</span>
    override def render: String = {
<span class="nc" id="L207">      val coords = poly.getCoordinates.map { c =&gt; Array(c.y, c.x).mkString(&quot;[&quot;, &quot;,&quot;, &quot;]&quot;) }.mkString(&quot;[&quot;, &quot;,&quot;, &quot;]&quot;)</span>
<span class="nc" id="L208">      s&quot;L.polygon($coords, ${style.render} ).addTo(map);&quot;</span>
    }
  }

<span class="nc" id="L212">  implicit class JTSPointLayer(style: StyleOption)(implicit val point: Point) extends GeoRenderable {</span>
<span class="nc" id="L213">    override def render: String = s&quot;L.circle([${point.getY},${point.getX}], 5, , { ${style.render} }).addTo(map);&quot;</span>
  }

<span class="nc" id="L216">  implicit class JTSLineStringLayer(style: StyleOption)(implicit val ls: LineString) extends GeoRenderable {</span>
    override def render: String = {
<span class="nc" id="L218">      val coords = ls.getCoordinates.map { c =&gt; Array(c.y, c.x).mkString(&quot;[&quot;, &quot;,&quot;, &quot;]&quot;) }.mkString(&quot;[&quot;, &quot;,&quot;, &quot;]&quot;)</span>
<span class="nc" id="L219">      s&quot;L.polyline($coords, ${style.render} ).addTo(map);&quot;</span>
    }
  }

<span class="nc" id="L223">  val leafletCssCdn =</span>
<span class="nc" id="L224">    &quot;&quot;&quot;</span>
      |&lt;link rel=&quot;stylesheet&quot; href=&quot;https://unpkg.com/leaflet@1.5.1/dist/leaflet.css&quot;
      |  integrity=&quot;sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==&quot;
      |  crossorigin=&quot;&quot;/&gt;
    &quot;&quot;&quot;.stripMargin

<span class="nc" id="L230">  val leafletJsCdn =</span>
<span class="nc" id="L231">    &quot;&quot;&quot;</span>
      |&lt;script src=&quot;https://unpkg.com/leaflet@1.5.1/dist/leaflet.js&quot;
      |  integrity=&quot;sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==&quot;
      |  crossorigin=&quot;&quot;&gt;&lt;/script&gt;
    &quot;&quot;&quot;.stripMargin

<span class="nc" id="L237">  val leafletWmsJsCdn =</span>
<span class="nc" id="L238">    &quot;&quot;&quot;</span>
      |&lt;script src=&quot;https://unpkg.com/leaflet.wms@0.2.0/dist/leaflet.wms.js&quot;
      |  integrity=&quot;sha384-ixDRqhwaC8CiUqK6q3rR//gkxROH6Jo2ekssv8GY9ifDKsN53cvFhXof9rfb1Zhs&quot;
      |  crossorigin=&quot;&quot;&gt;&lt;/script&gt;
    &quot;&quot;&quot;.stripMargin

<span class="nc" id="L244">  def buildMap(layers: Seq[GeoRenderable], center: (Double, Double) = (0,0), zoom: Int = 8, path: Option[String] = None) = {</span>

<span class="nc" id="L246">    val leafletCss = path match {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">      case Some(p) =&gt; s&quot;&quot;&quot;&lt;link rel=&quot;stylesheet&quot; href=&quot;$p/leaflet.css&quot; /&gt;&quot;&quot;&quot;</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">      case None =&gt; leafletCssCdn</span>
    }

<span class="nc" id="L251">    val leafletJs = path match {</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">      case Some(p) =&gt; s&quot;&quot;&quot;&lt;script src=&quot;$p/leaflet.js&quot;&gt;&lt;/script&gt;&quot;&quot;&quot;</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">      case None =&gt; leafletJsCdn</span>
    }

<span class="nc" id="L256">    val leafletWmsJs = path match {</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">      case Some(p) =&gt; s&quot;&quot;&quot;&lt;script src=&quot;$p/leaflet.wms.js&quot;&gt;&lt;/script&gt;&quot;&quot;&quot;</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">      case None =&gt; leafletWmsJsCdn</span>
    }

<span class="nc" id="L261">    val countriesJs = path match {</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">      case Some(p) =&gt; s&quot;&quot;&quot;&lt;script src=&quot;$p/countries.geo.js&quot;&gt;&lt;/script&gt;&quot;&quot;&quot;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">      case None =&gt; &quot;&quot; // data not easily hosted anywhere</span>
    }

<span class="nc" id="L266">    s&quot;&quot;&quot;</span>
       |&lt;html&gt;
       |  &lt;head&gt;
<span class="nc" id="L269">       |    $leafletCss</span>
<span class="nc" id="L270">       |    $leafletJs</span>
<span class="nc" id="L271">       |    $leafletWmsJs</span>
<span class="nc" id="L272">       |    $countriesJs</span>
       |  &lt;/head&gt;
       |  &lt;body&gt;
       |    &lt;div id='map' style=&quot;width:100%;height:500px&quot;&gt;&lt;/div&gt;
       |    &lt;script&gt;
       |
       |      //'map' is the id of the map
       |      var map = L.map('map', {
       |        crs: L.CRS.EPSG4326,
<span class="nc" id="L281">       |        center: [${center._1}, ${center._2}],</span>
<span class="nc" id="L282">       |        zoom: ${zoom}</span>
       |      });
       |
       |      // Only add country boundaries if the geojson data loaded ok from the script
       |      if(typeof worldMap !== 'undefined') {
       |        // Initialize the Base Layer... Loaded from GeoJson
       |        var basestyle = {&quot;color&quot;: &quot;#717171&quot;, &quot;weight&quot;: 2, &quot;opacity&quot;: 1.0};
       |        var base = L.geoJson(worldMap, basestyle);
       |        map.addLayer(base);
       |      }
       |
<span class="nc" id="L293">       |      ${layers.map(_.render).mkString(sep = &quot;\n&quot;)}</span>
       |
       |    &lt;/script&gt;
       |  &lt;/body&gt;
       |&lt;/html&gt;
     &quot;&quot;&quot;.stripMargin
  }

<span class="nc" id="L301">  def render(layers: Seq[GeoRenderable], center: (Double, Double) = (0,0), zoom: Int = 8, path: Option[String] = None) = {</span>
<span class="nc" id="L302">    val id = new RandomStringGenerator.Builder().withinRange('0', 'z').filteredBy(ASCII_ALPHA_NUMERALS).build().generate(5)</span>
<span class="nc" id="L303">    s&quot;&quot;&quot;</span>
<span class="nc" id="L304">       |&lt;iframe id=&quot;${id}&quot; sandbox=&quot;allow-scripts allow-same-origin&quot; style=&quot;border:none;width:100%;height:520px&quot; srcdoc=&quot;${xml.Utility.escape(buildMap(layers, center, zoom, path))}&quot;&gt;&lt;/iframe&gt;</span>
       |&lt;script&gt;
       |  if(typeof resizeIFrame != 'function') {
       |    function resizeIFrame(el, k) {
       |      el.style.height = el.contentWindow.document.body.scrollHeight + 'px';
       |      el.style.width = '100%';
       |      if(k&lt;=3) { setTimeout(function() { resizeIFrame(el, k+1)}, 1000) };
       |    }
       |  }
       |  $$().ready(function() {
<span class="nc" id="L314">       |    resizeIFrame($$('#$id').get(0), 1);</span>
       |  });
       |&lt;/script&gt;
     &quot;&quot;&quot;.stripMargin
  }

<span class="nc" id="L320">  def show(layers: Seq[GeoRenderable], center: (Double, Double) = (0,0), zoom: Int = 1, path: Option[String] = None)(implicit disp: String =&gt; Unit) = disp(render(layers,center,zoom,path))</span>

<span class="nc" id="L322">  def print(layers: Seq[GeoRenderable], center: (Double, Double) = (0,0), zoom: Int = 1, path: Option[String] = None) = println(buildMap(layers,center,zoom,path))</span>
<span class="nc" id="L323">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>