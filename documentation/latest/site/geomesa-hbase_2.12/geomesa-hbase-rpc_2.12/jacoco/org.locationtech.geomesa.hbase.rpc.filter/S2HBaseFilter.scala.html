<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>S2HBaseFilter.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa HBase RPC</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.hbase.rpc.filter</a> &gt; <span class="el_source">S2HBaseFilter.scala</span></div><h1>S2HBaseFilter.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.hbase.rpc.filter

import com.github.benmanes.caffeine.cache.{CacheLoader, Caffeine}
import com.typesafe.scalalogging.StrictLogging
import org.apache.hadoop.hbase.Cell
import org.apache.hadoop.hbase.exceptions.DeserializationException
import org.apache.hadoop.hbase.filter.{Filter, FilterBase}
import org.locationtech.geomesa.index.filters.S2Filter
import org.locationtech.geomesa.utils.index.ByteArrays

/**
  * @author sunyabo 2019年07月31日 10:31
  * @version V1.0
  */
<span class="nc" id="L23">class S2HBaseFilter(filter: S2Filter, offset: Int, bytes: Array[Byte]) extends FilterBase {</span>
  override def filterKeyValue(v: Cell): Filter.ReturnCode = {
<span class="nc bnc" id="L25" title="All 2 branches missed.">    if (filter.inBounds(v.getRowArray, v.getRowOffset + offset)) {</span>
<span class="nc" id="L26">      Filter.ReturnCode.INCLUDE</span>
    } else {
<span class="nc" id="L28">      Filter.ReturnCode.SKIP</span>
    }
  }

<span class="nc" id="L32">  override def toByteArray: Array[Byte] = bytes</span>

<span class="nc" id="L34">  override def toString: String = s&quot;S2HBaseFilter[$filter]&quot;</span>
}

<span class="nc" id="L37">object S2HBaseFilter extends StrictLogging {</span>

  import org.locationtech.geomesa.index.FilterCacheSize

<span class="nc" id="L41">  val Priority = 20</span>

<span class="nc" id="L43">  private val cache = Caffeine.newBuilder().maximumSize(FilterCacheSize.toInt.get).build(</span>
<span class="nc" id="L44">    new CacheLoader[ByteArrayCacheKey, (S2Filter, Int)]() {</span>
      override def load(key: ByteArrayCacheKey): (S2Filter, Int) = {
<span class="nc" id="L46">        val filter = S2Filter.deserializeFromBytes(key.bytes)</span>
<span class="nc" id="L47">        val offset = ByteArrays.readInt(key.bytes, key.bytes.length - 4)</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">        logger.trace(s&quot;Deserialized $offset:$filter&quot;)</span>
<span class="nc" id="L49">        (filter, offset)</span>
      }
    }
  )

  /**
    * Create a new filter. Typically, filters created by this method will just be serialized to bytes and sent
    * as part of an HBase scan
    *
    * @param filter z2 filter
    * @param offset row offset
    * @return
    */
  def apply(filter: S2Filter, offset: Int): S2HBaseFilter = {
<span class="nc" id="L63">    val filterBytes = S2Filter.serializeToBytes(filter)</span>
<span class="nc" id="L64">    val serialized = Array.ofDim[Byte](filterBytes.length + 4)</span>
<span class="nc" id="L65">    System.arraycopy(filterBytes, 0, serialized, 0, filterBytes.length)</span>
<span class="nc" id="L66">    ByteArrays.writeInt(offset, serialized, filterBytes.length)</span>
<span class="nc" id="L67">    new S2HBaseFilter(filter, offset, serialized)</span>
  }

  /**
    * Override of static method from org.apache.hadoop.hbase.filter.Filter
    *
    * @param pbBytes serialized bytes
    * @throws org.apache.hadoop.hbase.exceptions.DeserializationException serialization exception
    * @return
    */
  @throws[DeserializationException]
  def parseFrom(pbBytes: Array[Byte]): Filter = {
<span class="nc bnc" id="L79" title="All 2 branches missed.">    val (filter, offset) = cache.get(new ByteArrayCacheKey(pbBytes))</span>
<span class="nc" id="L80">    new S2HBaseFilter(filter, offset, pbBytes)</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>