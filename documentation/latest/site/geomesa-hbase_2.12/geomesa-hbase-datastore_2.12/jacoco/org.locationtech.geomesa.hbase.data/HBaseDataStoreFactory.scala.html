<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HBaseDataStoreFactory.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa HBase DataStore</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.hbase.data</a> &gt; <span class="el_source">HBaseDataStoreFactory.scala</span></div><h1>HBaseDataStoreFactory.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.hbase.data

import com.typesafe.scalalogging.LazyLogging
import org.apache.hadoop.fs.Path
import org.apache.hadoop.hbase.HBaseConfiguration
import org.apache.hadoop.hbase.client.Connection
import org.apache.hadoop.hbase.security.visibility.VisibilityClient
import org.apache.hadoop.security.UserGroupInformation
import org.geotools.api.data.DataAccessFactory.Param
import org.geotools.api.data.{DataStore, DataStoreFactorySpi}
import org.locationtech.geomesa.hbase.data.HBaseDataStore.NoAuthsProvider
import org.locationtech.geomesa.hbase.data.HBaseDataStoreFactory.{CoprocessorConfig, EnabledCoprocessors, HBaseDataStoreConfig, HBaseQueryConfig}
import org.locationtech.geomesa.index.audit.AuditWriter
import org.locationtech.geomesa.index.audit.AuditWriter.AuditLogger
import org.locationtech.geomesa.index.geotools.GeoMesaDataStore
import org.locationtech.geomesa.index.geotools.GeoMesaDataStoreFactory.{DataStoreQueryConfig, GeoMesaDataStoreConfig, GeoMesaDataStoreInfo, MetricsConfig}
import org.locationtech.geomesa.security.{AuthUtils, AuthorizationsProvider}
import org.locationtech.geomesa.utils.audit.AuditProvider
import org.locationtech.geomesa.utils.geotools.GeoMesaParam

import java.awt.RenderingHints

<span class="nc bnc" id="L31" title="All 4 branches missed.">class HBaseDataStoreFactory extends DataStoreFactorySpi with LazyLogging {</span>

  import HBaseDataStoreParams._

  // this is a pass-through required of the ancestor interface
<span class="nc" id="L36">  override def createNewDataStore(params: java.util.Map[String, _]): DataStore = createDataStore(params)</span>

<span class="nc" id="L38">  override def createDataStore(params: java.util.Map[String, _]): DataStore = {</span>
<span class="nc" id="L39">    val connection = HBaseConnectionPool.getConnection(params, validateConnection)</span>

<span class="nc" id="L41">    val remoteFilters = RemoteFilteringParam.lookup(params).booleanValue</span>

<span class="nc bnc" id="L43" title="All 2 branches missed.">    val audit = if (!AuditQueriesParam.lookup(params)) { None } else {</span>
<span class="nc" id="L44">      Some(new AuditLogger(&quot;hbase&quot;, AuditProvider.Loader.loadOrNone(params)))</span>
    }
<span class="nc" id="L46">    val metrics = MetricsRegistryParam.lookupRegistry(params)</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">    val auths = if (!EnableSecurityParam.lookup(params)) { NoAuthsProvider } else {</span>
<span class="nc" id="L48">      HBaseDataStoreFactory.buildAuthsProvider(connection.connection, params)</span>
    }
<span class="nc" id="L50">    val queries = HBaseQueryConfig(</span>
<span class="nc" id="L51">      threads = QueryThreadsParam.lookup(params),</span>
<span class="nc" id="L52">      timeout = QueryTimeoutParam.lookupOpt(params).map(_.toMillis),</span>
<span class="nc" id="L53">      looseBBox = LooseBBoxParam.lookup(params),</span>
<span class="nc" id="L54">      parallelPartitionScans = PartitionParallelScansParam.lookup(params),</span>
<span class="nc" id="L55">      maxRangesPerExtendedScan = MaxRangesPerExtendedScanParam.lookup(params)</span>
    )
<span class="nc" id="L57">    val enabledCoprocessors = EnabledCoprocessors(</span>
<span class="nc" id="L58">      arrow = ArrowCoprocessorParam.lookup(params),</span>
<span class="nc" id="L59">      bin = BinCoprocessorParam.lookup(params),</span>
<span class="nc" id="L60">      density = DensityCoprocessorParam.lookup(params),</span>
<span class="nc" id="L61">      stats = StatsCoprocessorParam.lookup(params)</span>
    )
<span class="nc" id="L63">    val coprocessors = CoprocessorConfig(</span>
<span class="nc" id="L64">      enabled = enabledCoprocessors,</span>
<span class="nc" id="L65">      threads = CoprocessorThreadsParam.lookup(params),</span>
<span class="nc" id="L66">      yieldPartialResults = YieldPartialResultsParam.lookup(params),</span>
<span class="nc" id="L67">      maxRangesPerExtendedScan = MaxRangesPerCoprocessorScanParam.lookup(params),</span>
<span class="nc" id="L68">      url = CoprocessorUrlParam.lookupOpt(params)</span>
    )
<span class="nc" id="L70">    val config = HBaseDataStoreConfig(</span>
<span class="nc" id="L71">      catalog = HBaseCatalogParam.lookup(params),</span>
<span class="nc" id="L72">      remoteFilter = remoteFilters,</span>
<span class="nc" id="L73">      generateStats = GenerateStatsParam.lookup(params),</span>
<span class="nc" id="L74">      queries = queries,</span>
<span class="nc" id="L75">      coprocessors = coprocessors,</span>
<span class="nc" id="L76">      authProvider = auths,</span>
<span class="nc" id="L77">      audit = audit,</span>
<span class="nc" id="L78">      metrics = metrics,</span>
<span class="nc" id="L79">      namespace = NamespaceParam.lookupOpt(params)</span>
    )

<span class="nc bnc" id="L82" title="All 4 branches missed.">    logger.debug(s&quot;Using ${if (remoteFilters) &quot;remote&quot; else &quot;local&quot; } filtering&quot;)</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">    lazy val enabled =</span>
<span class="nc" id="L84">      Seq(ArrowCoprocessorParam, BinCoprocessorParam, DensityCoprocessorParam, StatsCoprocessorParam).collect {</span>
<span class="nc bnc" id="L85" title="All 8 branches missed.">        case p if p.exists(params) &amp;&amp; p.lookup(params).booleanValue() =&gt; p.key</span>
      }
<span class="nc bnc" id="L87" title="All 4 branches missed.">    if (!remoteFilters &amp;&amp; enabled.nonEmpty) {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">      logger.warn(s&quot;Ignoring configs '${enabled.mkString(&quot;', '&quot;)}' due to remote filtering being disabled&quot;)</span>
    }

<span class="nc" id="L91">    val ds = new HBaseDataStore(connection, config)</span>
<span class="nc" id="L92">    GeoMesaDataStore.initRemoteVersion(ds)</span>
<span class="nc" id="L93">    ds</span>
  }

<span class="nc" id="L96">  protected def validateConnection: Boolean = true</span>

<span class="nc" id="L98">  override def isAvailable = true</span>

<span class="nc" id="L100">  override def getDisplayName: String = HBaseDataStoreFactory.DisplayName</span>

<span class="nc" id="L102">  override def getDescription: String = HBaseDataStoreFactory.Description</span>

<span class="nc" id="L104">  override def getParametersInfo: Array[Param] = Array(HBaseDataStoreFactory.ParameterInfo :+ NamespaceParam: _*)</span>

  override def canProcess(params: java.util.Map[String, _]): Boolean =
<span class="nc" id="L107">    HBaseDataStoreFactory.canProcess(params)</span>

<span class="nc" id="L109">  override def getImplementationHints: java.util.Map[RenderingHints.Key, _] = null</span>
}

<span class="nc bnc" id="L112" title="All 4 branches missed.">object HBaseDataStoreFactory extends GeoMesaDataStoreInfo with LazyLogging {</span>

  import HBaseDataStoreParams._

  import scala.collection.JavaConverters._

<span class="nc" id="L118">  val HBaseGeoMesaPrincipal = &quot;hbase.geomesa.principal&quot;</span>
<span class="nc" id="L119">  val HBaseGeoMesaKeyTab    = &quot;hbase.geomesa.keytab&quot;</span>

<span class="nc" id="L121">  override val DisplayName = &quot;HBase (GeoMesa)&quot;</span>
<span class="nc" id="L122">  override val Description = &quot;Apache HBase\u2122 distributed key/value store&quot;</span>

<span class="nc" id="L124">  override val ParameterInfo: Array[GeoMesaParam[_ &lt;: AnyRef]] =</span>
<span class="nc" id="L125">    Array(</span>
<span class="nc" id="L126">      HBaseCatalogParam,</span>
<span class="nc" id="L127">      ZookeeperParam,</span>
<span class="nc" id="L128">      ConfigPathsParam,</span>
<span class="nc" id="L129">      ConfigsParam,</span>
<span class="nc" id="L130">      CoprocessorUrlParam,</span>
<span class="nc" id="L131">      QueryThreadsParam,</span>
<span class="nc" id="L132">      CoprocessorThreadsParam,</span>
<span class="nc" id="L133">      QueryTimeoutParam,</span>
<span class="nc" id="L134">      MaxRangesPerExtendedScanParam,</span>
<span class="nc" id="L135">      MaxRangesPerCoprocessorScanParam,</span>
<span class="nc" id="L136">      CacheConnectionsParam,</span>
<span class="nc" id="L137">      RemoteFilteringParam,</span>
<span class="nc" id="L138">      ArrowCoprocessorParam,</span>
<span class="nc" id="L139">      BinCoprocessorParam,</span>
<span class="nc" id="L140">      DensityCoprocessorParam,</span>
<span class="nc" id="L141">      StatsCoprocessorParam,</span>
<span class="nc" id="L142">      YieldPartialResultsParam,</span>
<span class="nc" id="L143">      EnableSecurityParam,</span>
<span class="nc" id="L144">      GenerateStatsParam,</span>
<span class="nc" id="L145">      AuditQueriesParam,</span>
<span class="nc" id="L146">      MetricsRegistryParam,</span>
<span class="nc" id="L147">      MetricsRegistryConfigParam,</span>
<span class="nc" id="L148">      LooseBBoxParam,</span>
<span class="nc" id="L149">      PartitionParallelScansParam,</span>
<span class="nc" id="L150">      AuthsParam,</span>
<span class="nc" id="L151">      AuthProviderParam,</span>
<span class="nc" id="L152">      ForceEmptyAuthsParam</span>
    )

<span class="nc" id="L155">  private [geomesa] val BigTableParamCheck = &quot;google.bigtable.instance.id&quot;</span>

  // check that the hbase-site.xml does not have bigtable keys
  override def canProcess(params: java.util.Map[String, _]): Boolean = {
<span class="nc bnc" id="L159" title="All 2 branches missed.">    HBaseCatalogParam.exists(params) &amp;&amp;</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        Option(HBaseConfiguration.create().get(BigTableParamCheck)).forall(_.trim.isEmpty)</span>
  }

<span class="nc bnc" id="L163" title="All 70 branches missed.">  case class HBaseDataStoreConfig(</span>
<span class="nc" id="L164">      catalog: String,</span>
<span class="nc" id="L165">      remoteFilter: Boolean,</span>
<span class="nc" id="L166">      generateStats: Boolean,</span>
<span class="nc" id="L167">      queries: HBaseQueryConfig,</span>
<span class="nc" id="L168">      coprocessors: CoprocessorConfig,</span>
<span class="nc" id="L169">      authProvider: AuthorizationsProvider,</span>
<span class="nc" id="L170">      audit: Option[AuditWriter],</span>
<span class="nc" id="L171">      metrics: Option[MetricsConfig],</span>
<span class="nc" id="L172">      namespace: Option[String]</span>
<span class="nc" id="L173">    ) extends GeoMesaDataStoreConfig</span>

<span class="nc bnc" id="L175" title="All 34 branches missed.">  case class HBaseQueryConfig(</span>
<span class="nc" id="L176">      threads: Int,</span>
<span class="nc" id="L177">      timeout: Option[Long],</span>
<span class="nc" id="L178">      looseBBox: Boolean,</span>
<span class="nc" id="L179">      parallelPartitionScans: Boolean,</span>
<span class="nc" id="L180">      maxRangesPerExtendedScan: Int</span>
<span class="nc" id="L181">    ) extends DataStoreQueryConfig</span>

<span class="nc bnc" id="L183" title="All 36 branches missed.">  case class CoprocessorConfig(</span>
<span class="nc" id="L184">      enabled: EnabledCoprocessors,</span>
<span class="nc" id="L185">      threads: Int,</span>
<span class="nc" id="L186">      yieldPartialResults: Boolean,</span>
<span class="nc" id="L187">      maxRangesPerExtendedScan: Int,</span>
<span class="nc" id="L188">      url: Option[Path]</span>
    )

<span class="nc bnc" id="L191" title="All 31 branches missed.">  case class EnabledCoprocessors(arrow: Boolean, bin: Boolean, density: Boolean, stats: Boolean)</span>

  def buildAuthsProvider(connection: Connection, params: java.util.Map[String, _]): AuthorizationsProvider = {
<span class="nc" id="L194">    val forceEmptyOpt: Option[java.lang.Boolean] = ForceEmptyAuthsParam.lookupOpt(params)</span>
<span class="nc" id="L195">    val forceEmptyAuths = forceEmptyOpt.getOrElse(java.lang.Boolean.FALSE).asInstanceOf[Boolean]</span>

<span class="nc bnc" id="L197" title="All 2 branches missed.">    if (!VisibilityClient.isCellVisibilityEnabled(connection)) {</span>
<span class="nc" id="L198">      throw new IllegalArgumentException(&quot;HBase cell visibility is not enabled on cluster&quot;)</span>
    }

    // master auths is the superset of auths this connector/user can support
<span class="nc" id="L202">    val userName = UserGroupInformation.getLoginUser.getUserName</span>
<span class="nc" id="L203">    val masterAuths = VisibilityClient.getAuths(connection, userName).getAuthList.asScala.map(_.toStringUtf8)</span>

    // get the auth params passed in as a comma-delimited string
<span class="nc" id="L206">    val configuredAuths = AuthsParam.lookupOpt(params).getOrElse(&quot;&quot;).split(&quot;,&quot;).filterNot(_.isEmpty)</span>

    // verify that the configured auths are valid for the connector we are using (fail-fast)
<span class="nc" id="L209">    val invalidAuths = configuredAuths.filterNot(masterAuths.contains)</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">    if (invalidAuths.nonEmpty) {</span>
<span class="nc" id="L211">      val msg = s&quot;The authorizations '${invalidAuths.mkString(&quot;', '&quot;)}' are not valid for the HBase user '$userName'&quot;</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">      if (masterAuths.isEmpty) {</span>
        // looking up auths requires a system-level user - likely the user does not have permission
<span class="nc bnc" id="L214" title="All 2 branches missed.">        logger.warn(s&quot;$msg. This may be due to the user not having permissions&quot; +</span>
<span class="nc" id="L215">            &quot; to read its own authorizations, in which case this warning can be ignored.&quot;)</span>
      } else {
<span class="nc" id="L217">        throw new IllegalArgumentException(s&quot;$msg. Available authorizations are: ${masterAuths.mkString(&quot;, &quot;)}&quot;)</span>
      }
    }

    // if the caller provided any non-null string for authorizations, use it;
    // otherwise, grab all authorizations to which the user is entitled
<span class="nc bnc" id="L223" title="All 4 branches missed.">    if (configuredAuths.length != 0 &amp;&amp; forceEmptyAuths) {</span>
<span class="nc" id="L224">      throw new IllegalArgumentException(&quot;Forcing empty auths is checked, but explicit auths are provided&quot;)</span>
    }
<span class="nc bnc" id="L226" title="All 4 branches missed.">    val auths = if (forceEmptyAuths || configuredAuths.nonEmpty) { configuredAuths.toList } else { masterAuths.toList }</span>

<span class="nc" id="L228">    AuthUtils.getProvider(params, auths)</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>