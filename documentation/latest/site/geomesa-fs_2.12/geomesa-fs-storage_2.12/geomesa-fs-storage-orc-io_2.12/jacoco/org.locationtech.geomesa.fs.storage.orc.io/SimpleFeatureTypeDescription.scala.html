<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SimpleFeatureTypeDescription.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa FileSystem Storage ORC IO</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.fs.storage.orc.io</a> &gt; <span class="el_source">SimpleFeatureTypeDescription.scala</span></div><h1>SimpleFeatureTypeDescription.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.fs.storage.orc.io

import org.apache.orc.TypeDescription
import org.geotools.api.feature.`type`.AttributeDescriptor
import org.geotools.api.feature.simple.SimpleFeatureType
import org.locationtech.geomesa.utils.geotools.ObjectType
import org.locationtech.geomesa.utils.geotools.ObjectType.ObjectType
import org.locationtech.jts.geom.Geometry

<span class="nc" id="L18">object SimpleFeatureTypeDescription {</span>

  import scala.collection.JavaConverters._

<span class="nc" id="L22">  def geometryXField(attribute: String): String = s&quot;${attribute}_x&quot;</span>
<span class="nc" id="L23">  def geometryYField(attribute: String): String = s&quot;${attribute}_y&quot;</span>

  /**
   * Gets a count of the Orc fields created for a simple feature type.
   *
   * Geometry attributes create 2 columns, other attributes create 1, feature id creates 1
   *
   * @param sft simple feature type
   * @param fid include feature ids or not
   * @return
   */
<span class="nc" id="L34">  def fieldCount(sft: SimpleFeatureType, fid: Boolean = true): Int = {</span>
<span class="nc bnc" id="L35" title="All 2 branches missed.">    val attributes = sft.getAttributeDescriptors.asScala.foldLeft(0) { case (sum, d) =&gt; sum + fieldCount(d) }</span>
<span class="nc bnc" id="L36" title="All 2 branches missed.">    if (fid) { attributes + 1 } else { attributes }</span>
  }

  /**
   * Gets a count of the Orc fields created for a given attribute
   *
   * @param descriptor descriptor
   * @return
   */
  def fieldCount(descriptor: AttributeDescriptor): Int = {
<span class="nc" id="L46">    descriptor.getType.getBinding match {</span>
      // plain Geometry bindings are encoded in a single WKB column, others as x + y
<span class="nc bnc" id="L48" title="All 8 branches missed.">      case b if classOf[Geometry].isAssignableFrom(b) &amp;&amp; b != classOf[Geometry] =&gt; 2</span>
<span class="nc" id="L49">      case _ =&gt; 1</span>
    }
  }

  /**
   * Create the Orc type description corresponding to the SimpleFeatureType. SimpleFeatureType is
   * modeled as an Orc Struct, with nested fields for each attribute.
   *
   * @param sft simple feature type
   * @return
   */
<span class="nc" id="L60">  def apply(sft: SimpleFeatureType, fid: Boolean = true): TypeDescription = {</span>
<span class="nc" id="L61">    val container = TypeDescription.createStruct()</span>
<span class="nc" id="L62">    var i = 0</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">    while (i &lt; sft.getAttributeCount) {</span>
<span class="nc" id="L64">      addTypeDescription(container, sft.getDescriptor(i))</span>
<span class="nc" id="L65">      i += 1</span>
    }
<span class="nc bnc" id="L67" title="All 2 branches missed.">    if (fid) {</span>
<span class="nc" id="L68">      container.addField(&quot;id&quot;, TypeDescription.createString())</span>
    }
<span class="nc" id="L70">    container</span>
  }

  /**
   * Add a type description for an attribute
   *
   * @param container top-level Orc struct corresponding to the SimpleFeatureType
   * @param descriptor descriptor
   */
  private def addTypeDescription(container: TypeDescription, descriptor: AttributeDescriptor): Unit = {
<span class="nc" id="L80">    val name = descriptor.getLocalName</span>
<span class="nc" id="L81">    val bindings = ObjectType.selectType(descriptor)</span>
<span class="nc" id="L82">    bindings.head match {</span>
<span class="nc bnc" id="L83" title="All 6 branches missed.">      case ObjectType.GEOMETRY =&gt; addGeometryDescription(container, name, bindings(1))</span>
<span class="nc bnc" id="L84" title="All 6 branches missed.">      case ObjectType.LIST     =&gt; container.addField(name, TypeDescription.createList(simple(bindings(1))))</span>
<span class="nc bnc" id="L85" title="All 6 branches missed.">      case ObjectType.MAP      =&gt; container.addField(name, TypeDescription.createMap(simple(bindings(1)), simple(bindings(2))))</span>
<span class="nc" id="L86">      case binding             =&gt; container.addField(name, simple(binding))</span>
    }
  }

  /**
   * We create two separate fields, one for x-values and one for y-values. Orc doesn't support
   * predicate push-down on nested fields, so we flatten them out. Note that Orc also doesn't
   * support predicate push-down for complex fields, so we actually only benefit for Points.
   */
  private def addGeometryDescription(container: TypeDescription, name: String, binding: ObjectType): Unit = {
    import TypeDescription.{createDouble, createList}

<span class="nc" id="L98">    def x: String = geometryXField(name)</span>
<span class="nc" id="L99">    def y: String = geometryYField(name)</span>

<span class="nc" id="L101">    binding match {</span>
<span class="nc bnc" id="L102" title="All 6 branches missed.">      case ObjectType.POINT =&gt;</span>
        // point (x, y) pair
<span class="nc" id="L104">        container.addField(x, createDouble())</span>
<span class="nc" id="L105">        container.addField(y, createDouble())</span>

<span class="nc bnc" id="L107" title="All 6 branches missed.">      case ObjectType.LINESTRING =&gt;</span>
        // list of points
<span class="nc" id="L109">        container.addField(x, createList(createDouble()))</span>
<span class="nc" id="L110">        container.addField(y, createList(createDouble()))</span>

<span class="nc bnc" id="L112" title="All 6 branches missed.">      case ObjectType.MULTIPOINT =&gt;</span>
        // list of points
<span class="nc" id="L114">        container.addField(x, createList(createDouble()))</span>
<span class="nc" id="L115">        container.addField(y, createList(createDouble()))</span>

<span class="nc bnc" id="L117" title="All 6 branches missed.">      case ObjectType.POLYGON =&gt;</span>
        // list of lines (exterior ring + any holes)
<span class="nc" id="L119">        container.addField(x, createList(createList(createDouble())))</span>
<span class="nc" id="L120">        container.addField(y, createList(createList(createDouble())))</span>

<span class="nc bnc" id="L122" title="All 6 branches missed.">      case ObjectType.MULTILINESTRING =&gt;</span>
        // list of lines
<span class="nc" id="L124">        container.addField(x, createList(createList(createDouble())))</span>
<span class="nc" id="L125">        container.addField(y, createList(createList(createDouble())))</span>

<span class="nc bnc" id="L127" title="All 6 branches missed.">      case ObjectType.MULTIPOLYGON =&gt;</span>
        // list of polygons
<span class="nc" id="L129">        container.addField(x, createList(createList(createList(createDouble()))))</span>
<span class="nc" id="L130">        container.addField(y, createList(createList(createList(createDouble()))))</span>

<span class="nc bnc" id="L132" title="All 6 branches missed.">      case ObjectType.GEOMETRY =&gt;</span>
        // WKB
<span class="nc" id="L134">        container.addField(name, TypeDescription.createBinary())</span>

<span class="nc" id="L136">      case _ =&gt; throw new IllegalArgumentException(s&quot;Unexpected geometry type $binding&quot;)</span>
    }
  }

  /**
   * Type description for simple types, e.g. int, float, date, etc
   *
   * @param binding type binding
   * @return
   */
  private def simple(binding: ObjectType): TypeDescription = {
<span class="nc" id="L147">    binding match {</span>
<span class="nc bnc" id="L148" title="All 6 branches missed.">      case ObjectType.DATE    =&gt; TypeDescription.createTimestamp()</span>
<span class="nc bnc" id="L149" title="All 6 branches missed.">      case ObjectType.STRING  =&gt; TypeDescription.createString()</span>
<span class="nc bnc" id="L150" title="All 6 branches missed.">      case ObjectType.INT     =&gt; TypeDescription.createInt()</span>
<span class="nc bnc" id="L151" title="All 6 branches missed.">      case ObjectType.LONG    =&gt; TypeDescription.createLong()</span>
<span class="nc bnc" id="L152" title="All 6 branches missed.">      case ObjectType.FLOAT   =&gt; TypeDescription.createFloat()</span>
<span class="nc bnc" id="L153" title="All 6 branches missed.">      case ObjectType.DOUBLE  =&gt; TypeDescription.createDouble()</span>
<span class="nc bnc" id="L154" title="All 6 branches missed.">      case ObjectType.BOOLEAN =&gt; TypeDescription.createBoolean()</span>
<span class="nc bnc" id="L155" title="All 6 branches missed.">      case ObjectType.BYTES   =&gt; TypeDescription.createBinary()</span>
<span class="nc bnc" id="L156" title="All 6 branches missed.">      case ObjectType.UUID    =&gt; TypeDescription.createString()</span>
<span class="nc" id="L157">      case _ =&gt; throw new IllegalArgumentException(s&quot;Unexpected simple object type $binding&quot;)</span>
    }
  }
<span class="nc" id="L160">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>