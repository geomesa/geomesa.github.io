<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TruncateTopic.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Kafka Datastore</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.kafka.data</a> &gt; <span class="el_source">TruncateTopic.scala</span></div><h1>TruncateTopic.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.kafka.data

import com.typesafe.scalalogging.LazyLogging
import org.apache.kafka.clients.admin._
import org.apache.kafka.common.TopicPartition
import org.apache.kafka.common.config.{ConfigResource, TopicConfig}

import java.util.Collections
import scala.collection.JavaConverters._

<span class="nc bnc" id="L19" title="All 4 branches missed.">object TruncateTopic extends LazyLogging {</span>

  /**
   * Truncation of a Kafka topic
   *
   * @param admin admin
   * @param topic the topic name to truncate
   */
  def apply(admin: Admin, topic: String): Unit = {
<span class="nc" id="L28">    val deleteCleanupPolicy = hasDeleteCleanupPolicy(admin, topic)</span>
<span class="nc" id="L29">    val latestRecords = getRecordsToDelete(admin, topic)</span>
    try {
<span class="nc bnc" id="L31" title="All 2 branches missed.">      if (!deleteCleanupPolicy) {</span>
<span class="nc bnc" id="L32" title="All 2 branches missed.">        logger.debug(s&quot;Adding 'delete' cleanup policy to topic $topic so it can be truncated&quot;)</span>
<span class="nc" id="L33">        alterDeleteCleanupPolicy(admin, topic, AlterConfigOp.OpType.APPEND)</span>
      }
<span class="nc bnc" id="L35" title="All 2 branches missed.">      logger.debug(s&quot;Starting truncate of topic $topic&quot;)</span>
<span class="nc" id="L36">      admin.deleteRecords(latestRecords.asJava).all().get()</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">      logger.debug(s&quot;Completed truncate of topic $topic&quot;)</span>
    } finally {
<span class="nc bnc" id="L39" title="All 2 branches missed.">      if (!deleteCleanupPolicy) {</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">        logger.debug(s&quot;Removing 'delete' cleanup policy to topic $topic&quot;)</span>
<span class="nc" id="L41">        alterDeleteCleanupPolicy(admin, topic, AlterConfigOp.OpType.SUBTRACT)</span>
      }
    }
  }

  /**
   * Get the latest offsets for a topic, by partition
   */
  private def getRecordsToDelete(admin: Admin, topic: String): Map[TopicPartition, RecordsToDelete] = {
<span class="nc" id="L50">    val topicInfo = admin.describeTopics(Collections.singleton(topic)).topicNameValues().get(topic).get()</span>
<span class="nc" id="L51">    val partitions = topicInfo.partitions().asScala.map(info =&gt; new TopicPartition(topic, info.partition()) -&gt; OffsetSpec.latest())</span>
<span class="nc" id="L52">    val offsets = admin.listOffsets(partitions.toMap.asJava).all().get().asScala.toMap</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">    offsets.map { case (tp, info) =&gt; tp -&gt; RecordsToDelete.beforeOffset(info.offset()) }</span>
  }

  /**
   * Check if the topic has the 'delete' cleanup policy.
   */
  private def hasDeleteCleanupPolicy(admin: Admin, topicName: String): Boolean = {
<span class="nc" id="L60">    val configResource = new ConfigResource(ConfigResource.Type.TOPIC, topicName)</span>
<span class="nc" id="L61">    val configsResult = admin.describeConfigs(Collections.singleton(configResource))</span>
<span class="nc" id="L62">    val config = configsResult.values().get(configResource).get()</span>
<span class="nc" id="L63">    config.get(TopicConfig.CLEANUP_POLICY_CONFIG).value().contains(TopicConfig.CLEANUP_POLICY_DELETE)</span>
  }

  /**
   * Alter the 'delete' cleanup policy in the topic's 'cleanup.policy' config
   */
  private def alterDeleteCleanupPolicy(admin: Admin, topic: String, op: AlterConfigOp.OpType): Unit = {
<span class="nc" id="L70">    val configResource = new ConfigResource(ConfigResource.Type.TOPIC, topic)</span>
<span class="nc" id="L71">    val alterConfigOp = new AlterConfigOp(new ConfigEntry(TopicConfig.CLEANUP_POLICY_CONFIG, TopicConfig.CLEANUP_POLICY_DELETE), op)</span>
<span class="nc" id="L72">    admin.incrementalAlterConfigs(java.util.Map.of(configResource, Collections.singleton(alterConfigOp))).all().get()</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>