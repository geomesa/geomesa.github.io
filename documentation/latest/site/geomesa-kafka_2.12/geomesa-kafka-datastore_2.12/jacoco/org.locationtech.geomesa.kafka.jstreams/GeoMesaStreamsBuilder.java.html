<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GeoMesaStreamsBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Kafka Datastore</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.kafka.jstreams</a> &gt; <span class="el_source">GeoMesaStreamsBuilder.java</span></div><h1>GeoMesaStreamsBuilder.java</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.kafka.jstreams;

import org.apache.kafka.common.serialization.Serde;
import org.apache.kafka.common.utils.Bytes;
import org.apache.kafka.streams.StreamsBuilder;
import org.apache.kafka.streams.Topology;
import org.apache.kafka.streams.Topology.AutoOffsetReset;
import org.apache.kafka.streams.kstream.GlobalKTable;
import org.apache.kafka.streams.kstream.KStream;
import org.apache.kafka.streams.kstream.KTable;
import org.apache.kafka.streams.kstream.Materialized;
import org.apache.kafka.streams.processor.TimestampExtractor;
import org.apache.kafka.streams.state.KeyValueStore;
import org.locationtech.geomesa.kafka.streams.GeoMesaMessage;

import java.util.Map;

/**
 * Wrapper for a kafka streams builder that will configure serialization based on a GeoMesa Kafka feature store
 */
public class GeoMesaStreamsBuilder {

    private final org.locationtech.geomesa.kafka.streams.GeoMesaStreamsBuilder sBuilder;
    private final StreamsBuilder wrapped;

<span class="fc" id="L34">    private GeoMesaStreamsBuilder(org.locationtech.geomesa.kafka.streams.GeoMesaStreamsBuilder sBuilder, StreamsBuilder wrapped) {</span>
<span class="fc" id="L35">        this.sBuilder = sBuilder;</span>
<span class="fc" id="L36">        this.wrapped = wrapped;</span>
<span class="fc" id="L37">    }</span>

    /**
     * Create a streams builder
     *
     * @param params data store parameters
     */
    public static GeoMesaStreamsBuilder create(Map&lt;String, String&gt; params) {
<span class="fc" id="L45">        return create(params, null, null, null);</span>
    }

    /**
     * Create a streams builder
     *
     * @param params         data store parameters
     * @param streamsBuilder underlying streams builder to use
     */
    public static GeoMesaStreamsBuilder create(
          Map&lt;String, String&gt; params,
          StreamsBuilder streamsBuilder) {
<span class="nc" id="L57">        return create(params, null, null, streamsBuilder);</span>
    }

    /**
     * Create a streams builder
     *
     * @param params             data store parameters
     * @param timestampExtractor timestamp extractor for message stream
     */
    public static GeoMesaStreamsBuilder create(
          Map&lt;String, String&gt; params,
          TimestampExtractor timestampExtractor) {
<span class="nc" id="L69">        return create(params, timestampExtractor, null, null);</span>
    }

    /**
     * Create a streams builder
     *
     * @param params             data store parameters
     * @param timestampExtractor timestamp extractor for message stream
     * @param streamsBuilder     underlying streams builder to use
     */
    public static GeoMesaStreamsBuilder create(
          Map&lt;String, String&gt; params,
          TimestampExtractor timestampExtractor,
          StreamsBuilder streamsBuilder) {
<span class="nc" id="L83">        return create(params, timestampExtractor, null, streamsBuilder);</span>
    }

    /**
     * Create a streams builder
     *
     * @param params      data store parameters
     * @param resetPolicy auto offset reset for reading existing topics
     */
    public static GeoMesaStreamsBuilder create(
          Map&lt;String, String&gt; params,
          AutoOffsetReset resetPolicy) {
<span class="nc" id="L95">        return create(params, null, resetPolicy, null);</span>
    }

    /**
     * Create a streams builder
     *
     * @param params         data store parameters
     * @param resetPolicy    auto offset reset for reading existing topics
     * @param streamsBuilder underlying streams builder to use
     */
    public static GeoMesaStreamsBuilder create(
          Map&lt;String, String&gt; params,
          AutoOffsetReset resetPolicy,
          StreamsBuilder streamsBuilder) {
<span class="nc" id="L109">        return create(params, null, resetPolicy, streamsBuilder);</span>
    }

    /**
     * Create a streams builder
     *
     * @param params             data store parameters
     * @param timestampExtractor timestamp extractor for message stream
     * @param resetPolicy        auto offset reset for reading existing topics
     */
    public static GeoMesaStreamsBuilder create(
          Map&lt;String, String&gt; params,
          TimestampExtractor timestampExtractor,
          AutoOffsetReset resetPolicy) {
<span class="nc" id="L123">        return create(params, timestampExtractor, resetPolicy, null);</span>
    }

    /**
     * Create a streams builder
     *
     * @param params             data store parameters
     * @param timestampExtractor timestamp extractor for message stream
     * @param resetPolicy        auto offset reset for reading existing topics
     * @param streamsBuilder     underlying streams builder to use
     */
    public static GeoMesaStreamsBuilder create(
          Map&lt;String, String&gt; params,
          TimestampExtractor timestampExtractor,
          AutoOffsetReset resetPolicy,
          StreamsBuilder streamsBuilder) {
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">        if (streamsBuilder == null) {</span>
<span class="fc" id="L140">            streamsBuilder = new StreamsBuilder();</span>
        }
<span class="fc" id="L142">        org.apache.kafka.streams.scala.StreamsBuilder scalaBuilder =</span>
              new org.apache.kafka.streams.scala.StreamsBuilder(streamsBuilder);
<span class="fc" id="L144">        org.locationtech.geomesa.kafka.streams.GeoMesaStreamsBuilder sbuilder =</span>
<span class="fc" id="L145">              org.locationtech.geomesa.kafka.streams.GeoMesaStreamsBuilder.apply(params, timestampExtractor, resetPolicy, scalaBuilder);</span>
<span class="fc" id="L146">        return new GeoMesaStreamsBuilder(sbuilder, streamsBuilder);</span>
    }

    /**
     * Create a stream of updates for a given feature type
     *
     * @param typeName feature type name
     */
    public KStream&lt;String, GeoMesaMessage&gt; stream(String typeName) {
<span class="fc" id="L155">        return sBuilder.stream(typeName).inner();</span>
    }

    /**
     * Create a table for a given feature type
     *
     * @param typeName feature type name
     */
    public KTable&lt;String, GeoMesaMessage&gt; table(String typeName) {
<span class="nc" id="L164">        return sBuilder.table(typeName).inner();</span>
    }

    /**
     * Create a table for a given feature type
     *
     * @param typeName     feature type name
     * @param materialized materialized
     */
    public KTable&lt;String, GeoMesaMessage&gt; table(
          String typeName,
          Materialized&lt;String, GeoMesaMessage, KeyValueStore&lt;Bytes, byte[]&gt;&gt; materialized) {
<span class="nc" id="L176">        return sBuilder.table(typeName, materialized).inner();</span>
    }

    /**
     * Create a global table for a given feature type
     *
     * @param typeName feature type name
     */
    public GlobalKTable&lt;String, GeoMesaMessage&gt; globalTable(String typeName) {
<span class="nc" id="L185">        return sBuilder.globalTable(typeName);</span>
    }

    /**
     * Create a global table for a given feature type
     *
     * @param typeName     feature type name
     * @param materialized materialized
     */
    public GlobalKTable&lt;String, GeoMesaMessage&gt; globalTable(
          String typeName,
          Materialized&lt;String, GeoMesaMessage, KeyValueStore&lt;Bytes, byte[]&gt;&gt; materialized) {
<span class="nc" id="L197">        return sBuilder.globalTable(typeName, materialized);</span>
    }

    /**
     * Write the stream to the given feature type, which must already exist. The messages
     * must conform to the feature type schema
     *
     * @param typeName feature type name
     * @param stream   stream to persist
     */
    public void to(String typeName, KStream&lt;String, GeoMesaMessage&gt; stream) {
<span class="fc" id="L208">        sBuilder.to(typeName, new org.apache.kafka.streams.scala.kstream.KStream&lt;&gt;(stream));</span>
<span class="fc" id="L209">    }</span>

    /**
     * Convenience method to build the underlying topology
     */
<span class="fc" id="L214">    public Topology build() { return sBuilder.build(); }</span>

    /**
     * Get the underlying streams builder
     *
     * @return the builder
     */
    public StreamsBuilder wrapped() {
<span class="fc" id="L222">        return this.wrapped;</span>
    }

    /**
     * Get the `GeoMesaMessage` serde for the given feature type
     *
     * @param typeName feature type name
     * @return the serde
     */
    public Serde&lt;GeoMesaMessage&gt; serde(String typeName) {
<span class="nc" id="L232">        return sBuilder.serde(typeName);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>