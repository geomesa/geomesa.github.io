<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CassandraColumnMapper.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Cassandra DataStore</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.cassandra.index</a> &gt; <span class="el_source">CassandraColumnMapper.scala</span></div><h1>CassandraColumnMapper.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2017-2025 IBM
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.cassandra.index

import com.datastax.driver.core.{PreparedStatement, Session}
import org.locationtech.geomesa.cassandra.{NamedColumn, RowSelect}
import org.locationtech.geomesa.index.api._
import org.locationtech.geomesa.index.index.attribute.AttributeIndex
import org.locationtech.geomesa.index.index.id.IdIndex
import org.locationtech.geomesa.index.index.z2.{XZ2Index, Z2Index}
import org.locationtech.geomesa.index.index.z3.{XZ3Index, Z3Index}

import java.nio.ByteBuffer

<span class="nc" id="L22">object CassandraColumnMapper {</span>

  import org.locationtech.geomesa.utils.geotools.RichSimpleFeatureType.RichSimpleFeatureType

<span class="nc" id="L26">  val FeatureIdColumnName = &quot;fid&quot;</span>
<span class="nc" id="L27">  val SimpleFeatureColumnName = &quot;sf&quot;</span>

<span class="nc" id="L29">  val ShardColumn = NamedColumn(&quot;shard&quot;, 0, &quot;tinyint&quot;, classOf[Byte], partition = true)</span>

<span class="nc" id="L31">  def binColumn(i: Int): NamedColumn = NamedColumn(&quot;period&quot;, i, &quot;smallint&quot;, classOf[Short], partition = true)</span>
<span class="nc" id="L32">  def zColumn(i: Int): NamedColumn = NamedColumn(&quot;z&quot;, i, &quot;bigint&quot;, classOf[Long])</span>

<span class="nc" id="L34">  def featureIdColumn(i: Int): NamedColumn = NamedColumn(FeatureIdColumnName, i, &quot;text&quot;, classOf[String])</span>
<span class="nc" id="L35">  def featureColumn(i: Int): NamedColumn = NamedColumn(SimpleFeatureColumnName, i, &quot;blob&quot;, classOf[ByteBuffer])</span>

  def apply(index: GeoMesaFeatureIndex[_, _]): CassandraColumnMapper = {
<span class="nc" id="L38">    index.name match {</span>
<span class="nc bnc" id="L39" title="All 6 branches missed.">      case IdIndex.name                             =&gt; IdColumnMapper(index.sft)</span>
<span class="nc bnc" id="L40" title="All 14 branches missed.">      case Z3Index.name | XZ3Index.name             =&gt; Z3ColumnMapper(index.sft.getZ3Shards)</span>
<span class="nc bnc" id="L41" title="All 14 branches missed.">      case Z2Index.name | XZ2Index.name             =&gt; Z2ColumnMapper(index.sft.getZ2Shards)</span>
<span class="nc bnc" id="L42" title="All 8 branches missed.">      case AttributeIndex.name if index.version &gt; 7 =&gt; AttributeColumnMapper(index.sft.getAttributeShards)</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">      case AttributeIndex.name                      =&gt; SharedAttributeColumnMapper</span>
<span class="nc" id="L44">      case _ =&gt; throw new IllegalArgumentException(s&quot;Unexpected index: ${index.identifier}&quot;)</span>
    }
  }
}

<span class="nc" id="L49">trait CassandraColumnMapper {</span>

  import CassandraColumnMapper.SimpleFeatureColumnName

  def columns: Seq[NamedColumn]
  def bind(value: SingleRowKeyValue[_]): Seq[AnyRef]
  def bindDelete(value: SingleRowKeyValue[_]): Seq[AnyRef]

  def select(range: ScanRange[_], tieredKeyRanges: Seq[ByteRange]): Seq[RowSelect]

  def insert(session: Session, table: String): PreparedStatement = {
<span class="nc" id="L60">    val cql = s&quot;INSERT INTO $table (${columns.map(_.name).mkString(&quot;, &quot;)}) &quot; +</span>
<span class="nc" id="L61">        s&quot;values (${Seq.fill(columns.length)(&quot;?&quot;).mkString(&quot;, &quot;)})&quot;</span>
<span class="nc" id="L62">    session.prepare(cql)</span>
  }

  def delete(session: Session, table: String): PreparedStatement = {
<span class="nc bnc" id="L66" title="All 12 branches missed.">    val cols = columns.collect { case c if c.name != SimpleFeatureColumnName =&gt; c.name }</span>
<span class="nc" id="L67">    val cql = s&quot;DELETE FROM $table WHERE ${cols.mkString(&quot;&quot;, &quot; = ? and &quot;, &quot; = ?&quot;)}&quot;</span>
<span class="nc" id="L68">    session.prepare(cql)</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>