<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WriteAheadTable.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa GeoTools Postgis Partitioning</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.gt.partition.postgis.dialect.tables</a> &gt; <span class="el_source">WriteAheadTable.scala</span></div><h1>WriteAheadTable.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.gt.partition.postgis.dialect
package tables

/**
 * Write ahead log, partitioned using inheritance to avoid any restraints on data overlap between partitions.
 * All writes get directed to the main partition, which is identified with the suffix `_writes`. Every 10 minutes,
 * the current writes partition is renamed based on a sequence number, and a new writes partition is created
 */
<span class="nc" id="L17">object WriteAheadTable extends SqlStatements {</span>

  override protected def createStatements(info: TypeInfo): Seq[String] = {
<span class="nc" id="L20">    val table = info.tables.writeAhead</span>
<span class="nc bnc" id="L21" title="All 2 branches missed.">    val (tableTs, indexTs) = table.tablespace match {</span>
<span class="nc bnc" id="L22" title="All 2 branches missed.">      case None =&gt; (&quot;&quot;, &quot;&quot;)</span>
<span class="nc bnc" id="L23" title="All 2 branches missed.">      case Some(ts) =&gt; (s&quot; TABLESPACE ${ts.quoted}&quot;, s&quot; USING INDEX TABLESPACE ${ts.quoted}&quot;)</span>
    }
<span class="nc bnc" id="L25" title="All 2 branches missed.">    val logging = if (info.tables.writeAhead.logged) { &quot;&quot; } else { &quot;UNLOGGED&quot; }</span>
<span class="nc" id="L26">    val move = table.tablespace.toSeq.map { ts =&gt;</span>
<span class="nc" id="L27">      s&quot;ALTER TABLE ${table.name.qualified} SET TABLESPACE ${ts.quoted};\n&quot;</span>
    }
    val block =
<span class="nc" id="L30">      s&quot;&quot;&quot;DO $$$$</span>
         |DECLARE
         |  seq_val smallint;
         |  partition text;
         |BEGIN
<span class="nc" id="L35">         |  SELECT value from ${info.schema.quoted}.${SequenceTable.Name.quoted}</span>
<span class="nc" id="L36">         |    WHERE type_name = ${literal(info.typeName)} INTO seq_val;</span>
<span class="nc" id="L37">         |  partition := ${literal(table.name.raw + &quot;_&quot;)} || lpad(seq_val::text, 3, '0');</span>
         |
<span class="nc" id="L39">         |  EXECUTE 'CREATE $logging TABLE IF NOT EXISTS ${info.schema.quoted}.' || quote_ident(partition) || '(' ||</span>
         |    'CONSTRAINT ' || quote_ident(partition || '_pkey') ||
<span class="nc" id="L41">         |    ' PRIMARY KEY (fid, ${info.cols.dtg.quoted})$indexTs ' ||</span>
<span class="nc" id="L42">         |    ') INHERITS (${table.name.qualified})${table.storage.opts}$tableTs';</span>
<span class="nc" id="L43">         |  EXECUTE 'CREATE INDEX IF NOT EXISTS ' || quote_ident(partition || '_' || ${info.cols.dtg.asLiteral}) ||</span>
<span class="nc" id="L44">         |    ' ON ${info.schema.quoted}.' || quote_ident(partition) || ' (${info.cols.dtg.quoted})$tableTs';</span>
<span class="nc" id="L45">         |${info.cols.geoms.map { col =&gt;</span>
<span class="nc" id="L46">      s&quot;&quot;&quot;  EXECUTE 'CREATE INDEX IF NOT EXISTS ' || quote_ident(partition || '_spatial_' || ${col.asLiteral}) ||</span>
<span class="nc" id="L47">         |    ' ON ${info.schema.quoted}.' || quote_ident(partition) || ' USING gist(${col.quoted})$tableTs';&quot;&quot;&quot;.stripMargin}.mkString(&quot;\n&quot;)}</span>
<span class="nc" id="L48">         |${info.cols.indexed.map { col =&gt;</span>
<span class="nc" id="L49">      s&quot;&quot;&quot;  EXECUTE 'CREATE INDEX IF NOT EXISTS ' || quote_ident(partition || '_' || ${col.asLiteral}) ||</span>
<span class="nc" id="L50">         |    ' ON ${info.schema.quoted}.' || quote_ident(partition) || '(${col.quoted})$tableTs';&quot;&quot;&quot;.stripMargin}.mkString(&quot;\n&quot;)}</span>
         |END $$$$;&quot;&quot;&quot;.stripMargin

<span class="nc" id="L53">    move ++ Seq(block)</span>
  }

  override protected def dropStatements(info: TypeInfo): Seq[String] = {
<span class="nc" id="L57">    Seq(</span>
<span class="nc" id="L58">      s&quot;DROP TABLE IF EXISTS ${info.tables.writeAhead.name.qualified};&quot;, // note: actually gets dropped by jdbc store</span>
<span class="nc" id="L59">      s&quot;DROP SEQUENCE IF EXISTS ${escape(info.tables.writeAhead.name.raw, &quot;seq&quot;)};&quot;</span>
    )
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>