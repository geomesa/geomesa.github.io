<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GeoMesaDataStoreFactory.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Index API</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.index.geotools</a> &gt; <span class="el_source">GeoMesaDataStoreFactory.scala</span></div><h1>GeoMesaDataStoreFactory.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.index.geotools

import com.typesafe.config.Config
import org.locationtech.geomesa.index.PartitionParallelScan
import org.locationtech.geomesa.index.audit.AuditWriter
import org.locationtech.geomesa.index.conf.{QueryProperties, StatsProperties}
import org.locationtech.geomesa.metrics.micrometer.RegistryFactory
import org.locationtech.geomesa.metrics.micrometer.cloudwatch.CloudwatchFactory
import org.locationtech.geomesa.metrics.micrometer.prometheus.PrometheusFactory
import org.locationtech.geomesa.security.{AuthorizationsProvider, SecurityParams}
import org.locationtech.geomesa.utils.geotools.GeoMesaParam
import org.locationtech.geomesa.utils.geotools.GeoMesaParam._

import java.io.Closeable
import java.util.concurrent.TimeUnit
import scala.concurrent.duration.Duration

<span class="nc" id="L26">object GeoMesaDataStoreFactory {</span>

<span class="nc" id="L28">  private val GenerateStatsSysParam = SystemPropertyBooleanParam(StatsProperties.GenerateStats)</span>
<span class="nc" id="L29">  private val QueryThreadsSysParam = SystemPropertyIntegerParam(QueryProperties.QueryThreads)</span>
<span class="nc" id="L30">  private val TimeoutSysParam = SystemPropertyDurationParam(QueryProperties.QueryTimeout)</span>
<span class="nc" id="L31">  private val PartitionParallelScanSysParam = SystemPropertyBooleanParam(PartitionParallelScan)</span>

<span class="nc" id="L33">  private val DeprecatedTimeout =</span>
<span class="nc" id="L34">    ConvertedParam[Duration, java.lang.Long](&quot;queryTimeout&quot;, v =&gt; Duration(v, TimeUnit.SECONDS))</span>
<span class="nc" id="L35">  private val DeprecatedAccumuloTimeout =</span>
<span class="nc" id="L36">    ConvertedParam[Duration, java.lang.Long](&quot;accumulo.queryTimeout&quot;, v =&gt; Duration(v, TimeUnit.SECONDS))</span>

<span class="nc" id="L38">  val QueryThreadsParam =</span>
<span class="nc" id="L39">    new GeoMesaParam[Integer](</span>
<span class="nc" id="L40">      &quot;geomesa.query.threads&quot;,</span>
<span class="nc" id="L41">      &quot;The number of threads to use per query&quot;,</span>
<span class="nc" id="L42">      default = Int.box(8),</span>
<span class="nc" id="L43">      deprecatedKeys = Seq(&quot;queryThreads&quot;, &quot;accumulo.queryThreads&quot;),</span>
<span class="nc" id="L44">      systemProperty = Some(QueryThreadsSysParam),</span>
<span class="nc" id="L45">      supportsNiFiExpressions = true,</span>
<span class="nc" id="L46">      readWrite = ReadWriteFlag.ReadUpdate</span>
    )

<span class="nc" id="L49">  val QueryTimeoutParam =</span>
<span class="nc" id="L50">    new GeoMesaParam[Duration](</span>
<span class="nc" id="L51">      &quot;geomesa.query.timeout&quot;,</span>
<span class="nc" id="L52">      &quot;The max time a query will be allowed to run before being killed, e.g. '60 seconds'&quot;,</span>
<span class="nc" id="L53">      deprecatedParams = Seq(DeprecatedTimeout, DeprecatedAccumuloTimeout),</span>
<span class="nc" id="L54">      systemProperty = Some(TimeoutSysParam),</span>
<span class="nc" id="L55">      supportsNiFiExpressions = true,</span>
<span class="nc" id="L56">      readWrite = ReadWriteFlag.ReadUpdate</span>
    )

<span class="nc" id="L59">  val LooseBBoxParam =</span>
<span class="nc" id="L60">    new GeoMesaParam[java.lang.Boolean](</span>
<span class="nc" id="L61">      &quot;geomesa.query.loose-bounding-box&quot;,</span>
<span class="nc" id="L62">      &quot;Use loose bounding boxes - queries will be faster but may return extraneous results&quot;,</span>
<span class="nc" id="L63">      default = true,</span>
<span class="nc" id="L64">      deprecatedKeys = Seq(&quot;looseBoundingBox&quot;),</span>
<span class="nc" id="L65">      readWrite = ReadWriteFlag.ReadUpdate</span>
    )

<span class="nc" id="L68">  val StrictBBoxParam =</span>
<span class="nc" id="L69">    new GeoMesaParam[java.lang.Boolean](</span>
<span class="nc" id="L70">      &quot;geomesa.query.loose-bounding-box&quot;,</span>
<span class="nc" id="L71">      &quot;Use loose bounding boxes - queries will be faster but may return extraneous results&quot;,</span>
<span class="nc" id="L72">      default = false,</span>
<span class="nc" id="L73">      deprecatedKeys = Seq(&quot;looseBoundingBox&quot;),</span>
<span class="nc" id="L74">      readWrite = ReadWriteFlag.ReadUpdate</span>
    )

<span class="nc" id="L77">  val AuditQueriesParam =</span>
<span class="nc" id="L78">    new GeoMesaParam[java.lang.Boolean](</span>
<span class="nc" id="L79">      &quot;geomesa.query.audit&quot;,</span>
<span class="nc" id="L80">      &quot;Audit queries being run&quot;,</span>
<span class="nc" id="L81">      default = true,</span>
<span class="nc" id="L82">      deprecatedKeys = Seq(&quot;auditQueries&quot;, &quot;collectQueryStats&quot;),</span>
<span class="nc" id="L83">      readWrite = ReadWriteFlag.ReadUpdate</span>
    )

<span class="nc" id="L86">  val MetricsRegistryParam = new MetricsRegistryParam()</span>

<span class="nc" id="L88">  val MetricsRegistryConfigParam =</span>
<span class="nc" id="L89">    new GeoMesaParam[Config](</span>
<span class="nc" id="L90">      &quot;geomesa.metrics.registry.config&quot;,</span>
<span class="nc" id="L91">      &quot;Customize the configuration passed to `geomesa.metrics.registry`&quot;,</span>
<span class="nc" id="L92">      largeText = true,</span>
    )

<span class="nc" id="L95">  val GenerateStatsParam =</span>
<span class="nc" id="L96">    new GeoMesaParam[java.lang.Boolean](</span>
<span class="nc" id="L97">      &quot;geomesa.stats.enable&quot;,</span>
<span class="nc" id="L98">      &quot;Generate and persist data statistics for new feature types&quot;,</span>
<span class="nc" id="L99">      default = true,</span>
<span class="nc" id="L100">      deprecatedKeys = Seq(&quot;generateStats&quot;),</span>
<span class="nc" id="L101">      systemProperty = Some(GenerateStatsSysParam),</span>
<span class="nc" id="L102">      readWrite = ReadWriteFlag.WriteOnly</span>
    )

<span class="nc" id="L105">  val PartitionParallelScansParam =</span>
<span class="nc" id="L106">    new GeoMesaParam[java.lang.Boolean](</span>
<span class="nc" id="L107">      &quot;geomesa.partition.scan.parallel&quot;,</span>
<span class="nc" id="L108">      &quot;Run scans in parallel for partitioned stores&quot;,</span>
<span class="nc" id="L109">      default = false,</span>
<span class="nc" id="L110">      systemProperty = Some(PartitionParallelScanSysParam),</span>
<span class="nc" id="L111">      readWrite = ReadWriteFlag.ReadOnly</span>
    )

<span class="nc" id="L114">  val NamespaceParam = new GeoMesaParam[String](&quot;namespace&quot;, &quot;Namespace&quot;)</span>

  trait NamespaceConfig {
    def namespace: Option[String]
    def catalog: String
  }

  trait GeoMesaDataStoreConfig extends NamespaceConfig {
    def authProvider: AuthorizationsProvider
    def audit: Option[AuditWriter]
    def generateStats: Boolean
    def queries: DataStoreQueryConfig
    def metrics: Option[MetricsConfig]
  }

  /**
   * Holder for a registry and optional config
   *
   * @param registry registry
   * @param conf registry conf
   */
<span class="nc bnc" id="L135" title="All 25 branches missed.">  case class MetricsConfig(registry: RegistryFactory, conf: Option[Config]) {</span>

    /**
     * Register with the given registry
     *
     * @return
     */
<span class="nc" id="L142">    def register(): Closeable = conf match {</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">      case None    =&gt; registry.register()</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">      case Some(c) =&gt; registry.register(c)</span>
    }
  }

  trait DataStoreQueryConfig {
    def threads: Int
    def timeout: Option[Long]
    def looseBBox: Boolean
    def parallelPartitionScans: Boolean
  }

  // noinspection TypeAnnotation
<span class="nc" id="L156">  trait NamespaceParams {</span>
<span class="nc" id="L157">    val NamespaceParam = GeoMesaDataStoreFactory.NamespaceParam</span>
  }

  // noinspection TypeAnnotation
<span class="nc" id="L161">  trait GeoMesaDataStoreParams extends SecurityParams with NamespaceParams {</span>

<span class="nc" id="L163">    protected def looseBBoxDefault = true</span>

<span class="nc" id="L165">    val AuditQueriesParam           = GeoMesaDataStoreFactory.AuditQueriesParam</span>
<span class="nc" id="L166">    val MetricsRegistryParam        = GeoMesaDataStoreFactory.MetricsRegistryParam</span>
<span class="nc" id="L167">    val MetricsRegistryConfigParam  = GeoMesaDataStoreFactory.MetricsRegistryConfigParam</span>
<span class="nc" id="L168">    val GenerateStatsParam          = GeoMesaDataStoreFactory.GenerateStatsParam</span>
<span class="nc" id="L169">    val QueryThreadsParam           = GeoMesaDataStoreFactory.QueryThreadsParam</span>
<span class="nc" id="L170">    val QueryTimeoutParam           = GeoMesaDataStoreFactory.QueryTimeoutParam</span>
<span class="nc" id="L171">    val PartitionParallelScansParam = GeoMesaDataStoreFactory.PartitionParallelScansParam</span>

<span class="nc" id="L173">    val LooseBBoxParam =</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">      if (looseBBoxDefault) { GeoMesaDataStoreFactory.LooseBBoxParam } else { GeoMesaDataStoreFactory.StrictBBoxParam }</span>
  }

  trait GeoMesaDataStoreInfo {
    def DisplayName: String
    def Description: String
    def ParameterInfo: Array[GeoMesaParam[_ &lt;: AnyRef]]
    def canProcess(params: java.util.Map[String, _]): Boolean
  }

<span class="nc" id="L184">  class MetricsRegistryParam extends</span>
<span class="nc" id="L185">      GeoMesaParam[String](</span>
<span class="nc" id="L186">        &quot;geomesa.metrics.registry&quot;,</span>
<span class="nc" id="L187">        &quot;Specify the type of registry used to publish metrics. See &quot; +</span>
          &quot;https://www.geomesa.org/documentation/stable/user/appendix/metrics.html&quot;,
<span class="nc" id="L189">        default = &quot;none&quot;,</span>
<span class="nc" id="L190">        enumerations = Seq(&quot;none&quot;, RegistryFactory.Prometheus, RegistryFactory.Cloudwatch),</span>
      ) {

    /**
     * Get the registry
     *
     * @param params params
     * @return
     */
    def lookupRegistry(params: java.util.Map[String, _]): Option[MetricsConfig] = {
<span class="nc" id="L200">      val registry = lookup(params) match {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">        case &quot;none&quot; =&gt; None</span>
<span class="nc bnc" id="L202" title="All 6 branches missed.">        case RegistryFactory.Prometheus =&gt; Some(PrometheusFactory)</span>
<span class="nc bnc" id="L203" title="All 6 branches missed.">        case RegistryFactory.Cloudwatch =&gt; Some(CloudwatchFactory)</span>
<span class="nc" id="L204">        case r =&gt; throw new IllegalArgumentException(s&quot;Unknown registry type, expected one of 'none', 'prometheus' or 'cloudwatch': $r&quot;)</span>
      }
<span class="nc" id="L206">      registry.map(r =&gt; MetricsConfig(r, GeoMesaDataStoreFactory.MetricsRegistryConfigParam.lookupOpt(params)))</span>
    }
  }
<span class="nc" id="L209">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>