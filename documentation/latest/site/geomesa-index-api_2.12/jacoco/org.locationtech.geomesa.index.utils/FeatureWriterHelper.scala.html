<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FeatureWriterHelper.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Index API</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.index.utils</a> &gt; <span class="el_source">FeatureWriterHelper.scala</span></div><h1>FeatureWriterHelper.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.index.utils

import org.geotools.api.data.FeatureWriter
import org.geotools.api.feature.simple.{SimpleFeature, SimpleFeatureType}
import org.geotools.util.factory.Hints
import org.locationtech.geomesa.index.geotools.FastSettableFeatureWriter
import org.locationtech.geomesa.utils.geotools.FeatureUtils
import org.locationtech.geomesa.utils.geotools.converters.FastConverter

/**
 * Helper for simplifying the logic around writing to a GeoTools feature writer
 */
trait FeatureWriterHelper {

  /**
   * Write a feature to the underlying feature writer
   *
   * @param sf feature to write
   * @return feature that was written
   */
  def write(sf: SimpleFeature): SimpleFeature
}

<span class="nc" id="L32">object FeatureWriterHelper {</span>

  /**
   * Gets a feature writer helper
   *
   * @param writer feature writer
   * @param useProvidedFids use fids from the input features - not necessary if provided fid hints are already set
   */
<span class="nc" id="L40">  def apply(writer: FeatureWriter[SimpleFeatureType, SimpleFeature], useProvidedFids: Boolean = false): FeatureWriterHelper = {</span>
<span class="nc" id="L41">    writer match {</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">      case w: FastSettableFeatureWriter =&gt; new FastHelper(w, useProvidedFids)</span>
<span class="nc" id="L43">      case _ =&gt; new UnoptimizedHelper(writer, useProvidedFids)</span>
    }
  }

  /**
   * Helper class to populate a feature writer in an optimized way - avoids repeated lookups of the attribute type
   * bindings.
   *
   * @param writer writer
   * @param useProvidedFid use fids from the input feature - not necessary if provided fid hints are already set
   */
<span class="nc" id="L54">  private class FastHelper(writer: FastSettableFeatureWriter, useProvidedFid: Boolean) extends FeatureWriterHelper {</span>

    import scala.collection.JavaConverters._

<span class="nc" id="L58">    private val bindings =</span>
<span class="nc" id="L59">      writer.getFeatureType.getAttributeDescriptors.asScala.map(_.getType.getBinding.asInstanceOf[Class[AnyRef]]).toArray</span>

    override def write(sf: SimpleFeature): SimpleFeature = {
<span class="nc" id="L62">      val next = writer.next()</span>
<span class="nc" id="L63">      var i = 0</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">      while (i &lt; bindings.length) {</span>
<span class="nc" id="L65">        next.setAttributeNoConvert(i, FastConverter.convert(sf.getAttribute(i), bindings(i)))</span>
<span class="nc" id="L66">        i += 1</span>
      }
<span class="nc" id="L68">      next.getUserData.putAll(sf.getUserData)</span>
<span class="nc" id="L69">      next.setId(sf.getID)</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">      if (useProvidedFid) {</span>
<span class="nc" id="L71">        next.getUserData.put(Hints.USE_PROVIDED_FID, java.lang.Boolean.TRUE)</span>
      }
<span class="nc" id="L73">      writer.write()</span>
<span class="nc" id="L74">      next</span>
    }
  }

  /**
   * Unoptimized helper implementation, for non-geomesa writers
   *
   * @param writer writer
   * @param useProvidedFids use fids from the input feature - not necessary if provided fid hints are already set
   */
<span class="nc" id="L84">  private class UnoptimizedHelper(writer: FeatureWriter[SimpleFeatureType, SimpleFeature], useProvidedFids: Boolean)</span>
<span class="nc" id="L85">      extends FeatureWriterHelper {</span>
<span class="nc" id="L86">    override def write(sf: SimpleFeature): SimpleFeature = FeatureUtils.write(writer, sf, useProvidedFids)</span>
  }
<span class="nc" id="L88">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>