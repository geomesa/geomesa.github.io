<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SpatioTemporalFilterStrategy.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Index API</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.index.strategies</a> &gt; <span class="el_source">SpatioTemporalFilterStrategy.scala</span></div><h1>SpatioTemporalFilterStrategy.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.index.strategies

import org.geotools.api.filter.Filter
import org.geotools.util.factory.Hints
import org.locationtech.geomesa.filter._
import org.locationtech.geomesa.filter.visitor.FilterExtractingVisitor
import org.locationtech.geomesa.index.api.{FilterStrategy, GeoMesaFeatureIndex}

<span class="nc" id="L17">trait SpatioTemporalFilterStrategy[T, U] extends GeoMesaFeatureIndex[T, U] {</span>

  // attributes are assumed to be a geometry field and a date field
<span class="nc" id="L20">  lazy private val Seq(geom, dtg) = attributes</span>

  override def getFilterStrategy(filter: Filter, hints: Hints): Option[FilterStrategy] = {
<span class="nc bnc" id="L23" title="All 6 branches missed.">    if (filter == Filter.INCLUDE) {</span>
<span class="nc" id="L24">      Some(FilterStrategy(this, None, None, temporal = false, Float.PositiveInfinity, hints))</span>
    } else {
<span class="nc bnc" id="L26" title="All 2 branches missed.">      val (temporal, nonTemporal) = FilterExtractingVisitor(filter, dtg, sft)</span>
<span class="nc" id="L27">      val intervals = temporal.map(FilterHelper.extractIntervals(_, dtg)).getOrElse(FilterValues.empty)</span>

<span class="nc bnc" id="L29" title="All 4 branches missed.">      if (!intervals.disjoint &amp;&amp; !intervals.exists(_.isBounded)) {</span>
        // if there aren't any intervals then we would have to do a full table scan
<span class="nc" id="L31">        Some(FilterStrategy(this, None, Some(filter), temporal = false, Float.PositiveInfinity, hints))</span>
      } else {
<span class="nc bnc" id="L33" title="All 2 branches missed.">        val (spatial, others) = nonTemporal match {</span>
<span class="nc bnc" id="L34" title="All 2 branches missed.">          case Some(f) =&gt; FilterExtractingVisitor(f, geom, sft, SpatialFilterStrategy.spatialCheck)</span>
<span class="nc bnc" id="L35" title="All 2 branches missed.">          case None    =&gt; (None, None)</span>
        }
<span class="nc" id="L37">        val primary = andFilters(spatial.toSeq ++ temporal)</span>
        // TODO check date range and use z2 instead if too big
        // TODO also if very small bbox, z2 has ~10 more bits of lat/lon info
        // https://geomesa.atlassian.net/browse/GEOMESA-1166

        // de-prioritize non-spatial and one-sided date filters
<span class="nc bnc" id="L43" title="All 4 branches missed.">        val priority = if (spatial.isDefined &amp;&amp; intervals.forall(_.isBoundedBothSides)) { 1.1f } else { 3f }</span>
<span class="nc" id="L44">        Some(FilterStrategy(this, Some(primary), others, temporal = true, priority, hints))</span>
      }
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>