<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DelimitedExporter.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Feature Exporters</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.features.exporters</a> &gt; <span class="el_source">DelimitedExporter.scala</span></div><h1>DelimitedExporter.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.features.exporters

import com.typesafe.scalalogging.LazyLogging
import org.apache.commons.csv.{CSVFormat, CSVPrinter, QuoteMode}
import org.geotools.api.feature.simple.{SimpleFeature, SimpleFeatureType}
import org.locationtech.geomesa.utils.geotools.SimpleFeatureTypes
import org.locationtech.geomesa.utils.text.WKTUtils
import org.locationtech.jts.geom.Geometry

import java.io.{OutputStream, OutputStreamWriter}
import java.nio.charset.StandardCharsets
import java.time.{Instant, ZoneOffset}
import java.util.Date

<span class="nc bnc" id="L23" title="All 4 branches missed.">class DelimitedExporter(out: OutputStream, format: CSVFormat, withHeader: Boolean, includeIds: Boolean)</span>
<span class="nc" id="L24">    extends FeatureExporter with LazyLogging {</span>

  import org.locationtech.geomesa.utils.geotools.GeoToolsDateFormat

  import scala.collection.JavaConverters._

<span class="nc" id="L30">  private var printer: CSVPrinter = _</span>

  override def start(sft: SimpleFeatureType): Unit = {
<span class="nc" id="L33">    printer = format.print(new OutputStreamWriter(out, StandardCharsets.UTF_8))</span>
    // write out a header line
<span class="nc bnc" id="L35" title="All 2 branches missed.">    if (withHeader) {</span>
<span class="nc bnc" id="L36" title="All 2 branches missed.">      if (includeIds) {</span>
<span class="nc" id="L37">        printer.print(&quot;id&quot;)</span>
      }
<span class="nc" id="L39">      sft.getAttributeDescriptors.asScala.foreach { descriptor =&gt;</span>
<span class="nc" id="L40">        printer.print(SimpleFeatureTypes.encodeDescriptor(sft, descriptor))</span>
      }
<span class="nc" id="L42">      printer.println()</span>
<span class="nc" id="L43">      printer.flush()</span>
    }
  }

  override def export(features: Iterator[SimpleFeature]): Option[Long] = {
<span class="nc" id="L48">    var count = 0L</span>
<span class="nc" id="L49">    features.foreach { sf =&gt;</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">      if (includeIds) {</span>
<span class="nc" id="L51">        printer.print(sf.getID)</span>
      }
<span class="nc" id="L53">      var i = 0</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">      while (i &lt; sf.getAttributeCount) {</span>
<span class="nc" id="L55">        printer.print(stringify(sf.getAttribute(i)))</span>
<span class="nc" id="L56">        i += 1</span>
      }
<span class="nc" id="L58">      printer.println()</span>

<span class="nc" id="L60">      count += 1</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">      if (count % 10000 == 0) {</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">        logger.debug(s&quot;wrote $count features&quot;)</span>
      }
    }

<span class="nc" id="L66">    printer.flush()</span>

<span class="nc bnc" id="L68" title="All 2 branches missed.">    logger.debug(s&quot;Exported $count features&quot;)</span>
<span class="nc" id="L69">    Some(count)</span>
  }

<span class="nc bnc" id="L72" title="All 2 branches missed.">  override def close(): Unit =  if (printer != null) { printer.close() }</span>

<span class="nc" id="L74">  private def stringify(obj: Any): String = obj match {</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">    case null                   =&gt; &quot;&quot;</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">    case g: Geometry            =&gt; WKTUtils.write(g)</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">    case d: Date                =&gt; GeoToolsDateFormat.format(Instant.ofEpochMilli(d.getTime).atZone(ZoneOffset.UTC))</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">    case l: java.util.List[_]   =&gt; l.asScala.map(stringify).mkString(&quot;,&quot;)</span>
<span class="nc bnc" id="L79" title="All 4 branches missed.">    case m: java.util.Map[_, _] =&gt; m.asScala.map { case (k, v) =&gt; s&quot;${stringify(k)}-&gt;${stringify(v)}&quot;}.mkString(&quot;,&quot;)</span>
<span class="nc" id="L80">    case _                      =&gt; obj.toString</span>
  }
}

<span class="nc" id="L84">object DelimitedExporter {</span>

<span class="nc" id="L86">  def csv(out: OutputStream, withHeader: Boolean, includeIds: Boolean = true): DelimitedExporter =</span>
<span class="nc" id="L87">    new DelimitedExporter(out, CSVFormat.DEFAULT.withQuoteMode(QuoteMode.MINIMAL), withHeader, includeIds)</span>

<span class="nc" id="L89">  def tsv(out: OutputStream, withHeader: Boolean, includeIds: Boolean = true): DelimitedExporter =</span>
<span class="nc" id="L90">    new DelimitedExporter(out, CSVFormat.TDF.withQuoteMode(QuoteMode.MINIMAL), withHeader, includeIds)</span>
<span class="nc" id="L91">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>