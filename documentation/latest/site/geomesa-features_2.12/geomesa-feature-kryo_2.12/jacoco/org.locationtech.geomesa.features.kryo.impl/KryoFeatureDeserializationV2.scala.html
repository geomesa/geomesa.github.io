<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KryoFeatureDeserializationV2.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Features Kryo</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.features.kryo.impl</a> &gt; <span class="el_source">KryoFeatureDeserializationV2.scala</span></div><h1>KryoFeatureDeserializationV2.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.features.kryo
package impl

import com.esotericsoftware.kryo.io.Input
import com.typesafe.scalalogging.LazyLogging
import org.geotools.api.feature.`type`.AttributeDescriptor
import org.geotools.api.feature.simple.SimpleFeatureType
import org.locationtech.geomesa.features.kryo.KryoFeatureSerializer.NullByte
import org.locationtech.geomesa.features.kryo.json.KryoJsonSerialization
import org.locationtech.geomesa.features.kryo.serialization.KryoGeometrySerialization
import org.locationtech.geomesa.utils.cache.ThreadLocalCache
import org.locationtech.geomesa.utils.geotools.ObjectType
import org.locationtech.geomesa.utils.geotools.ObjectType.ObjectType

import java.util
import java.util.{Date, UUID}
import scala.util.control.NonFatal

/**
  * Version 2 serialization scheme consists of:
  *
  * &lt;ol&gt;
  *   &lt;li&gt;one byte containing the serialization version (2)&lt;/li&gt;
  *   &lt;li&gt;four byte int containing the offset to the per-attribute offsets&lt;/li&gt;
  *   &lt;li&gt;the feature id as a string (if `withId`)&lt;/li&gt;
  *   &lt;li&gt;the serialized attributes, in order, each prepended with a byte 0 or 1 to indicate null/not null&lt;/li&gt;
  *   &lt;li&gt;a variable length int (1-4 bytes) per attribute, for the offset to the start of the attribute in the serialized bytes&lt;/li&gt;
  *   &lt;li&gt;the serialized user data (if `withUserData`)&lt;/li&gt;
  * &lt;/ol&gt;
  */
<span class="nc bnc" id="L39" title="All 4 branches missed.">object KryoFeatureDeserializationV2 extends LazyLogging {</span>

<span class="nc" id="L41">  private val readers = new ThreadLocalCache[String, Array[Input =&gt; AnyRef]](SerializerCacheExpiry)</span>

  private [geomesa] def getReaders(key: String, sft: SimpleFeatureType): Array[Input =&gt; AnyRef] = {
<span class="nc" id="L44">    readers.getOrElseUpdate(key, sft.getAttributeDescriptors.toArray.map {</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">      case ad: AttributeDescriptor =&gt; matchReader(ObjectType.selectType(ad))</span>
    })
  }

  private [geomesa] def matchReader(bindings: Seq[ObjectType]): Input =&gt; AnyRef = {
<span class="nc" id="L50">    bindings.head match {</span>
<span class="nc bnc" id="L51" title="All 12 branches missed.">      case ObjectType.STRING   =&gt; if (bindings.last == ObjectType.JSON) KryoJsonSerialization.deserializeAndRender else StringReader</span>
<span class="nc bnc" id="L52" title="All 6 branches missed.">      case ObjectType.INT      =&gt; IntReader</span>
<span class="nc bnc" id="L53" title="All 6 branches missed.">      case ObjectType.LONG     =&gt; LongReader</span>
<span class="nc bnc" id="L54" title="All 6 branches missed.">      case ObjectType.FLOAT    =&gt; FloatReader</span>
<span class="nc bnc" id="L55" title="All 6 branches missed.">      case ObjectType.DOUBLE   =&gt; DoubleReader</span>
<span class="nc bnc" id="L56" title="All 6 branches missed.">      case ObjectType.DATE     =&gt; DateReader</span>
<span class="nc bnc" id="L57" title="All 6 branches missed.">      case ObjectType.UUID     =&gt; UuidReader</span>
<span class="nc bnc" id="L58" title="All 6 branches missed.">      case ObjectType.GEOMETRY =&gt; KryoGeometrySerialization.deserialize</span>
<span class="nc bnc" id="L59" title="All 6 branches missed.">      case ObjectType.BYTES    =&gt; BytesReader</span>
<span class="nc bnc" id="L60" title="All 6 branches missed.">      case ObjectType.BOOLEAN  =&gt; BooleanReader</span>
<span class="nc bnc" id="L61" title="All 6 branches missed.">      case ObjectType.LIST     =&gt; new ListReader(matchReader(bindings.drop(1)))</span>
<span class="nc bnc" id="L62" title="All 6 branches missed.">      case ObjectType.MAP      =&gt; new MapReader(matchReader(bindings.slice(1, 2)), matchReader(bindings.drop(2)))</span>
    }
  }

<span class="nc" id="L66">  object StringReader extends (Input =&gt; String) {</span>
<span class="nc" id="L67">    override def apply(input: Input): String = try { input.readString() } catch {</span>
<span class="nc bnc" id="L68" title="All 4 branches missed.">      case NonFatal(e) =&gt; logger.error(&quot;Error reading serialized kryo bytes:&quot;, e); null</span>
    }
  }

<span class="nc" id="L72">  object IntReader extends (Input =&gt; Integer) {</span>
<span class="nc" id="L73">    override def apply(input: Input): Integer = try {</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">      if (input.read() == NullByte) { null } else { input.readInt() }</span>
    } catch {
<span class="nc bnc" id="L76" title="All 4 branches missed.">      case NonFatal(e) =&gt; logger.error(&quot;Error reading serialized kryo bytes:&quot;, e); null</span>
    }
  }

<span class="nc" id="L80">  object LongReader extends (Input =&gt; java.lang.Long) {</span>
<span class="nc" id="L81">    override def apply(input: Input): java.lang.Long = try {</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">      if (input.read() == NullByte) { null } else { input.readLong() }</span>
    } catch {
<span class="nc bnc" id="L84" title="All 4 branches missed.">      case NonFatal(e) =&gt; logger.error(&quot;Error reading serialized kryo bytes:&quot;, e); null</span>
    }
  }

<span class="nc" id="L88">  object FloatReader extends (Input =&gt; java.lang.Float) {</span>
<span class="nc" id="L89">    override def apply(input: Input): java.lang.Float = try {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">      if (input.read() == NullByte) { null } else { input.readFloat() }</span>
    } catch {
<span class="nc bnc" id="L92" title="All 4 branches missed.">      case NonFatal(e) =&gt; logger.error(&quot;Error reading serialized kryo bytes:&quot;, e); null</span>
    }
  }

<span class="nc" id="L96">  object DoubleReader extends (Input =&gt; java.lang.Double) {</span>
<span class="nc" id="L97">    override def apply(input: Input): java.lang.Double = try {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">      if (input.read() == NullByte) { null } else { input.readDouble() }</span>
    } catch {
<span class="nc bnc" id="L100" title="All 4 branches missed.">      case NonFatal(e) =&gt; logger.error(&quot;Error reading serialized kryo bytes:&quot;, e); null</span>
    }
  }

<span class="nc" id="L104">  object BooleanReader extends (Input =&gt; java.lang.Boolean) {</span>
<span class="nc" id="L105">    override def apply(input: Input): java.lang.Boolean = try {</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">      if (input.read() == NullByte) { null } else { input.readBoolean() }</span>
    } catch {
<span class="nc bnc" id="L108" title="All 4 branches missed.">      case NonFatal(e) =&gt; logger.error(&quot;Error reading serialized kryo bytes:&quot;, e); null</span>
    }
  }

<span class="nc" id="L112">  object DateReader extends (Input =&gt; Date) {</span>
<span class="nc" id="L113">    override def apply(input: Input): Date = try {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">      if (input.read() == NullByte) { null } else { new Date(input.readLong()) }</span>
    } catch {
<span class="nc bnc" id="L116" title="All 4 branches missed.">      case NonFatal(e) =&gt; logger.error(&quot;Error reading serialized kryo bytes&quot;, e); null</span>
    }
  }

<span class="nc" id="L120">  object UuidReader extends (Input =&gt; UUID) {</span>
<span class="nc" id="L121">    override def apply(input: Input): UUID = try {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">      if (input.read() == NullByte) { null } else { new UUID(input.readLong(), input.readLong()) }</span>
    } catch {
<span class="nc bnc" id="L124" title="All 4 branches missed.">      case NonFatal(e) =&gt; logger.error(&quot;Error reading serialized kryo bytes:&quot;, e); null</span>
    }
  }

<span class="nc" id="L128">  object BytesReader extends (Input =&gt; Array[Byte]) {</span>
<span class="nc" id="L129">    override def apply(input: Input): Array[Byte] = try {</span>
<span class="nc" id="L130">      val size = input.readInt(true)</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">      if (size == -1) { null } else {</span>
<span class="nc" id="L132">        val array = new Array[Byte](size)</span>
<span class="nc" id="L133">        input.read(array)</span>
<span class="nc" id="L134">        array</span>
      }
    } catch {
<span class="nc bnc" id="L137" title="All 4 branches missed.">      case NonFatal(e) =&gt; logger.error(&quot;Error reading serialized kryo bytes:&quot;, e); null</span>
    }
  }

<span class="nc" id="L141">  class ListReader(valueReader: Input =&gt; AnyRef) extends (Input =&gt; java.util.List[AnyRef]) {</span>
<span class="nc" id="L142">    override def apply(input: Input): util.List[AnyRef] = try {</span>
<span class="nc" id="L143">      val size = input.readInt(true)</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">      if (size == -1) { null } else {</span>
<span class="nc" id="L145">        val list = new java.util.ArrayList[AnyRef](size)</span>
<span class="nc" id="L146">        var index = 0</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        while (index &lt; size) {</span>
<span class="nc" id="L148">          list.add(valueReader.apply(input))</span>
<span class="nc" id="L149">          index += 1</span>
        }
<span class="nc" id="L151">        list</span>
      }
    } catch {
<span class="nc bnc" id="L154" title="All 4 branches missed.">      case NonFatal(e) =&gt; logger.error(&quot;Error reading serialized kryo bytes:&quot;, e); null</span>
    }
  }

<span class="nc" id="L158">  class MapReader(keyReader: Input =&gt; AnyRef, valueReader: Input =&gt; AnyRef)</span>
<span class="nc" id="L159">      extends (Input =&gt; java.util.Map[AnyRef, AnyRef]) {</span>
<span class="nc" id="L160">    override def apply(input: Input): util.Map[AnyRef, AnyRef] = try {</span>
<span class="nc" id="L161">      val size = input.readInt(true)</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">      if (size == -1) { null } else {</span>
<span class="nc" id="L163">        val map = new java.util.HashMap[AnyRef, AnyRef](size)</span>
<span class="nc" id="L164">        var index = 0</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        while (index &lt; size) {</span>
<span class="nc" id="L166">          map.put(keyReader.apply(input), valueReader.apply(input))</span>
<span class="nc" id="L167">          index += 1</span>
        }
<span class="nc" id="L169">        map</span>
      }
    } catch {
<span class="nc bnc" id="L172" title="All 4 branches missed.">      case NonFatal(e) =&gt; logger.error(&quot;Error reading serialized kryo bytes:&quot;, e); null</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>