<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>package.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GeoMesa Features Kryo</a> &gt; <a href="index.source.html" class="el_package">org.locationtech.geomesa.features.kryo</a> &gt; <span class="el_source">package.scala</span></div><h1>package.scala</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2013-2025 General Atomics Integrated Intelligence, Inc.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License, Version 2.0
 * which accompanies this distribution and is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 ***********************************************************************/

package org.locationtech.geomesa.features

import com.esotericsoftware.kryo.io.{Input, Output}
import org.locationtech.geomesa.features.kryo.impl.IntBitSet
import org.locationtech.geomesa.utils.conf.GeoMesaSystemProperties.SystemProperty

import scala.concurrent.duration.Duration

<span class="nc" id="L17">package object kryo {</span>

<span class="nc" id="L19">  val SerializerCacheExpiry: Duration = SystemProperty(&quot;geomesa.serializer.cache.expiry&quot;, &quot;1 hour&quot;).toDuration.get</span>

  /**
    * Metadata for serialized simple features
    *
    * @param input kryo input
    * @param count number of attributes serialized in this feature (may be less than the current sft)
    * @param size size of each offset - either 2 or 4 bytes
    * @param offset attribute positions are stored relative to this offset into the serialized bytes
    * @param nulls null bit set
    */
<span class="nc bnc" id="L30" title="All 34 branches missed.">  case class Metadata(input: Input, count: Int, size: Int, offset: Int, nulls: IntBitSet) {</span>

    /**
      * Position the input to read an attribute
      *
      * @param i attribute to read
      * @return the relative position being set
      */
    def setPosition(i: Int): Int = {
<span class="nc" id="L39">      input.setPosition(offset + i * size)</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">      val pos = if (size == 2) { input.readShortUnsigned() } else { input.readInt() }</span>
<span class="nc" id="L41">      input.setPosition(offset + pos)</span>
<span class="nc" id="L42">      pos</span>
    }

    /**
      * Position the input to read the feature ID
      *
      * @return the relative position being set
      */
    def setIdPosition(): Int = {
<span class="nc" id="L51">      val pos = size * (count + 1) + (IntBitSet.size(count) * 4)</span>
<span class="nc" id="L52">      input.setPosition(offset + pos)</span>
<span class="nc" id="L53">      pos</span>
    }

    /**
      * Position the input to read the user data
      *
      * @return the relative position being set
      */
<span class="nc" id="L61">    def setUserDataPosition(): Int = setPosition(count)</span>
  }

<span class="nc" id="L64">  object Metadata {</span>

    /**
      * Read the metadata from a kryo input. The input should be positioned at the start of the serialized
      * simple feature, just after reading the 'version' byte
      *
      * @param input input
      * @return
      */
    def apply(input: Input): Metadata = {
<span class="nc" id="L74">      val count = input.readShortUnsigned()</span>
<span class="nc" id="L75">      val size = input.readByte()</span>
<span class="nc" id="L76">      val offset = input.position()</span>
      // read our null mask
<span class="nc" id="L78">      input.setPosition(offset + size * (count + 1))</span>
<span class="nc" id="L79">      val nulls = IntBitSet.deserialize(input, count)</span>
<span class="nc" id="L80">      Metadata(input, count, size, offset, nulls)</span>
    }

    /**
      * Write metadata to the output. After this call, the output will be positioned to write the feature ID
      *
      * @param output output
      * @param count number of serialized attributes
      * @param size size of each offset (2 or 4 bytes)
      * @return the relative offset used to track attribute offsets
      */
    def write(output: Output, count: Int, size: Int): Int = {
<span class="nc" id="L92">      output.writeShort(count) // track the number of attributes</span>
<span class="nc" id="L93">      output.write(size) // size of each offset</span>
<span class="nc" id="L94">      val offset = output.position()</span>
<span class="nc" id="L95">      val position = offset + (size * (count + 1)) + (IntBitSet.size(count) * 4)</span>
      // setting the position to greater than the buffer size results in errors when trying to write some values later on
<span class="nc bnc" id="L97" title="All 2 branches missed.">      if (output.getBuffer.length &lt; position) {</span>
<span class="nc" id="L98">        val buf = Array.ofDim[Byte](position * 2)</span>
<span class="nc" id="L99">        System.arraycopy(output.getBuffer, 0, buf, 0, offset)</span>
<span class="nc" id="L100">        output.setBuffer(buf, -1)</span>
      }
<span class="nc" id="L102">      output.setPosition(position)</span>
<span class="nc" id="L103">      offset</span>
    }
  }
<span class="nc" id="L106">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>